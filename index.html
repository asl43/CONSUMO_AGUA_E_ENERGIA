<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Consumo - √Ågua e Energia</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  /* --- VARI√ÅVEIS E RESET B√ÅSICO --- */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  :root {
    --primary: #667eea;
    --secondary: #764ba2;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg-light: #ffffff;
    --bg-dark: #1a1a2e;
    --text-light: #333333;
    --text-dark: #ffffff;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    min-height: 100vh;
    padding: 20px;
    position: relative;
    overflow-x: hidden;
    transition: all 0.3s;
    color: var(--text-light);
    overflow-y: auto;
  }
  body.dark-mode {
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
    color: var(--text-dark);
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
    opacity: 0;
    transition: opacity 0.5s;
  }
  .container.active {
    opacity: 1;
    display: block;
  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
  }
  h1 {
    color: white;
    font-size: clamp(24px, 5vw, 36px);
    font-weight: 700;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    animation: slideDown 0.6s ease-out;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .theme-toggle, .back-to-menu {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s;
  }
  .theme-toggle:hover, .back-to-menu:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
  }
  #mainMenu {
    width: 100%;
    height: 100dvh;
    padding: 50px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
    background: inherit;
    transition: opacity 0.5s;
    overflow-y: auto;
    position: relative;
  }
  #mainMenu h1 {
    margin-bottom: 40px;
    font-size: clamp(32px, 7vw, 48px);
    text-align: center;
  }
  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 25px;
    max-width: 1000px;
    width: 100%;
    padding: 20px;
  }
  .menu-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 30px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 700;
    text-align: center;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    text-transform: uppercase;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 150px;
  }
  .menu-card:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
    border-color: white;
  }
  .menu-card .material-icons {
    font-size: 36px;
    margin-bottom: 10px;
    color: var(--success);
  }
  .menu-card[data-tab="registro"] .material-icons { color: #f59e0b; }
  .menu-card[data-tab="dashboard"] .material-icons { color: #10b981; }
  .menu-card[data-tab="historico"] .material-icons { color: #3b82f6; }
  .menu-card[data-tab="metas"] .material-icons { color: #ef4444; }
  .menu-card[data-tab="comparacao"] .material-icons { color: #764ba2; }
  .menu-card[data-tab="custo"] .material-icons { color: #f97316; }

  /* --- RESTANTE DO CSS (sem altera√ß√µes) --- */
  .main-tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 30px;
    animation: fadeIn 0.8s ease-out 0.2s both;
    flex-wrap: wrap;
  }
  .tab-button {
    flex: 1;
    min-width: 120px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.2);
    padding: 16px 20px;
    border-radius: 16px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-transform: uppercase;
  }
  .tab-button:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }
  .tab-button.active {
    background: white;
    color: var(--primary);
    border-color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  .main-content {
    display: none;
  }
  .main-content.active {
    display: grid;
    gap: 20px;
    animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes scaleIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }
  .form-card {
    background: white;
    padding: 30px;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  body.dark-mode .form-card {
    background: #16213e;
    color: var(--text-dark);
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  .stat-card {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 20px;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
  }
  .stat-card .label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 8px;
  }
  .stat-card .value {
    font-size: 28px;
    font-weight: 700;
  }
  .stat-card.warning {
    background: linear-gradient(135deg, var(--warning) 0%, #f97316 100%);
  }
  .stat-card.success {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
  }
  .stat-card.danger {
    background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
  }
  .chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
    background: white;
    padding: 20px;
    border-radius: 16px;
  }
  body.dark-mode .chart-container {
    background: #0f3460;
  }
  .form-group {
    margin-bottom: 20px;
  }
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
  }
  body.dark-mode label {
    color: var(--text-dark);
  }
  input, select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s;
    background: #f8f9fa;
  }
  body.dark-mode input,
  body.dark-mode select {
    background: #0f3460;
    border-color: #1a1a2e;
    color: white;
  }
  input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    background: white;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  }
  body.dark-mode input:focus,
  body.dark-mode select:focus {
    background: #16213e;
  }
  input:read-only {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    cursor: not-allowed;
    font-weight: 600;
    color: var(--primary);
  }
  input.previous-reading {
    background: #e0f2f1;
    color: var(--success);
    font-weight: 700;
  }
  body.dark-mode input.previous-reading {
    background: #004d40;
    color: #80cbc4;
  }
  .button-group {
    display: grid;
    gap: 12px;
    margin-top: 24px;
  }
  button, .btn {
    padding: 16px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
  }
  .btn-secondary {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
  }
  body.dark-mode .btn-secondary {
    background: #0f3460;
    color: white;
  }
  .btn-secondary:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
  }
  .mensagem {
    text-align: center;
    font-weight: 600;
    margin-top: 16px;
    padding: 12px;
    border-radius: 8px;
    animation: fadeIn 0.3s;
  }
  .mensagem.success {
    background: #d4edda;
    color: #155724;
  }
  .mensagem.error {
    background: #f8d7da;
    color: #721c24;
  }
  .history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  .history-table th,
  .history-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
  }
  .history-table tbody tr:nth-child(even) {
    background-color: #f0f4ff; 
  }
  body.dark-mode .history-table tbody tr:nth-child(even) {
    background-color: #1a1a2e;
  }
  .history-table td:nth-child(4), 
  .history-table td:nth-child(5) {
    text-align: right;
    font-weight: 600;
  }
  body.dark-mode .history-table th,
  body.dark-mode .history-table td {
    border-color: #1a1a2e;
  }
  .history-table th {
    background: #f8f9fa;
    font-weight: 600;
  }
  body.dark-mode .history-table th {
    background: #0f3460;
  }
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 1000;
    animation: slideInRight 0.3s;
    max-width: 300px;
    border-left: 4px solid;
  }
  .notification.success {
    border-color: var(--success);
  }
  .notification.warning {
    border-color: var(--warning);
  }
  .notification.error {
    border-color: var(--danger);
  }
  @keyframes slideInRight {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  .goal-progress {
    margin: 20px 0;
  }
  .progress-bar {
    width: 100%;
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success) 0%, #059669 100%);
    transition: width 0.5s;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
    white-space: nowrap; 
    padding: 0 10px;
  }
  .progress-fill.over {
    background: linear-gradient(90deg, var(--danger) 0%, #dc2626 100%);
  }
  .comparison-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  .comparison-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
  }
  body.dark-mode .comparison-card {
    background: #0f3460;
  }
  .comparison-card .icon {
    font-size: 40px;
    margin-bottom: 10px;
  }
  .comparison-card .value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
  }
  body.dark-mode .comparison-card .value {
    color: #64b5f6;
  }
  .export-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 10px;
  }
  .action-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
    align-items: center; 
  }
  .btn-icon {
    padding: 6px 10px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1; 
  }
  .btn-edit { background: #3b82f6; color: white; }
  .btn-edit:hover { background: #2563eb; transform: scale(1.05); }
  .btn-delete { background: #ef4444; color: white; }
  .btn-delete:hover { background: #dc2626; transform: scale(1.05); }
  .modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s;
  }
  .modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    animation: scaleIn 0.3s;
  }
  body.dark-mode .modal-content {
    background: #16213e;
    color: var(--text-dark);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e0e0e0;
  }
  body.dark-mode .modal-header {
    border-color: #1a1a2e;
  }
  .modal-header h2 {
    margin: 0;
    font-size: 24px;
  }
  .btn-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #999;
    transition: all 0.2s;
    padding: 0;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }
  .btn-close:hover {
    background: #f0f0f0;
    color: #333;
  }
  body.dark-mode .btn-close:hover {
    background: #0f3460;
    color: white;
  }
  .filter-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
  }
  body.dark-mode .filter-section {
    background: #0f3460;
  }
  .filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }
  .dashboard-filters {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto; 
    gap: 15px;
    margin-bottom: 20px;
    align-items: end;
  }
  .result-card {
    background: #fff8e1;
    padding: 15px;
    border-radius: 12px;
    text-align: left;
    margin-top: 15px;
    border: 1px solid #ffcc80;
  }
  .result-card p {
    margin-bottom: 5px;
    font-size: 0.95em;
  }
  .result-card strong {
    font-weight: 700;
  }
  .result-card .total-cost {
    font-size: 1.4em; 
    font-weight: 700; 
    color: var(--danger);
    display: block;
    border-top: 1px dashed #ccc; 
    padding-top: 5px; 
    margin-top: 10px;
  }
  @media (max-width: 768px) {
    body {
      padding: 12px;
    }
    .form-card {
      padding: 20px;
    }
    .menu-grid {
      grid-template-columns: 1fr;
      padding: 0;
    }
    .main-tabs {
      gap: 8px;
    }
    .tab-button {
      padding: 12px;
      font-size: 14px;
      min-width: 100px;
    }
    .stats-grid {
      grid-template-columns: 1fr;
    }
    .chart-container {
      height: 250px;
    }
    .dashboard-filters {
        grid-template-columns: 1fr;
    }
    .filter-row {
        grid-template-columns: 1fr;
    }
  }
  .loading {
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .spreadsheet-link {
    margin-bottom: 20px;
    padding: 12px;
    background-color: #e0f2f1;
    border: 1px solid #009688;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    color: #00796b;
    transition: background-color 0.3s;
  }
  .spreadsheet-link a {
    color: var(--primary);
    text-decoration: none;
  }
  .spreadsheet-link:hover {
    background-color: #b2dfdb;
  }
  body.dark-mode .spreadsheet-link {
    background-color: #0f3460;
    border-color: #2196f3;
    color: #81d4fa;
  }
  body.dark-mode .spreadsheet-link a {
    color: #64b5f6;
  }
  .spreadsheet-link .warning {
    font-size: 0.8em; 
    color: var(--danger); 
    margin-top: 5px;
    font-weight: normal;
  }
</style>
</head>
<body>
<div id="mainMenu">
  <h1>üíß‚ö° REGISTRO DE CONSUMO</h1>
  <div class="menu-grid">
    <div class="menu-card" data-tab="registro" onclick="showMainTab('registro')">
      <span class="material-icons">edit_note</span>
      REGISTRO
    </div>
    <div class="menu-card" data-tab="dashboard" onclick="showMainTab('dashboard')">
      <span class="material-icons">analytics</span>
      DASHBOARD
    </div>
    <div class="menu-card" data-tab="historico" onclick="showMainTab('historico')">
      <span class="material-icons">history</span>
      HIST√ìRICO
    </div>
    <div class="menu-card" data-tab="metas" onclick="showMainTab('metas')">
      <span class="material-icons">track_changes</span>
      METAS
    </div>
    <div class="menu-card" data-tab="comparacao" onclick="showMainTab('comparacao')">
      <span class="material-icons">people_outline</span>
      COMPARA√á√ÉO
    </div>
    <div class="menu-card" data-tab="custo" onclick="showMainTab('custo')">
      <span class="material-icons">attach_money</span>
      CUSTOS E TARIFAS
    </div>
  </div>
</div>
<div class="container" id="mainContainer">
  <div class="header">
    <h1 id="appTitle">üíß‚ö° Registro de Consumo</h1>
    <div style="display: flex; gap: 10px;">
        <button class="back-to-menu" onclick="showMenu()">
          <span class="material-icons" style="font-size: 20px;">menu</span>
        </button>
        <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
    </div>
  </div>
  <div class="main-tabs">
    <button class="tab-button" onclick="showMainTab('registro')">
      <span>üìù REGISTRO</span>
    </button>
    <button class="tab-button" onclick="showMainTab('dashboard')">
      <span>üìä DASHBOARD</span>
    </button>
    <button class="tab-button" onclick="showMainTab('historico')">
      <span>üìã HIST√ìRICO</span>
    </button>
    <button class="tab-button" onclick="showMainTab('metas')">
      <span>üéØ METAS</span>
    </button>
    <button class="tab-button" onclick="showMainTab('comparacao')">
      <span>üë• COMPARA√á√ÉO</span>
    </button>
    <button class="tab-button" onclick="showMainTab('custo')">
      <span>üí∞ CUSTOS E TARIFAS</span>
    </button>
  </div>
  <div id="registro" class="main-content">
    <div class="spreadsheet-link">
        <p>Acesse a planilha de dados:</p>
        <a href="#" id="spreadsheetLinkAnchor" target="_blank" class="btn-secondary" style="display: inline-block; width: auto;">
            Abrir Planilha (Google Sheets)
        </a>
        <p class="warning">
          ‚ö†Ô∏è **Aviso:** Edi√ß√µes ou exclus√µes de registros devem ser feitas manualmente na planilha.
        </p>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Total √Ågua</div>
        <div class="value" id="displayTotalAgua">0.00 m¬≥</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Energia</div>
        <div class="value" id="displayTotalEnergia">0.00 kWh</div>
      </div>
    </div>
    <div class="form-card">
      <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
        <button class="tab-button active" style="flex: 1; min-width: 150px;" onclick="showFormTab('agua', this)">
          üíß √ÅGUA
        </button>
        <button class="tab-button" style="flex: 1; min-width: 150px;" onclick="showFormTab('energia', this)">
          ‚ö° ENERGIA
        </button>
      </div>
      <div id="formAgua" class="form-content">
        <form id="aguaForm">
          <div class="form-group">
            <label>Nome</label>
            <input type="text" name="nome" required placeholder="Digite seu nome">
          </div>
          <div class="form-group">
            <label>Matr√≠cula</label>
            <input type="text" name="matricula" required placeholder="Digite sua matr√≠cula">
          </div>
          <div class="form-group">
            <label>Data e Hora</label>
            <input type="datetime-local" name="dataHora" required>
          </div>
          <div class="form-group">
            <label>Leitura Anterior Acumulada (m¬≥)</label>
            <input type="number" id="leituraAnteriorAguaDisplay" step="0.01" readonly class="previous-reading">
          </div>
          <div class="form-group">
            <label>Leitura Atual do Medidor (m¬≥)</label>
            <input type="number" name="leituraAtualAgua" id="leituraAtualAgua" step="0.01" required placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Consumo Calculado (m¬≥)</label>
            <input type="number" name="consumoAgua" id="consumoAgua" step="0.01" readonly placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Novo Total (m¬≥)</label>
            <input type="number" name="totalAgua" id="totalAgua" step="0.01" readonly>
          </div>
          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="abrirModalRedefinir('agua')">
              üîÑ Redefinir Total Inicial (In√≠cio da Contagem)
            </button>
          </div>
          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px dashed #e0e0e0;">
            <h3 style="margin-bottom: 16px;">üìù Campos Adicionais (Opcional)</h3>
            <div class="form-group">
              <label>Campo Extra 1</label>
              <input type="text" name="extra1" placeholder="Opcional">
            </div>
            <div class="form-group">
              <label>Campo Extra 2</label>
              <input type="text" name="extra2" placeholder="Opcional">
            </div>
            <div class="form-group">
              <label>Campo Extra 3</label>
              <input type="text" name="extra3" placeholder="Opcional">
            </div>
          </div>
          <div class="button-group">
            <button type="submit" class="btn btn-primary">‚úÖ Enviar REGISTRO DE √ÅGUA</button>
          </div>
          <p class="mensagem" id="msgAgua"></p>
        </form>
      </div>
      <div id="formEnergia" class="form-content" style="display: none;">
        <form id="energiaForm">
          <div class="form-group">
            <label>Nome</label>
            <input type="text" name="nome" required placeholder="Digite seu nome">
          </div>
          <div class="form-group">
            <label>Matr√≠cula</label>
            <input type="text" name="matricula" required placeholder="Digite sua matr√≠cula">
          </div>
          <div class="form-group">
            <label>Data e Hora</label>
            <input type="datetime-local" name="dataHora" required>
          </div>
          <div class="form-group">
            <label>Leitura Anterior Acumulada (kWh)</label>
            <input type="number" id="leituraAnteriorEnergiaDisplay" step="0.01" readonly class="previous-reading">
          </div>
          <div class="form-group">
            <label>Leitura Atual do Medidor (kWh)</label>
            <input type="number" name="leituraAtualEnergia" id="leituraAtualEnergia" step="0.01" required placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Consumo Calculado (kWh)</label>
            <input type="number" name="consumoEnergia" id="consumoEnergia" step="0.01" readonly placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Novo Total (kWh)</label>
            <input type="number" name="totalEnergia" id="totalEnergia" step="0.01" readonly>
          </div>
          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="abrirModalRedefinir('energia')">
              üîÑ Redefinir Total Inicial (In√≠cio da Contagem)
            </button>
          </div>
          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px dashed #e0e0e0;">
            <h3 style="margin-bottom: 16px;">üìù Campos Adicionais (Opcional)</h3>
            <div class="form-group">
              <label>Campo Extra 1</label>
              <input type="text" name="extra1" placeholder="Opcional">
            </div>
            <div class="form-group">
              <label>Campo Extra 2</label>
              <input type="text" name="extra2" placeholder="Opcional">
            </div>
            <div class="form-group">
              <label>Campo Extra 3</label>
              <input type="text" name="extra3" placeholder="Opcional">
            </div>
          </div>
          <div class="button-group">
            <button type="submit" class="btn btn-primary">‚úÖ Enviar REGISTRO DE ENERGIA</button>
          </div>
          <p class="mensagem" id="msgEnergia"></p>
        </form>
      </div>
    </div>
  </div>
  <div id="dashboard" class="main-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Consumo √Ågua (Per√≠odo)</div>
        <div class="value" id="aguaMes">0.00 m¬≥</div>
      </div>
      <div class="stat-card">
        <div class="label">Consumo Energia (Per√≠odo)</div>
        <div class="value" id="energiaMes">0.00 kWh</div>
      </div>
      <div class="stat-card success" id="cardEconomiaAgua">
        <div class="label">Meta √Ågua (Economia)</div>
        <div class="value" id="economiaAgua">0%</div>
      </div>
      <div class="stat-card warning">
        <div class="label">Custo Estimado (Per√≠odo)</div>
        <div class="value" id="custoTotal">R$ 0,00</div>
      </div>
    </div>
    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üìà Gr√°fico de Consumo por Per√≠odo</h2>
      <div class="dashboard-filters">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="dataInicio">Data In√≠cio</label>
            <input type="date" id="dataInicio">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="dataFim">Data Fim</label>
            <input type="date" id="dataFim">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="agregacao">Agrega√ß√£o</label>
            <select id="agregacao">
                <option value="diario">Di√°rio</option>
                <option value="semanal">Semanal</option>
                <option value="mensal">Mensal</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="aplicarFiltroDashboard()" style="padding: 14px; margin-top: 5px;">
            Aplicar Filtro
        </button>
      </div>
      <div class="chart-container">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>
    <div class="form-card" style="margin-top: 20px;">
      <h2 style="margin-bottom: 20px;">üìä Distribui√ß√£o por Tipo (Total Acumulado)</h2>
      <div class="chart-container" style="height: 250px;">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>
  <div id="historico" class="main-content">
    <div class="form-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2>üìã HIST√ìRICO DE REGISTROS (Sincronizado Google Sheets)</h2>
      </div>
      <div class="filter-section" style="margin-top: 5px;">
          <h3>üîé Filtro de Visualiza√ß√£o</h3>
          <div class="filter-row">
              <div class="form-group" style="margin-bottom: 0;">
                  <label for="filtroPeriodo">Filtrar por Per√≠odo</label>
                  <select id="filtroPeriodo" onchange="aplicarFiltrosHistorico()">
                      <option value="todos">Todos os Registros</option>
                      <option value="hoje">Dia Atual</option>
                      <option value="7dias">√öltimos 7 Dias</option>
                      <option value="30dias">√öltimos 30 Dias</option>
                      <option value="custom">Personalizado (Datas abaixo)</option>
                  </select>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                  <label for="filtroDataInicio">Data In√≠cio (Personalizado)</label>
                  <input type="date" id="filtroDataInicio" onchange="aplicarFiltrosHistorico()">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                  <label for="filtroDataFim">Data Fim (Personalizado)</label>
                  <input type="date" id="filtroDataFim" onchange="aplicarFiltrosHistorico()">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                  <label for="filtroTipo">Filtrar por Tipo</label>
                  <select id="filtroTipo" onchange="aplicarFiltrosHistorico()">
                      <option value="todos">Todos</option>
                      <option value="agua">√Ågua</option>
                      <option value="energia">Energia</option>
                  </select>
              </div>
          </div>
          <div class="button-group" style="margin-top: 15px;">
              <button class="btn btn-secondary" onclick="aplicarFiltrosHistorico()">
                  ‚úÖ Aplicar Filtros
              </button>
          </div>
      </div>
      <div class="filter-section" style="margin-top: 20px;">
          <h3>üí∞ C√°lculo de Custo Detalhado por Per√≠odo</h3>
          <div class="filter-row">
              <div class="form-group" style="margin-bottom: 0;">
                  <label for="filtroCustoDataInicio">Data In√≠cio (Consumo)</label>
                  <input type="date" id="filtroCustoDataInicio" required>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                  <label for="filtroCustoDataFim">Data Fim (Consumo)</label>
                  <input type="date" id="filtroCustoDataFim" required>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                  <label for="filtroCustoTipo">Tipo de Consumo</label>
                  <select id="filtroCustoTipo" required>
                      <option value="total">üíß‚ö° √Ågua e Energia (Total)</option>
                      <option value="agua">üíß √Ågua</option>
                      <option value="energia">‚ö° Energia</option>
                  </select>
              </div>
          </div>
          <div class="button-group" style="margin-top: 15px;">
              <button class="btn btn-primary" onclick="calcularCustoPorPeriodo()">
                  üí≤ Calcular Custo para o Per√≠odo
              </button>
          </div>
          <div class="result-card" id="resCustoDetalhe">
              <p>Selecione um per√≠odo e tipo de consumo acima e clique em **Calcular Custo**.</p>
          </div>
      </div>
      <div class="export-buttons">
          <button class="btn btn-success" onclick="exportarCSV()">üì• Exportar CSV</button>
          <button class="btn btn-danger" onclick="exportarPDF()">üìÑ Exportar PDF</button>
      </div>
      <div style="margin-top: 10px;">
        <button class="btn btn-danger" onclick="limparTodosRegistros()" style="width: 100%;">
            üóëÔ∏è Limpar Todos os Registros Locais (N√£o afeta a Planilha)
        </button>
      </div>
      <div class="filter-section" style="margin-top: 20px;">
        <h3>üíæ Backup & Restaura√ß√£o Local</h3>
        <p style="font-size: 0.9em; margin-bottom: 10px;">Salve ou restaure o hist√≥rico local (JSON) para evitar perda de dados no navegador.</p>
        <div class="export-buttons">
            <button class="btn btn-secondary" onclick="exportarJSON()">üì• Backup JSON Local</button>
            <input type="file" id="importJsonFile" accept=".json" style="display: none;" onchange="importarJSON(event)">
            <button class="btn btn-secondary" onclick="document.getElementById('importJsonFile').click()">üì§ Restaurar JSON Local</button>
        </div>
      </div>
      <div style="overflow-x: auto;">
        <span id="loadingHistorico" style="display: none; text-align: center; display: block; padding: 10px; font-weight: 600;">
          <span class="material-icons loading">sync</span> Carregando hist√≥rico da Planilha...
        </span>
        <table class="history-table">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Tipo</th>
              <th>Nome</th>
              <th style="text-align: right;">Consumo</th>
              <th style="text-align: right;">Total</th>
              <th style="text-align: center;">A√ß√µes</th> </tr>
          </thead>
          <tbody id="historicoBody">
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px;">Nenhum registro encontrado</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="metas" class="main-content">
    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üéØ DEFINIR METAS DE CONSUMO</h2>
      <div class="form-group">
        <label>Meta de √Ågua Mensal (m¬≥)</label>
        <input type="number" id="metaAgua" step="0.01" placeholder="Ex: 10.00" onchange="salvarMetas()">
      </div>
      <div class="form-group">
        <label>Meta de Energia Mensal (kWh)</label>
        <input type="number" id="metaEnergia" step="0.01" placeholder="Ex: 150.00" onchange="salvarMetas()">
      </div>
      <div class="goal-progress">
        <h3 style="margin-bottom: 10px;">Progresso - √Ågua (Consumo Recente - 30 Dias)</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressAgua" style="width: 0%;">0% (0.00 / 0.00 m¬≥)</div>
        </div>
      </div>
      <div class="goal-progress">
        <h3 style="margin-bottom: 10px;">Progresso - Energia (Consumo Recente - 30 Dias)</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressEnergia" style="width: 0%;">0% (0.00 / 0.00 kWh)</div>
        </div>
      </div>
    </div>
  </div>
  <div id="comparacao" class="main-content">
    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üë• COMPARA√á√ÉO COM M√âDIA (SIMULADA)</h2>
      <div class="comparison-section">
        <div class="comparison-card">
          <div class="icon">üíß</div>
          <div class="label">Seu Consumo (√öltimos 30 Dias)</div>
          <div class="value" id="compSeuAgua">0.00 m¬≥</div>
        </div>
        <div class="comparison-card">
          <div class="icon">üìä</div>
          <div class="label">M√©dia Geral (Simulada)</div>
          <div class="value" id="compMediaAgua">0.00 m¬≥</div>
        </div>
        <div class="comparison-card">
          <div class="icon">‚ö°</div>
          <div class="label">Sua Energia (√öltimos 30 Dias)</div>
          <div class="value" id="compSeuEnergia">0.00 kWh</div>
        </div>
        <div class="comparison-card">
          <div class="icon">üìä</div>
          <div class="label">M√©dia Geral (Simulada)</div>
          <div class="value" id="compMediaEnergia">0.00 kWh</div>
        </div>
      </div>
      <div class="form-card" style="margin-top: 20px; background: #f8f9fa;">
        <h3 style="margin-bottom: 15px;">üí° An√°lise</h3>
        <p id="analiseTexto">Configure suas metas e registre consumos para ver a an√°lise comparativa.</p>
      </div>
    </div>
  </div>
  <div id="custo" class="main-content">
    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üí∞ ESTRUTURA DE CUSTO E TARIFAS</h2>
      <div class="filter-section">
        <div class="form-group" style="margin-bottom: 10px;">
            <label for="selectTarifaMesAno">Visualizar Tarifas para o M√™s/Ano:</label>
            <input type="month" id="selectTarifaMesAno" onchange="atualizarDisplayTarifas(this.value)">
        </div>
        <p style="font-size: 0.9em; margin-bottom: 10px;">As tarifas exibidas s√£o usadas para calcular o "Custo Estimado" do per√≠odo de refer√™ncia no Dashboard/Hist√≥rico.</p>
        <button class="btn btn-primary" onclick="abrirModalEdicaoTarifas()">
          ‚úèÔ∏è Editar/Salvar Tarifas para o M√™s Selecionado
        </button>
      </div>
      <div class="comparison-card" style="margin-top: 20px; text-align: left; background: #e0f2f1;">
        <h3 style="color: var(--primary);">üíß √ÅGUA (m¬≥) - Estrutura de Custo</h3>
        <p><strong>Faixa M√≠nima (m¬≥):</strong> <span id="displayFaixaMinimaAgua">0 m¬≥</span></p>
        <p><strong>Tarifa M√≠nima Fixa (R$):</strong> <span id="displayTaxaAguaFixa">R$ 0,00</span></p>
        <p><strong>Tarifa por m¬≥ Excedente (R$):</strong> <span id="displayTarifaAguaExcedente">R$ 0,00</span></p>
        <p style="margin-top: 10px;">**Taxas Adicionais**</p>
        <p><strong>Parcelamento/Juros (R$):</strong> <span id="displayTaxaAguaParcelamento">R$ 0,00</span></p>
        <p><strong>Multas/Impostos (R$):</strong> <span id="displayTaxaAguaMultas">R$ 0,00</span></p>
      </div>
      <div class="comparison-card" style="margin-top: 15px; text-align: left; background: #fffde7;">
        <h3 style="color: var(--warning);">‚ö° ENERGIA (kWh) - Estrutura de Custo</h3>
        <p><strong>Tarifa por kWh (R$):</strong> <span id="displayTarifaEnergiaKWh">R$ 0,00</span></p>
        <p><strong>Custo COSIP Fixo (R$):</strong> <span id="displayTaxaEnergiaFixa">R$ 0,00</span></p>
        <p><strong>Custo Adicional (Bandeira) por kWh:</strong> <span id="displayTarifaEnergiaBandeira">R$ 0,00</span></p>
        <p style="margin-top: 10px;">**Taxas Adicionais**</p>
        <p><strong>Parcelamento (R$):</strong> <span id="displayTaxaEnergiaParcelamento">R$ 0,00</span></p>
        <p><strong>Multas/Juros/Outros (R$):</strong> <span id="displayTaxaEnergiaMultas">R$ 0,00</span></p>
      </div>
    </div>
  </div>
</div>
<div id="genericModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">T√≠tulo</h2>
            <button class="btn-close" onclick="fecharModal()">&times;</button>
        </div>
        <div id="modalBody">
            <form id="modalForm">
              <div id="modalFormContent">
                </div>
              <div class="button-group">
                <button type="submit" class="btn btn-primary" id="modalSubmitBtn">Salvar</button>
              </div>
            </form>
        </div>
    </div>
</div>
<script>
// CONFIGURA√á√ïES GLOBAIS
// üö® VARI√ÅVEIS ATUALIZADAS COM AS SUAS INFORMA√á√ïES
const GOOGLE_SHEET_EDIT_URL = "https://docs.google.com/spreadsheets/d/1iH2JsOjzt3994AAv43hdOdvGG9bp4fSn_MR9vHJP4bU/edit"; 
const scriptURL = "https://script.google.com/macros/s/AKfycbxrvHUYJU8fpUtQ7366A9qUfvvKuot1RwUsi_2IO0jkTantbi3sAY9xJdI2VhJ0RTcN/exec";
// üö® FIM DAS VARI√ÅVEIS DE ATUALIZA√á√ÉO
const DATA_KEYS = {
    TOTAL_AGUA: 'totalAnteriorAgua',
    TOTAL_ENERGIA: 'totalAnteriorEnergia',
    HISTORICO: 'historico', // Historico local (backup)
    METAS_AGUA: 'metaAgua',
    METAS_ENERGIA: 'metaEnergia',
    THEME: 'theme',
    TARIFAS: 'tarifasMensais' 
};
let totalAnteriorAgua = 0;
let totalAnteriorEnergia = 0;
let historico = []; // Hist√≥rico que ser√° exibido (sincronizado)
let historicoLocal = []; // Hist√≥rico mantido no localStorage para backup/uso offline
let metas = { agua: 10, energia: 150 };
let tarifasMensais = {}; 
const DEFAULT_TARIFFS = {
    aguaFaixaMinima: 10.00,        
    aguaFixa: 25.00,               
    aguaExcedente: 6.50,           
    aguaParcelamento: 29.69,       
    aguaMultas: 5.96,              
    energiaKWh: 0.92181,           
    energiaBandeira: 0.10,         
    energiaFixaCOSIP: 53.33,       
    energiaParcelamento: 266.35,   
    energiaMultas: 3.42,           
};
let chartInstance = null;
let pieChartInstance = null;
let dashboardDataInicio = new Date();
let dashboardDataFim = new Date();
const currencyFormatter = new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
});
function getLocalData(key, defaultValue = null) {
    const data = localStorage.getItem(key);
    try {
        const parsed = data ? JSON.parse(data) : defaultValue;
        if (typeof parsed === 'string' && !isNaN(parsed)) {
            return parseFloat(parsed);
        }
        return parsed;
    } catch (e) {
        return data || defaultValue;
    }
}
function setLocalData(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
}
function mostrarMensagem(elemento, texto, tipo) {
  elemento.textContent = texto;
  elemento.className = `mensagem ${tipo}`;
  setTimeout(() => {
    elemento.textContent = '';
    elemento.className = 'mensagem';
  }, 5000);
}
function mostrarNotificacao(mensagem, tipo = 'warning') {
  const notif = document.createElement('div');
  notif.className = `notification ${tipo}`;
  const icon = tipo === 'success' ? '‚úÖ Sucesso' : tipo === 'error' ? '‚ùå Erro' : '‚ö†Ô∏è Alerta';
  notif.innerHTML = `<strong>${icon}</strong><p>${mensagem}</p>`;
  document.body.appendChild(notif);
  setTimeout(() => {
    notif.style.animation = 'slideInRight 0.3s reverse';
    setTimeout(() => notif.remove(), 300);
  }, 5000);
}
const formatDateToInput = (date) => date.toISOString().split('T')[0];
const formatMonthToInput = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
const getFirstDayOfMonth = (monthYear) => {
    const [year, month] = monthYear.split('-');
    return new Date(year, month - 1, 1);
};
const getLastDayOfMonth = (monthYear) => {
    const [year, month] = monthYear.split('-');
    const lastDay = new Date(year, month, 0);
    lastDay.setHours(23, 59, 59, 999);
    return lastDay;
};
function loadTheme() {
    const theme = getLocalData(DATA_KEYS.THEME);
    if (theme === 'dark') {
      document.body.classList.add('dark-mode');
      document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
    } else {
      document.querySelector('.theme-toggle').textContent = 'üåô';
    }
}
function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  const icon = document.querySelector('.theme-toggle');
  icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  setLocalData(DATA_KEYS.THEME, isDark ? 'dark' : 'light');
}
function abrirModal(title, contentHTML, onSubmit, submitText = 'Salvar') {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalFormContent').innerHTML = contentHTML;
    document.getElementById('modalSubmitBtn').textContent = submitText;
    const modalForm = document.getElementById('modalForm');
    modalForm.removeEventListener('submit', modalForm._currentSubmitHandler);
    modalForm._currentSubmitHandler = function(e) {
        e.preventDefault();
        onSubmit(e);
        fecharModal();
    };
    modalForm.addEventListener('submit', modalForm._currentSubmitHandler);
    document.getElementById('genericModal').classList.add('active');
}
function fecharModal() {
    document.getElementById('genericModal').classList.remove('active');
    document.getElementById('modalForm').removeEventListener('submit', document.getElementById('modalForm')._currentSubmitHandler);
}
// FUN√á√ÉO CORRIGIDA PARA ABRIR ABAS
async function showMainTab(tabId) {
  const mainMenu = document.getElementById('mainMenu');
  const mainContainer = document.getElementById('mainContainer');
  mainMenu.style.opacity = '0';
  setTimeout(async () => {
    mainMenu.style.display = 'none';
    mainContainer.style.display = 'block'; // Garante que o container seja exibido
    mainContainer.classList.add('active');
    document.querySelectorAll('.main-content').forEach(div => div.classList.remove('active'));
    document.querySelectorAll('.main-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
    const targetTab = document.getElementById(tabId);
    if (targetTab) {
        targetTab.classList.add('active');
    }
    const clickedButton = Array.from(document.querySelectorAll('.main-tabs .tab-button'))
                            .find(btn => btn.getAttribute('onclick').includes(`'${tabId}'`));
    if(clickedButton) clickedButton.classList.add('active');
    try {
      if (tabId === 'dashboard' || tabId === 'historico' || tabId === 'metas' || tabId === 'comparacao') {
          await carregarHistorico(); 
      }
      if (tabId === 'dashboard') {
        aplicarFiltroDashboard(); 
      } else if (tabId === 'historico') {
        aplicarFiltrosHistorico(); 
      } else if (tabId === 'metas') {
        carregarMetas(); 
        atualizarProgressoMetas();
      } else if (tabId === 'comparacao') {
        atualizarComparacao();
      } else if (tabId === 'custo') { 
        carregarTarifas();
        const mesAnoAtual = formatMonthToInput(new Date());
        document.getElementById('selectTarifaMesAno').value = mesAnoAtual;
        atualizarDisplayTarifas(mesAnoAtual);
      } else if (tabId === 'registro') {
         showFormTab('agua', document.querySelector('#formAgua').previousElementSibling.querySelector('.tab-button:first-child'));
      }
    } catch (err) {
      console.error("Erro ao carregar a aba:", err);
      mostrarNotificacao("Erro ao carregar a aba. Verifique o console.", "error");
    }
  }, 300);
}
// FUN√á√ÉO PARA RETORNAR AO MENU
function showMenu() {
    document.getElementById('mainContainer').classList.remove('active');
    document.getElementById('mainContainer').style.display = 'none';
    document.getElementById('mainMenu').style.display = 'flex';
    document.getElementById('mainMenu').style.opacity = '1';
    document.querySelectorAll('.main-content').forEach(div => div.classList.remove('active'));
    document.querySelectorAll('.main-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
}
function showFormTab(tipo, button) {
  document.querySelectorAll('.form-content').forEach(div => div.style.display = 'none');
  const tipoCaps = tipo.charAt(0).toUpperCase() + tipo.slice(1);
  document.getElementById(`form${tipoCaps}`).style.display = 'block';
  const buttons = document.querySelector(`#form${tipoCaps}`).closest('.form-card').querySelector('div:first-child').querySelectorAll('.tab-button');
  buttons.forEach(btn => btn.classList.remove('active'));
  button.classList.add('active');
  setTimeout(() => {
        const inputLeitura = document.getElementById(`leituraAtual${tipoCaps}`);
        if(inputLeitura) inputLeitura.focus();
    }, 100); 
}
// FUN√á√ÉO ADICIONADA: BUSCA TODOS OS REGISTROS NA PLANILHA
async function fetchHistoricoFromSheets() {
    try {
        const res = await fetch(`${scriptURL}?action=getAll`);
        const result = await res.json();
        if (result.status === 'success' && Array.isArray(result.data)) {
            const fetchedData = result.data.map(h => ({
                ...h,
                data: (new Date(h.dataHoraStr)).toISOString(), // Normaliza a data
                tipo: h.tipo.toLowerCase() === '√°gua' ? 'agua' : h.tipo.toLowerCase(), 
                consumo: parseFloat(h.consumo) || 0,
                total: parseFloat(h.total) || 0,
            }));
            fetchedData.sort((a, b) => new Date(b.data) - new Date(a.data));
            return fetchedData;
        } else {
            console.error("Erro ao buscar hist√≥rico da planilha:", result.message || "Estrutura de dados inv√°lida.");
            mostrarNotificacao("Falha ao carregar hist√≥rico da Planilha. Usando dados locais.", "error");
            return [];
        }
    } catch (err) {
        console.warn("Erro de conex√£o ao buscar hist√≥rico da Planilha. Usando dados locais.", err);
        mostrarNotificacao("Erro de conex√£o (Planilha Google). Usando dados locais.", "warning");
        return [];
    }
}
async function carregarTotais() {
    // 1. Carrega totais do localStorage como fallback
    totalAnteriorAgua = getLocalData(DATA_KEYS.TOTAL_AGUA, 0);
    totalAnteriorEnergia = getLocalData(DATA_KEYS.TOTAL_ENERGIA, 0);
    // 2. Tenta buscar os √∫ltimos totais da Planilha (mais confi√°vel)
    try {
        const res = await fetch(`${scriptURL}?action=getLast`);
        const data = await res.json();
        if (data.agua !== undefined && !isNaN(parseFloat(data.agua))) {
            totalAnteriorAgua = parseFloat(data.agua);
            setLocalData(DATA_KEYS.TOTAL_AGUA, totalAnteriorAgua);
        }
        if (data.energia !== undefined && !isNaN(parseFloat(data.energia))) {
            totalAnteriorEnergia = parseFloat(data.energia);
            setLocalData(DATA_KEYS.TOTAL_ENERGIA, totalAnteriorEnergia);
        }
    } catch (err) {
        console.warn("Erro ao carregar totais do servidor. Usando dados locais.", err);
    }
    document.getElementById("leituraAnteriorAguaDisplay").value = totalAnteriorAgua.toFixed(2);
    document.getElementById("leituraAnteriorEnergiaDisplay").value = totalAnteriorEnergia.toFixed(2);
    const leituraAtualAguaInput = document.getElementById("leituraAtualAgua");
    const leituraAtualEnergiaInput = document.getElementById("leituraAtualEnergia");
    if (leituraAtualAguaInput && leituraAtualAguaInput.value === '') {
        leituraAtualAguaInput.value = totalAnteriorAgua.toFixed(2);
    }
    if (leituraAtualEnergiaInput && leituraAtualEnergiaInput.value === '') {
        leituraAtualEnergiaInput.value = totalAnteriorEnergia.toFixed(2);
    }
    document.getElementById("totalAgua").value = parseFloat(leituraAtualAguaInput.value).toFixed(2);
    document.getElementById("totalEnergia").value = parseFloat(leituraAtualEnergiaInput.value).toFixed(2);
    document.getElementById("displayTotalAgua").textContent = totalAnteriorAgua.toFixed(2) + " m¬≥";
    document.getElementById("displayTotalEnergia").textContent = totalAnteriorEnergia.toFixed(2) + " kWh";
    atualizarTotal('agua');
    atualizarTotal('energia');
    verificarAlertas();
}
function atualizarTotal(tipo) {
  const tipoCaps = tipo.charAt(0).toUpperCase() + tipo.slice(1);
  const inputLeitura = document.getElementById(`leituraAtual${tipoCaps}`);
  const inputConsumo = document.getElementById(`consumo${tipoCaps}`);
  const inputTotal = document.getElementById(`total${tipoCaps}`);
  const inputLeituraAnterior = document.getElementById(`leituraAnterior${tipoCaps}Display`); 
  const leituraAtual = parseFloat(inputLeitura.value) || 0;
  const totalAnterior = tipo === 'agua' ? totalAnteriorAgua : totalAnteriorEnergia;
  inputLeituraAnterior.value = totalAnterior.toFixed(2); 
  const consumoCalculado = Math.max(0, leituraAtual - totalAnterior);
  const novoTotalAcumulado = leituraAtual; 
  inputConsumo.value = consumoCalculado.toFixed(2);
  inputTotal.value = novoTotalAcumulado.toFixed(2);
  if (leituraAtual < totalAnterior && leituraAtual > 0) {
      mostrarNotificacao(`A leitura atual (${leituraAtual.toFixed(2)}) √© menor que a anterior (${totalAnterior.toFixed(2)}). Verifique a leitura!`, 'error');
  }
}
function abrirModalRedefinir(tipo) {
    const label = tipo === 'agua' ? '√Ågua (m¬≥)' : 'Energia (kWh)';
    const totalAtual = tipo === 'agua' ? totalAnteriorAgua : totalAnteriorEnergia;
    const content = `
        <p style="margin-bottom: 15px;">O total atual de ${label} √© <strong>${totalAtual.toFixed(2)}</strong>. <br><span style="color: var(--danger); font-size: 0.9em;">**Cuidado!** Isso redefine o valor inicial.</span></p>
        <div class="form-group">
            <label>Novo Total Inicial Acumulado (${label}):</label>
            <input type="number" id="inputNovoTotal" step="0.01" required placeholder="Digite o novo valor inicial">
        </div>
    `;
    abrirModal(`üîÑ Redefinir Total Inicial de ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`, content, (e) => {
        e.preventDefault();
        const novoValorStr = document.getElementById('inputNovoTotal').value;
        const novoValor = parseFloat(novoValorStr);
        definirInicio(tipo, novoValor);
    }, 'Redefinir');
}
function definirInicio(tipo, novoValor) {
    if (!isNaN(novoValor) && novoValor >= 0) {
      const valorFormatado = novoValor.toFixed(2);
      const tipoCaps = tipo.charAt(0).toUpperCase() + tipo.slice(1);
      if (tipo === 'agua') {
        totalAnteriorAgua = novoValor;
        setLocalData(DATA_KEYS.TOTAL_AGUA, totalAnteriorAgua);
        document.getElementById("leituraAnteriorAguaDisplay").value = valorFormatado; 
      } else {
        totalAnteriorEnergia = novoValor;
        setLocalData(DATA_KEYS.TOTAL_ENERGIA, totalAnteriorEnergia);
        document.getElementById("leituraAnteriorEnergiaDisplay").value = valorFormatado; 
      }
      document.getElementById(`leituraAtual${tipoCaps}`).value = valorFormatado; 
      document.getElementById("displayTotalAgua").textContent = totalAnteriorAgua.toFixed(2) + " m¬≥";
      document.getElementById("displayTotalEnergia").textContent = totalAnteriorEnergia.toFixed(2) + " kWh";
      atualizarTotal(tipo);
      mostrarNotificacao(`Total Inicial de ${tipoCaps} redefinido para ${valorFormatado}.`, 'success');
    } else {
      mostrarNotificacao('Valor inv√°lido. Por favor, digite um n√∫mero n√£o negativo.', 'error');
    }
}
async function handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const tipo = form.id === 'aguaForm' ? 'agua' : 'energia';
    const tipoCaps = tipo.charAt(0).toUpperCase() + tipo.slice(1);
    const msg = document.getElementById(`msg${tipoCaps}`);
    const btn = form.querySelector('button[type="submit"]');
    btn.classList.add('loading');
    btn.disabled = true;
    const formData = new FormData(form);
    const dataHoraStr = formData.get('dataHora');
    const dataHora = new Date(dataHoraStr);
    if (dataHora.getTime() > new Date().getTime()) {
        mostrarMensagem(msg, `‚ö†Ô∏è A data/hora do registro n√£o pode ser futura. Corrija o campo.`, "error");
        btn.classList.remove('loading');
        btn.disabled = false;
        return;
    }
    const consumo = parseFloat(formData.get(`consumo${tipoCaps}`));
    const total = parseFloat(formData.get(`total${tipoCaps}`));
    const nome = formData.get('nome');
    const matricula = formData.get('matricula');
    if (consumo < 0) {
        mostrarMensagem(msg, `‚ö†Ô∏è Consumo de ${tipoCaps} √© negativo (${consumo.toFixed(2)}). Verifique a leitura. Envio Bloqueado.`, "error");
        btn.classList.remove('loading');
        btn.disabled = false;
        return;
    }
    if (consumo === 0 && parseFloat(formData.get(`leituraAtual${tipoCaps}`)) > (tipo === 'agua' ? totalAnteriorAgua : totalAnteriorEnergia)) {
        if (!confirm("O consumo calculado √© 0. Deseja prosseguir com o registro?")) {
            btn.classList.remove('loading');
            btn.disabled = false;
            return;
        }
    }
    const novoRegistro = {
        id: Date.now().toString(36) + Math.random().toString(36).substring(2, 9), 
         dataHoraStr,
        tipo: tipo,
        nome: nome,
        consumo: consumo,
        total: total,
        matricula: matricula,
        extra1: formData.get('extra1') || '',
        extra2: formData.get('extra2') || '',
        extra3: formData.get('extra3') || '',
    };
    try {
        // Envio ass√≠ncrono para o Sheets
        const fetchPromise = fetch(scriptURL, { method: 'POST', body: formData });
        
        // Atualiza localmente o hist√≥rico de backup e os totais para resposta imediata
        setLocalData('lastNome', nome);
        setLocalData('lastMatricula', matricula);
        // O hist√≥rico local √© mantido apenas como backup, a exibi√ß√£o vir√° do Sheets na pr√≥xima carga
        historicoLocal.unshift(novoRegistro); 
        setLocalData(DATA_KEYS.HISTORICO, historicoLocal); 
        
        // Os totais s√£o atualizados com o valor local, mas ser√£o revalidados pelo Sheets na pr√≥xima carregarTotais
        if (tipo === 'agua') {
            totalAnteriorAgua = novoRegistro.total;
            setLocalData(DATA_KEYS.TOTAL_AGUA, totalAnteriorAgua);
        } else {
            totalAnteriorEnergia = novoRegistro.total;
            setLocalData(DATA_KEYS.TOTAL_ENERGIA, totalAnteriorEnergia);
        }
        mostrarMensagem(msg, `‚úÖ Registro de ${tipoCaps} salvo localmente e enviado ao Sheets!`, "success");
        form.reset();
        
        // Espera o envio para o Sheets, mas n√£o bloqueia a UI
        fetchPromise
            .then(() => console.log('Dados enviados ao Sheets com sucesso'))
            .catch(err => console.error('Erro ao enviar dados ao Sheets:', err));

        // Recarrega os dados do Sheets
        await carregarTotais(); 
        await carregarHistorico(); 
        aplicarFiltroDashboard(); 
    } catch (err) {
        console.error("Erro ao processar dados localmente:", err);
        mostrarMensagem(msg, "‚ùå Erro interno. Recarregue a p√°gina.", "error");
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
        document.querySelectorAll('input[name="nome"]').forEach(input => input.value = nome);
        document.querySelectorAll('input[name="matricula"]').forEach(input => input.value = matricula);
    }
}
function agruparDados(dados, agregacao) {
    const grupos = {};
    dados.forEach(item => {
        const date = new Date(item.data);
        let key;
        switch (agregacao) {
            case 'mensal':
                key = formatMonthToInput(date);
                break;
            case 'semanal':
                const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                key = `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
                break;
            case 'diario':
            default:
                key = formatDateToInput(date);
                break;
        }
        if (!grupos[key]) {
            grupos[key] = { agua: 0, energia: 0 };
        }
        if (item.tipo === 'agua') {
            grupos[key].agua += item.consumo;
        } else if (item.tipo === 'energia') {
            grupos[key].energia += item.consumo;
        }
    });
    return grupos;
}
function filtrarDadosPorData(dados, dataInicio, dataFim) {
    const inicio = new Date(dataInicio).setHours(0, 0, 0, 0);
    const fim = new Date(dataFim).setHours(23, 59, 59, 999); 
    return dados.filter(item => {
        const dataRegistro = new Date(item.data).getTime();
        return dataRegistro >= inicio && dataRegistro <= fim;
    });
}
function getTarifasParaMes(monthYear) {
    return tarifasMensais[monthYear] || DEFAULT_TARIFFS;
}
function calcularCusto(aguaConsumo, energiaConsumo, monthYear) {
    const tarifas = getTarifasParaMes(monthYear);
    let custoAgua = 0; 
    let custoEnergia = 0;
    let detalhesAgua = {
        consumo: aguaConsumo,
        tarifaFixa: tarifas.aguaFixa,
        faixaMinima: tarifas.aguaFaixaMinima,
        custoExcedente: 0,
        excedente: 0,
        tarifaExcedente: tarifas.aguaExcedente,
        taxas: tarifas.aguaParcelamento + tarifas.aguaMultas,
        total: 0
    };
    let detalhesEnergia = {
        consumo: energiaConsumo,
        tarifaKWh: tarifas.energiaKWh,
        tarifaBandeira: tarifas.energiaBandeira,
        custoKWh: 0,
        custoBandeira: 0,
        taxaFixaCOSIP: tarifas.energiaFixaCOSIP,
        taxas: tarifas.energiaParcelamento + tarifas.energiaMultas,
        total: 0
    };
    if (aguaConsumo <= tarifas.aguaFaixaMinima) {
        custoAgua = tarifas.aguaFixa;
    } else {
        detalhesAgua.excedente = aguaConsumo - tarifas.aguaFaixaMinima;
        detalhesAgua.custoExcedente = detalhesAgua.excedente * tarifas.aguaExcedente;
        custoAgua = tarifas.aguaFixa + detalhesAgua.custoExcedente;
    }
    custoAgua += detalhesAgua.taxas;
    detalhesAgua.total = custoAgua;
    detalhesEnergia.custoKWh = energiaConsumo * tarifas.energiaKWh;
    detalhesEnergia.custoBandeira = energiaConsumo * tarifas.energiaBandeira;
    custoEnergia = detalhesEnergia.custoKWh + detalhesEnergia.custoBandeira;
    custoEnergia += detalhesEnergia.taxaFixaCOSIP + detalhesEnergia.taxas;
    detalhesEnergia.total = custoEnergia;
    const custoTotal = custoAgua + custoEnergia;
    return {
        agua: custoAgua,
        energia: custoEnergia,
        total: custoTotal,
        detalhesAgua: detalhesAgua,
        detalhesEnergia: detalhesEnergia
    };
}
function calcularCustoPeriodoCorrigido(dataInicio, dataFim) {
    const dadosFiltrados = filtrarDadosPorData(historico, dataInicio, dataFim);
    const consumoPorMes = dadosFiltrados.reduce((acc, item) => {
        const mesAno = formatMonthToInput(new Date(item.data));
        if (!acc[mesAno]) {
            acc[mesAno] = { agua: 0, energia: 0 };
        }
        if (item.tipo === 'agua') {
            acc[mesAno].agua += item.consumo;
        } else if (item.tipo === 'energia') {
            acc[mesAno].energia += item.consumo;
        }
        return acc;
    }, {});
    let custoAguaTotal = 0;
    let custoEnergiaTotal = 0;
    for (const mesAno in consumoPorMes) {
        const { agua, energia } = consumoPorMes[mesAno];
        const resultadoMes = calcularCusto(agua, energia, mesAno);
        custoAguaTotal += resultadoMes.agua;
        custoEnergiaTotal += resultadoMes.energia;
    }
    return {
        custoAguaTotal: custoAguaTotal,
        custoEnergiaTotal: custoEnergiaTotal,
        custoTotal: custoAguaTotal + custoEnergiaTotal
    };
}
function criarGraficos(dataInicio, dataFim) {
    carregarTarifas(); 
    const agregacao = document.getElementById('agregacao').value; 
    const dadosFiltrados = filtrarDadosPorData(historico, dataInicio, dataFim);
    const dadosAgrupados = agruparDados(dadosFiltrados, agregacao);
    const labels = Object.keys(dadosAgrupados).sort();
    const aguaData = labels.map(key => dadosAgrupados[key].agua);
    const energiaData = labels.map(key => dadosAgrupados[key].energia);
    const formattedLabels = labels.map(label => {
        if (agregacao === 'mensal') {
            const [year, month] = label.split('-');
            return `${month}/${year}`;
        }
        return label;
    });
    const ctx = document.getElementById('consumptionChart');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'line',
       data: {
        labels: formattedLabels,
        datasets: [
          {
            label: '√Ågua (m¬≥)',
            data: aguaData,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
          },
          {
            label: 'Energia (kWh)',
            data: energiaData,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            tension: 0.4,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          title: {
            display: true,
            text: `Consumo (${agregacao.charAt(0).toUpperCase() + agregacao.slice(1)}) de ${formatDateToInput(dataInicio)} a ${formatDateToInput(dataFim)}`
          }
        },
        scales: {
            x: {
                title: { display: true, text: 'Per√≠odo' }
            },
            y: {
                title: { display: true, text: 'Consumo' }
            }
        }
      }
    });
    const ctxPie = document.getElementById('pieChart');
    if (pieChartInstance) pieChartInstance.destroy();
    const totalAguaGeral = historico.filter(h => h.tipo === 'agua').reduce((a, b) => a + b.consumo, 0);
    const totalEnergiaGeral = historico.filter(h => h.tipo === 'energia').reduce((a, b) => a + b.consumo, 0);
    pieChartInstance = new Chart(ctxPie, {
      type: 'doughnut',
       data: {
        labels: ['√Ågua', 'Energia'],
        datasets: [{
           data: [totalAguaGeral, totalEnergiaGeral],
          backgroundColor: ['#667eea', '#f59e0b']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Distribui√ß√£o Total Acumulada'
            }
        }
      }
    });
    const aguaConsumoPeriodo = Object.values(dadosAgrupados).reduce((sum, item) => sum + item.agua, 0);
    const energiaConsumoPeriodo = Object.values(dadosAgrupados).reduce((sum, item) => sum + item.energia, 0);
    const diffTime = Math.abs(dataFim.getTime() - dataInicio.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    document.getElementById('aguaMes').textContent = aguaConsumoPeriodo.toFixed(2) + ' m¬≥';
    document.getElementById('energiaMes').textContent = energiaConsumoPeriodo.toFixed(2) + ' kWh';
    const metaAguaMensal = metas.agua || 10;
    const metaAguaPeriodo = (metaAguaMensal / 30) * diffDays; 
    let economiaTexto = '';
    const cardEconomiaAgua = document.getElementById('cardEconomiaAgua');
    cardEconomiaAgua.classList.remove('success', 'danger', 'warning');
    if (metaAguaPeriodo === 0) {
        economiaTexto = 'N/A';
        cardEconomiaAgua.classList.add('warning');
    } else {
        const excedente = aguaConsumoPeriodo - metaAguaPeriodo;
        if (excedente > 0) {
            const percentExcedente = (excedente / metaAguaPeriodo) * 100;
            economiaTexto = `+${percentExcedente.toFixed(0)}% (Acima)`;
            cardEconomiaAgua.classList.add('danger');
        } else {
            const percentEconomia = Math.max(0, 100 - (aguaConsumoPeriodo / metaAguaPeriodo) * 100);
            economiaTexto = `${percentEconomia.toFixed(0)}% (Economia)`;
            cardEconomiaAgua.classList.add('success');
        }
    }
    document.getElementById('economiaAgua').textContent = economiaTexto;
    const custoPeriodo = calcularCustoPeriodoCorrigido(dataInicio, dataFim);
    document.getElementById('custoTotal').textContent = currencyFormatter.format(custoPeriodo.custoTotal);
}
// FUN√á√ÉO ATUALIZADA: CARREGA DADOS DA PLANILHA E USA LOCAL COMO FALLBACK/BACKUP
async function carregarHistorico() {
  document.getElementById('loadingHistorico').style.display = 'block';
  historicoLocal = getLocalData(DATA_KEYS.HISTORICO, []).map(h => ({
      ...h,
      data: h.dataHoraStr || h.data, // Usa dataHoraStr se dispon√≠vel
      tipo: h.tipo.toLowerCase() === '√°gua' ? 'agua' : h.tipo.toLowerCase() 
  })); 
  
  const historicoSheets = await fetchHistoricoFromSheets();
  
  // Mescla: Usa dados do Sheets, e usa o local se o Sheets falhar/estiver vazio
  if (historicoSheets.length > 0) {
      historico = historicoSheets;
  } else {
      historico = historicoLocal;
      // N√£o mostra notifica√ß√£o se for a primeira carga e o Sheets falhar/estiver vazio
      if (historicoLocal.length > 0) {
          mostrarNotificacao(`N√£o foi poss√≠vel carregar o hist√≥rico da Planilha. Exibindo ${historico.length} registros locais.`, 'warning');
      }
  }

  historico.sort((a, b) => new Date(b.data) - new Date(a.data));
  document.getElementById('loadingHistorico').style.display = 'none';
}
function aplicarFiltrosHistorico() {
  document.getElementById('loadingHistorico').style.display = 'block';
  const filtroTipo = document.getElementById('filtroTipo').value;
  const filtroPeriodo = document.getElementById('filtroPeriodo').value;
  const tbody = document.getElementById('historicoBody');
  let dadosFiltrados = historico;
  const hoje = new Date();
  hoje.setHours(0, 0, 0, 0);
  let dataInicioFiltro = null;
  let dataFimFiltro = new Date(); 
  dataFimFiltro.setHours(23, 59, 59, 999);
  switch (filtroPeriodo) {
      case 'hoje':
          dataInicioFiltro = new Date(hoje);
          break;
      case '7dias':
          dataInicioFiltro = new Date(hoje);
          dataInicioFiltro.setDate(hoje.getDate() - 6); 
          break;
      case '30dias':
          dataInicioFiltro = new Date(hoje);
          dataInicioFiltro.setDate(hoje.getDate() - 29); 
          break;
      case 'custom':
          const inicioStr = document.getElementById('filtroDataInicio').value;
          const fimStr = document.getElementById('filtroDataFim').value;
          if (inicioStr && fimStr) {
              dataInicioFiltro = new Date(inicioStr);
              dataFimFiltro = new Date(fimStr);
              dataFimFiltro.setHours(23, 59, 59, 999);
          } else {
              dadosFiltrados = historico; 
          }
          break;
      case 'todos':
      default:
          dadosFiltrados = historico;
          break;
  }
  if (dataInicioFiltro && filtroPeriodo !== 'todos') {
      dadosFiltrados = filtrarDadosPorData(historico, dataInicioFiltro, dataFimFiltro);
  }
  if (filtroTipo !== 'todos' && dadosFiltrados) {
    dadosFiltrados = dadosFiltrados.filter(h => h.tipo === filtroTipo);
  }
  if (!dadosFiltrados || dadosFiltrados.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Nenhum registro encontrado para o filtro selecionado.</td></tr>';
    document.getElementById('loadingHistorico').style.display = 'none';
    return;
  }
  tbody.innerHTML = dadosFiltrados.map(item => `
    <tr>
      <td>${new Date(item.data).toLocaleString('pt-BR')}</td>
      <td>${item.tipo === 'agua' ? 'üíß √ÅGUA' : '‚ö° ENERGIA'}</td>
      <td>${item.nome}</td>
      <td>${parseFloat(item.consumo).toFixed(2)} ${item.tipo === 'agua' ? 'm¬≥' : 'kWh'}</td>
      <td>${parseFloat(item.total).toFixed(2)} ${item.tipo === 'agua' ? 'm¬≥' : 'kWh'}</td>
      <td class="action-buttons">
          <button class="btn-icon btn-edit" title="Editar - Indispon√≠vel (Edite na Planilha)" disabled>
            <span class="material-icons" style="font-size: 18px;">edit</span>
          </button>
          <button class="btn-icon btn-delete" title="Excluir - Indispon√≠vel (Exclua na Planilha)" disabled>
            <span class="material-icons" style="font-size: 18px;">delete</span>
          </button>
      </td>
    </tr>
  `).join('');
    document.getElementById('loadingHistorico').style.display = 'none';
}
function abrirModalEdicao(id) {
    mostrarNotificacao('A edi√ß√£o de registros deve ser feita diretamente no Google Sheets para manter a sincroniza√ß√£o e integridade dos totais.', 'error');
}
function excluirRegistro(id) {
    mostrarNotificacao('A exclus√£o de registros deve ser feita diretamente no Google Sheets para manter a sincroniza√ß√£o e integridade dos totais.', 'error');
}
function limparTodosRegistros() {
    if (!confirm("‚ö†Ô∏è CONFIRMA√á√ÉO FINAL: Tem certeza que deseja APAGAR TODOS os registros (√Ågua e Energia) do hist√≥rico local (backup) e ZERAR os Totais Acumulados Locais? Esta a√ß√£o √© irrevers√≠vel localmente, mas N√ÉO AFETA a Planilha Google.")) return;
    historicoLocal = [];
    setLocalData(DATA_KEYS.HISTORICO, historicoLocal);
    totalAnteriorAgua = 0;
    totalAnteriorEnergia = 0;
    setLocalData(DATA_KEYS.TOTAL_AGUA, 0);
    setLocalData(DATA_KEYS.TOTAL_ENERGIA, 0);
    carregarTotais(); 
    carregarHistorico(); // Recarrega do Sheets para o display
    aplicarFiltrosHistorico();
    aplicarFiltroDashboard();
    setLocalData('lastNome', '');
    setLocalData('lastMatricula', '');
    document.querySelectorAll('input[name="nome"]').forEach(input => input.value = '');
    document.querySelectorAll('input[name="matricula"]').forEach(input => input.value = '');
    mostrarNotificacao('‚úÖ Hist√≥rico local (backup) e Totais acumulados locais foram zerados. O hist√≥rico do Sheets n√£o foi afetado.', 'success');
}
function exportarJSON() {
    const data = {
        historico: getLocalData(DATA_KEYS.HISTORICO, []), // Exporta o backup local
        tarifas: getLocalData(DATA_KEYS.TARIFAS, {}),
        totais: {
            agua: totalAnteriorAgua,
            energia: totalAnteriorEnergia
        }
    };
    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `backup_consumo_local_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    mostrarNotificacao('Backup JSON Local exportado com sucesso!', 'success');
}
function importarJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if (imported.historico && Array.isArray(imported.historico)) {
                const cleanedData = imported.historico.filter(item => item.id && item.data && item.tipo && item.consumo && item.total);
                if (cleanedData.length === 0 && imported.historico.length > 0) {
                     mostrarNotificacao('O arquivo JSON n√£o cont√©m registros de hist√≥rico v√°lidos.', 'error');
                     return;
                }
                setLocalData(DATA_KEYS.HISTORICO, cleanedData);
                historicoLocal = cleanedData;
            }
            if (imported.tarifas && typeof imported.tarifas === 'object') {
                setLocalData(DATA_KEYS.TARIFAS, imported.tarifas);
                tarifasMensais = imported.tarifas;
            }
            if (imported.totais) {
                totalAnteriorAgua = parseFloat(imported.totais.agua) || 0;
                totalAnteriorEnergia = parseFloat(imported.totais.energia) || 0;
                setLocalData(DATA_KEYS.TOTAL_AGUA, totalAnteriorAgua);
                setLocalData(DATA_KEYS.TOTAL_ENERGIA, totalAnteriorEnergia);
            }
            carregarTotais(); 
            carregarHistorico(); // Recarrega (o display usar√° o sheets, mas o backup local foi restaurado)
            aplicarFiltrosHistorico();
            aplicarFiltroDashboard();
            mostrarNotificacao(`Dados de ${historicoLocal.length} registros e tarifas RESTAURADOS no backup local! O display continuar√° mostrando o Sheets.`, 'success');
        } catch (error) {
            console.error(error);
            mostrarNotificacao(`Erro ao processar arquivo JSON: ${error.message}`, 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}
function exportarCSV() {
    const filtro = document.getElementById('filtroTipo').value;
    const periodo = document.getElementById('filtroPeriodo').value;
    const dadosParaExportar = historico.filter(item => filtro === 'todos' || item.tipo === filtro);
    let dataInicioFiltro = null;
    let dataFimFiltro = new Date();
    dataFimFiltro.setHours(23, 59, 59, 999);
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    if (periodo === 'hoje') {
        dataInicioFiltro = new Date(hoje);
    } else if (periodo === '7dias') {
        dataInicioFiltro = new Date(hoje);
        dataInicioFiltro.setDate(hoje.getDate() - 6); 
    } else if (periodo === '30dias') {
        dataInicioFiltro = new Date(hoje);
        dataInicioFiltro.setDate(hoje.getDate() - 29); 
    } else if (periodo === 'custom') {
        const inicioStr = document.getElementById('filtroDataInicio').value;
        const fimStr = document.getElementById('filtroDataFim').value;
        if (inicioStr && fimStr) {
            dataInicioFiltro = new Date(inicioStr);
            dataFimFiltro = new Date(fimStr);
            dataFimFiltro.setHours(23, 59, 59, 999);
        }
    }
    let dadosFinais = dadosParaExportar;
    if (dataInicioFiltro) {
        dadosFinais = filtrarDadosPorData(dadosParaExportar, dataInicioFiltro, dataFimFiltro);
    }
    const csv = ['"Data/Hora","Tipo","Nome","Consumo","Total"'];
    dadosFinais.forEach(item => {
        csv.push(`"${new Date(item.data).toLocaleString('pt-BR')}","${item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1)}","${item.nome}","${parseFloat(item.consumo).toFixed(2)}","${parseFloat(item.total).toFixed(2)}"`);
    });
    const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `historico_consumo_exportado_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    mostrarNotificacao(`Arquivo CSV de ${dadosFinais.length} registros exportado com sucesso!`, 'success');
}
function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Registro de Consumo - √Ågua e Energia", 14, 20);
    const filtro = document.getElementById('filtroTipo').value;
    const periodo = document.getElementById('filtroPeriodo').value;
    const dadosParaExportar = historico.filter(item => filtro === 'todos' || item.tipo === filtro);
    let dataInicioFiltro = null;
    let dataFimFiltro = new Date();
    dataFimFiltro.setHours(23, 59, 59, 999);
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    if (periodo === 'hoje') {
        dataInicioFiltro = new Date(hoje);
    } else if (periodo === '7dias') {
        dataInicioFiltro = new Date(hoje);
        dataInicioFiltro.setDate(hoje.getDate() - 6); 
    } else if (periodo === '30dias') {
        dataInicioFiltro = new Date(hoje);
        dataInicioFiltro.setDate(hoje.getDate() - 29); 
    } else if (periodo === 'custom') {
        const inicioStr = document.getElementById('filtroDataInicio').value;
        const fimStr = document.getElementById('filtroDataFim').value;
        if (inicioStr && fimStr) {
            dataInicioFiltro = new Date(inicioStr);
            dataFimFiltro = new Date(fimStr);
            dataFimFiltro.setHours(23, 59, 59, 999);
        }
    }
    let dadosFinais = dadosParaExportar;
    if (dataInicioFiltro) {
        dadosFinais = filtrarDadosPorData(dadosParaExportar, dataInicioFiltro, dataFimFiltro);
    }
    doc.setFontSize(10);
    doc.text(`Total de Registros (Filtrados): ${dadosFinais.length}`, 14, 28);
    doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 34);
    const tableData = dadosFinais.map(item => [
        new Date(item.data).toLocaleString('pt-BR'),
        item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1),
        item.nome,
        `${parseFloat(item.consumo).toFixed(2)} ${item.tipo === 'agua' ? 'm¬≥' : 'kWh'}`,
        `${parseFloat(item.total).toFixed(2)} ${item.tipo === 'agua' ? 'm¬≥' : 'kWh'}`,
    ]);
    doc.autoTable({
        head: [['Data/Hora', 'Tipo', 'Nome', 'Consumo', 'Total']],
        body: tableData,
        startY: 40,
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [102, 126, 234] }
    });
    doc.save(`historico_consumo_exportado_${new Date().toISOString().split('T')[0]}.pdf`);
    mostrarNotificacao(`Arquivo PDF de ${dadosFinais.length} registros exportado com sucesso!`, 'success');
}
function calcularCustoPorPeriodo() {
    carregarTarifas(); 
    const dataInicioStr = document.getElementById('filtroCustoDataInicio').value;
    const dataFimStr = document.getElementById('filtroCustoDataFim').value;
    const tipo = document.getElementById('filtroCustoTipo').value;
    const resDetalhe = document.getElementById('resCustoDetalhe');
    if (!dataInicioStr || !dataFimStr) {
        resDetalhe.innerHTML = '<p style="color: var(--danger);">Selecione a Data In√≠cio e Data Fim para o c√°lculo.</p>';
        return;
    }
    const dataInicio = new Date(dataInicioStr);
    const dataFim = new Date(dataFimStr);
    dataFim.setHours(23, 59, 59, 999);
    if (dataInicio.getTime() > dataFim.getTime()) {
        resDetalhe.innerHTML = '<p style="color: var(--danger);">A Data In√≠cio n√£o pode ser maior que a Data Fim.</p>';
        return;
    }
    const custoPeriodo = calcularCustoPeriodoCorrigido(dataInicio, dataFim);
    const dadosMes = filtrarDadosPorData(historico, dataInicio, dataFim);
    const aguaConsumoPeriodo = dadosMes
        .filter(h => h.tipo === 'agua')
        .reduce((a, b) => a + b.consumo, 0);
    const energiaConsumoPeriodo = dadosMes
        .filter(h => h.tipo === 'energia')
        .reduce((a, b) => a + b.consumo, 0);
    let htmlResultado = '';
    if (tipo === 'agua' || tipo === 'total') {
        if (aguaConsumoPeriodo === 0 && tipo !== 'total') {
            htmlResultado += `<p style="color: var(--warning);">üíß **√Ågua:** Nenhum consumo registrado no per√≠odo.</p>`;
        } else {
             const mesReferencia = formatMonthToInput(dataFim);
             const custoDetalheAgua = calcularCusto(aguaConsumoPeriodo, 0, mesReferencia).detalhesAgua;
             htmlResultado += `
                <h4 style="margin-bottom: 10px; color: var(--primary);">üíß √Ågua (Custo Total: ${currencyFormatter.format(custoPeriodo.custoAguaTotal)})</h4>
                <p><strong>Consumo Total no Per√≠odo:</strong> ${aguaConsumoPeriodo.toFixed(2)} m¬≥</p>
                <p style="font-size: 0.9em; color: gray;">* O custo detalhado abaixo √© uma ESTIMATIVA usando a tarifa de ${mesReferencia} para todo o consumo do per√≠odo.</p>
                <p><strong>Tarifa Fixa (cobre ${custoDetalheAgua.faixaMinima.toFixed(2)} m¬≥):</strong> ${currencyFormatter.format(custoDetalheAgua.tarifaFixa)}</p>
                ${custoDetalheAgua.excedente > 0 ? 
                    `<p><strong>Consumo Excedente (Estimado):</strong> ${custoDetalheAgua.excedente.toFixed(2)} m¬≥ @ ${currencyFormatter.format(custoDetalheAgua.tarifaExcedente)}/m¬≥</p>
                    <p><strong>Custo Excedente (Estimado):</strong> ${currencyFormatter.format(custoDetalheAgua.custoExcedente)}</p>` :
                    '<p><strong>Consumo:</strong> Abaixo ou igual √† Faixa M√≠nima (na estimativa de custo de banda).</p>'
                }
                <p><strong>Taxas/Parcelamento Fixo (Estimado):</strong> ${currencyFormatter.format(custoDetalheAgua.taxas)}</p>
                ${tipo === 'total' ? '<hr style="margin: 10px 0;">' : ''}
            `;
        }
    } 
    if (tipo === 'energia' || tipo === 'total') {
        if (energiaConsumoPeriodo === 0 && tipo !== 'total') {
            htmlResultado += `<p style="color: var(--warning);">‚ö° **Energia:** Nenhum consumo registrado no per√≠odo.</p>`;
        } else {
            const mesReferencia = formatMonthToInput(dataFim);
            const custoDetalheEnergia = calcularCusto(0, energiaConsumoPeriodo, mesReferencia).detalhesEnergia;
            htmlResultado += `
                <h4 style="margin-bottom: 10px; color: var(--warning);">‚ö° Energia (Custo Total: ${currencyFormatter.format(custoPeriodo.custoEnergiaTotal)})</h4>
                <p><strong>Consumo Total no Per√≠odo:</strong> ${energiaConsumoPeriodo.toFixed(2)} kWh</p>
                <p style="font-size: 0.9em; color: gray;">* O custo detalhado abaixo √© uma ESTIMATIVA usando a tarifa de ${mesReferencia} para todo o consumo do per√≠odo.</p>
                <p><strong>Custo kWh (Base):</strong> ${currencyFormatter.format(custoDetalheEnergia.custoKWh)} (@ ${currencyFormatter.format(custoDetalheEnergia.tarifaKWh)}/kWh)</p>
                <p><strong>Custo kWh (Bandeira):</strong> ${currencyFormatter.format(custoDetalheEnergia.custoBandeira)} (@ ${currencyFormatter.format(custoDetalheEnergia.tarifaBandeira)}/kWh)</p>
                <p><strong>Taxa COSIP/CIP (Fixa):</strong> ${currencyFormatter.format(custoDetalheEnergia.taxaFixaCOSIP)}</p>
                <p><strong>Taxas/Parcelamento Fixo:</strong> ${currencyFormatter.format(custoDetalheEnergia.taxas)}</p>
            `;
        }
    }
    if (tipo === 'total') {
        htmlResultado += `<span class="total-cost">TOTAL GERAL NO PER√çODO: ${currencyFormatter.format(custoPeriodo.custoTotal)}</span>`;
    } else {
        const totalCalculado = tipo === 'agua' ? custoPeriodo.custoAguaTotal : custoPeriodo.custoEnergiaTotal;
        htmlResultado += `<span class="total-cost">TOTAL CUSTO ${tipo.toUpperCase()}: ${currencyFormatter.format(totalCalculado)}</span>`;
    }
    resDetalhe.innerHTML = htmlResultado;
    mostrarNotificacao(`C√°lculo de custo detalhado para ${tipo} conclu√≠do no per√≠odo!`, 'success');
}
function carregarMetas() {
    metas.agua = parseFloat(getLocalData(DATA_KEYS.METAS_AGUA, 10));
    metas.energia = parseFloat(getLocalData(DATA_KEYS.METAS_ENERGIA, 150));
    document.getElementById('metaAgua').value = metas.agua;
    document.getElementById('metaEnergia').value = metas.energia;
}
function salvarMetas() {
    metas.agua = parseFloat(document.getElementById('metaAgua').value) || 0;
    metas.energia = parseFloat(document.getElementById('metaEnergia').value) || 0;
    setLocalData(DATA_KEYS.METAS_AGUA, metas.agua);
    setLocalData(DATA_KEYS.METAS_ENERGIA, metas.energia);
    atualizarProgressoMetas();
    aplicarFiltroDashboard();
}
function atualizarProgressoMetas() {
    carregarMetas(); 
    let data30DiasAtras = new Date();
    data30DiasAtras.setDate(data30DiasAtras.getDate() - 30);
    const dados30Dias = filtrarDadosPorData(historico, data30DiasAtras, new Date());
    const aguaConsumoRecente = dados30Dias.filter(h => h.tipo === 'agua').map(h => h.consumo).reduce((a, b) => a + b, 0);
    const energiaConsumoRecente = dados30Dias.filter(h => h.tipo === 'energia').map(h => h.consumo).reduce((a, b) => a + b, 0);
    const progressAgua = document.getElementById('progressAgua');
    let percentAgua = (metas.agua > 0) ? (aguaConsumoRecente / metas.agua) * 100 : 0;
    progressAgua.style.width = `${Math.min(100, percentAgua).toFixed(0)}%`;
    progressAgua.textContent = `${percentAgua.toFixed(1)}% (${aguaConsumoRecente.toFixed(2)} / ${metas.agua.toFixed(2)} m¬≥)`;
    progressAgua.classList.toggle('over', percentAgua > 100);
    const progressEnergia = document.getElementById('progressEnergia');
    let percentEnergia = (metas.energia > 0) ? (energiaConsumoRecente / metas.energia) * 100 : 0;
    progressEnergia.style.width = `${Math.min(100, percentEnergia).toFixed(0)}%`;
    progressEnergia.textContent = `${percentEnergia.toFixed(1)}% (${energiaConsumoRecente.toFixed(2)} / ${metas.energia.toFixed(2)} kWh)`;
    progressEnergia.classList.toggle('over', percentEnergia > 100);
}
function verificarAlertas() {}
function atualizarComparacao() {
    carregarMetas(); 
    let data30DiasAtras = new Date();
    data30DiasAtras.setDate(data30DiasAtras.getDate() - 30);
    const dados30Dias = filtrarDadosPorData(historico, data30DiasAtras, new Date());
    const aguaConsumoRecente = dados30Dias.filter(h => h.tipo === 'agua').map(h => h.consumo).reduce((a, b) => a + b, 0);
    const energiaConsumoRecente = dados30Dias.filter(h => h.tipo === 'energia').map(h => h.consumo).reduce((a, b) => a + b, 0);
    const mediaGeralAgua = metas.agua * 1.05; 
    const mediaGeralEnergia = metas.energia * 0.90; 
    document.getElementById('compSeuAgua').textContent = aguaConsumoRecente.toFixed(2) + ' m¬≥';
    document.getElementById('compMediaAgua').textContent = mediaGeralAgua.toFixed(2) + ' m¬≥';
    document.getElementById('compSeuEnergia').textContent = energiaConsumoRecente.toFixed(2) + ' kWh';
    document.getElementById('compMediaEnergia').textContent = mediaGeralEnergia.toFixed(2) + ' kWh';
    let analise = '';
    if (aguaConsumoRecente === 0 && energiaConsumoRecente === 0) {
      analise = "Nenhum registro encontrado para compara√ß√£o nos √∫ltimos 30 dias.";
    } else {
        if (aguaConsumoRecente < mediaGeralAgua * 0.95) {
          analise += 'üíß Seu consumo de √°gua no √∫ltimo m√™s est√° excelente, bem abaixo da m√©dia. Continue assim! ';
        } else if (aguaConsumoRecente > mediaGeralAgua * 1.05) {
          analise += 'üíß Aten√ß√£o! Seu consumo de √°gua no √∫ltimo m√™s est√° significativamente acima da m√©dia. Considere medidas de economia. ';
        } else {
          analise += 'üíß Seu consumo de √°gua no √∫ltimo m√™s est√° pr√≥ximo da m√©dia geral. ';
        }
        if (energiaConsumoRecente < mediaGeralEnergia * 0.95) {
          analise += '‚ö° Seu consumo de energia no √∫ltimo m√™s √© um modelo! Muito abaixo da m√©dia. ';
        } else if (energiaConsumoRecente > mediaGeralEnergia * 1.05) {
          analise += '‚ö° Seu consumo de energia no √∫ltimo m√™s est√° alto em rela√ß√£o √† m√©dia. Verifique aparelhos e h√°bitos. ';
        } else {
          analise += '‚ö° Seu consumo de energia no √∫ltimo m√™s est√° alinhado com a m√©dia geral. ';
        }
    }
    document.getElementById('analiseTexto').textContent = analise.trim();
}
function aplicarFiltroDashboard() {
    const dataInicioStr = document.getElementById('dataInicio').value;
    const dataFimStr = document.getElementById('dataFim').value;
    const dataInicio = new Date(dataInicioStr);
    const dataFim = new Date(dataFimStr);
    if (isNaN(dataInicio) || isNaN(dataFim)) {
        mostrarNotificacao('Por favor, defina um per√≠odo v√°lido (Data In√≠cio e Data Fim).', 'error');
        return;
    }
    if (dataInicio > dataFim) {
        mostrarNotificacao('A Data In√≠cio n√£o pode ser maior que a Data Fim.', 'error');
        return;
    }
    criarGraficos(dataInicio, dataFim);
}
function carregarTarifas() {
    tarifasMensais = getLocalData(DATA_KEYS.TARIFAS, {});
    const mesAtual = formatMonthToInput(new Date());
    if (!tarifasMensais[mesAtual]) {
        tarifasMensais[mesAtual] = DEFAULT_TARIFFS;
        setLocalData(DATA_KEYS.TARIFAS, tarifasMensais);
    }
    document.getElementById('filtroCustoDataInicio').value = formatDateToInput(getFirstDayOfMonth(mesAtual));
    document.getElementById('filtroCustoDataFim').value = formatDateToInput(new Date());
}
function atualizarDisplayTarifas(monthYear = null) {
    if (!monthYear) {
        monthYear = document.getElementById('selectTarifaMesAno').value;
    }
    const tarifasMes = getTarifasParaMes(monthYear);
    document.getElementById('displayFaixaMinimaAgua').textContent = tarifasMes.aguaFaixaMinima.toFixed(2) + ' m¬≥';
    document.getElementById('displayTaxaAguaFixa').textContent = currencyFormatter.format(tarifasMes.aguaFixa);
    document.getElementById('displayTarifaAguaExcedente').textContent = currencyFormatter.format(tarifasMes.aguaExcedente);
    document.getElementById('displayTaxaAguaParcelamento').textContent = currencyFormatter.format(tarifasMes.aguaParcelamento);
    document.getElementById('displayTaxaAguaMultas').textContent = currencyFormatter.format(tarifasMes.aguaMultas);
    document.getElementById('displayTarifaEnergiaKWh').textContent = currencyFormatter.format(tarifasMes.energiaKWh);
    document.getElementById('displayTarifaEnergiaBandeira').textContent = currencyFormatter.format(tarifasMes.energiaBandeira) + ' /kWh';
    document.getElementById('displayTaxaEnergiaFixa').textContent = currencyFormatter.format(tarifasMes.energiaFixaCOSIP);
    document.getElementById('displayTaxaEnergiaParcelamento').textContent = currencyFormatter.format(tarifasMes.energiaParcelamento);
    document.getElementById('displayTaxaEnergiaMultas').textContent = currencyFormatter.format(tarifasMes.energiaMultas);
}
function abrirModalEdicaoTarifas() {
    const mesAno = document.getElementById('selectTarifaMesAno').value;
    if (!mesAno) {
        mostrarNotificacao('Por favor, selecione um M√™s/Ano para editar as tarifas.', 'warning');
        return;
    }
    const tarifasAtuais = getTarifasParaMes(mesAno);
    const content = `
        <div class="form-group">
            <label>M√™s/Ano das Tarifas:</label>
            <input type="month" id="inputTarifaMesAno" value="${mesAno}" readonly>
        </div>
        <h3 style="margin-top: 10px;">üíß Configura√ß√µes de √Ågua</h3>
        <p style="font-size: 0.8em; margin-bottom: 10px; color: var(--secondary);">Estrutura baseada em Faixa M√≠nima + Tarifa Fixa + Excedente.</p>
        <div class="form-group">
            <label>Faixa M√≠nima (m¬≥)</label>
            <input type="number" id="inputAguaFaixa" step="0.01" required value="${tarifasAtuais.aguaFaixaMinima.toFixed(2)}">
        </div>
        <div class="form-group">
            <label>Tarifa M√≠nima Fixa (R$)</label>
            <input type="number" id="inputAguaFixa" step="0.01" required value="${tarifasAtuais.aguaFixa.toFixed(2)}">
        </div>
        <div class="form-group">
            <label>Tarifa por m¬≥ Excedente (R$)</label>
            <input type="number" id="inputAguaExcedente" step="0.01" required value="${tarifasAtuais.aguaExcedente.toFixed(2)}">
        </div>
        <div class="form-group">
            <label>Parcelamento/Juros (R$ - Valor Fixo)</label>
            <input type="number" id="inputAguaParcelamento" step="0.01" required value="${tarifasAtuais.aguaParcelamento.toFixed(2)}">
        </div>
        <div class="form-group">
            <label>Multas/Impostos (R$ - Valor Fixo)</label>
            <input type="number" id="inputAguaMultas" step="0.01" required value="${tarifasAtuais.aguaMultas.toFixed(2)}">
        </div>
        <h3 style="margin-top: 25px;">‚ö° Configura√ß√µes de Energia</h3>
        <div class="form-group">
            <label>Tarifa Base por kWh (TE + TUSD) (R$)</label>
            <input type="number" id="inputEnergiaKWh" step="0.00001" required value="${tarifasAtuais.energiaKWh.toFixed(5)}">
        </div>
        <div class="form-group">
            <label>Custo Adicional (Bandeira) por kWh (R$)</label>
            <input type="number" id="inputEnergiaBandeira" step="0.001" required value="${tarifasAtuais.energiaBandeira.toFixed(3)}">
        </div>
        <div class="form-group">
            <label>Taxa COSIP/CIP (R$ - Valor Fixo)</label>
            <input type="number" id="inputEnergiaFixaCOSIP" step="0.01" required value="${tarifasAtuais.energiaFixaCOSIP.toFixed(2)}">
        </div>
        <div class="form-group">
            <label>Parcelamento (R$ - Valor Fixo)</label>
            <input type="number" id="inputEnergiaParcelamento" step="0.01" required value="${tarifasAtuais.energiaParcelamento.toFixed(2)}">
        </div>
        <div class="form-group">
            <label>Multas/Juros/Outros (R$ - Valor Fixo)</label>
            <input type="number" id="inputEnergiaMultas" step="0.01" required value="${tarifasAtuais.energiaMultas.toFixed(2)}">
        </div>
    `;
    abrirModal(`‚úèÔ∏è Editar Custo para ${mesAno}`, content, (e) => {
        const mesParaSalvar = document.getElementById('inputTarifaMesAno').value;
        const novasTarifas = {
            aguaFaixaMinima: parseFloat(document.getElementById('inputAguaFaixa').value) || 0,
            aguaFixa: parseFloat(document.getElementById('inputAguaFixa').value) || 0,
            aguaExcedente: parseFloat(document.getElementById('inputAguaExcedente').value) || 0,
            aguaParcelamento: parseFloat(document.getElementById('inputAguaParcelamento').value) || 0,
            aguaMultas: parseFloat(document.getElementById('inputAguaMultas').value) || 0,
            energiaKWh: parseFloat(document.getElementById('inputEnergiaKWh').value) || 0,
            energiaBandeira: parseFloat(document.getElementById('inputEnergiaBandeira').value) || 0,
            energiaFixaCOSIP: parseFloat(document.getElementById('inputEnergiaFixaCOSIP').value) || 0,
            energiaParcelamento: parseFloat(document.getElementById('inputEnergiaParcelamento').value) || 0,
            energiaMultas: parseFloat(document.getElementById('inputEnergiaMultas').value) || 0,
        };
        tarifasMensais[mesParaSalvar] = novasTarifas;
        setLocalData(DATA_KEYS.TARIFAS, tarifasMensais);
        atualizarDisplayTarifas(mesParaSalvar);
        aplicarFiltroDashboard();
        mostrarNotificacao(`Tarifas para ${mesParaSalvar} salvas com sucesso!`, 'success');
    }, 'Salvar Tarifas');
}
function setupEventListeners() {
    document.getElementById('aguaForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('energiaForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('leituraAtualAgua').addEventListener('input', () => atualizarTotal('agua'));
    document.getElementById('leituraAtualEnergia').addEventListener('input', () => atualizarTotal('energia'));
    document.getElementById('spreadsheetLinkAnchor').href = GOOGLE_SHEET_EDIT_URL;
}
async function loadInitialData() {
    loadTheme();
    carregarMetas();
    historicoLocal = getLocalData(DATA_KEYS.HISTORICO, []); // Carrega backup local
    carregarTarifas(); 
    await carregarTotais(); // Carrega totais (preferencialmente do Sheets)
    await carregarHistorico(); // Carrega o hist√≥rico (preferencialmente do Sheets)
    
    const lastNome = getLocalData('lastNome', '');
    const lastMatricula = getLocalData('lastMatricula', '');
    document.querySelectorAll('input[name="nome"]').forEach(input => input.value = lastNome);
    document.querySelectorAll('input[name="matricula"]').forEach(input => input.value = lastMatricula);
    const hoje = new Date();
    dashboardDataFim = new Date();
    dashboardDataInicio = new Date();
    dashboardDataInicio.setDate(dashboardDataFim.getDate() - 30);
    document.getElementById('dataInicio').value = formatDateToInput(dashboardDataInicio);
    document.getElementById('dataFim').value = formatDateToInput(dashboardDataFim);
    document.getElementById('agregacao').value = 'diario';
    document.getElementById('filtroPeriodo').value = '30dias';
    document.getElementById('filtroTipo').value = 'todos';
    const mesAtual = formatMonthToInput(hoje);
    document.getElementById('selectTarifaMesAno').value = mesAtual;
    document.getElementById('filtroCustoDataInicio').value = formatDateToInput(getFirstDayOfMonth(mesAtual));
    document.getElementById('filtroCustoDataFim').value = formatDateToInput(hoje);
}
window.onload = function() {
    loadInitialData();
    setupEventListeners();
    document.getElementById('leituraAtualAgua').value = totalAnteriorAgua.toFixed(2);
    document.getElementById('leituraAtualEnergia').value = totalAnteriorEnergia.toFixed(2);
    aplicarFiltrosHistorico();
    atualizarDisplayTarifas();
};
</script>
</body>
</html>
