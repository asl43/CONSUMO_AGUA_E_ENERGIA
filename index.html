<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Consumo - √Ågua e Energia</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  :root {
    --primary: #667eea;
    --secondary: #764ba2;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg-light: #ffffff;
    --bg-dark: #1a1a2e;
    --text-light: #333333;
    --text-dark: #ffffff;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary)100%);
    min-height: 100vh;
    padding: 20px;
    position: relative;
    overflow-x: hidden;
    transition: all 0.3s;
  }

  body.dark-mode {
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
  }

  body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
    pointer-events: none;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
  }

  h1 {
    color: white;
    font-size: clamp(24px, 5vw, 36px);
    font-weight: 700;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    animation: slideDown 0.6s ease-out;
  }

  .theme-toggle {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s;
  }

  .theme-toggle:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .main-tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 30px;
    animation: fadeIn 0.8s ease-out 0.2s both;
    flex-wrap: wrap;
  }

  .tab-button {
    flex: 1;
    min-width: 120px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.2);
    padding: 16px 20px;
    border-radius: 16px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .tab-button:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }

  .tab-button.active {
    background: white;
    color: var(--primary);
    border-color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .main-content {
    display: none;
  }

  .main-content.active {
    display: grid;
    gap: 20px;
    animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .form-card {
    background: white;
    padding: 30px;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }

  body.dark-mode .form-card {
    background: #16213e;
    color: var(--text-dark);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 20px;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
  }

  .stat-card .label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 8px;
  }

  .stat-card .value {
    font-size: 28px;
    font-weight: 700;
  }

  .stat-card.warning {
    background: linear-gradient(135deg, var(--warning) 0%, #f97316 100%);
  }

  .stat-card.success {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
  }

  .chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
    background: white;
    padding: 20px;
    border-radius: 16px;
  }

  body.dark-mode .chart-container {
    background: #0f3460;
  }

  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
  }

  body.dark-mode label {
    color: var(--text-dark);
  }

  input, select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s;
    background: #f8f9fa;
  }

  body.dark-mode input,
  body.dark-mode select {
    background: #0f3460;
    border-color: #1a1a2e;
    color: white;
  }

  input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    background: white;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  }

  body.dark-mode input:focus,
  body.dark-mode select:focus {
    background: #16213e;
  }

  input:read-only {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    cursor: not-allowed;
    font-weight: 600;
    color: var(--primary);
  }

  .button-group {
    display: grid;
    gap: 12px;
    margin-top: 24px;
  }

  button, .btn {
    padding: 16px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
  }

  .btn-secondary {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
  }

  body.dark-mode .btn-secondary {
    background: #0f3460;
    color: white;
  }

  .btn-secondary:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  .btn-danger {
    background: var(--danger);
    color: white;
  }

  .mensagem {
    text-align: center;
    font-weight: 600;
    margin-top: 16px;
    padding: 12px;
    border-radius: 8px;
    animation: fadeIn 0.3s;
  }

  .mensagem.success {
    background: #d4edda;
    color: #155724;
  }

  .mensagem.error {
    background: #f8d7da;
    color: #721c24;
  }

  .history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .history-table th,
  .history-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
  }

  body.dark-mode .history-table th,
  body.dark-mode .history-table td {
    border-color: #1a1a2e;
  }

  .history-table th {
    background: #f8f9fa;
    font-weight: 600;
  }

  body.dark-mode .history-table th {
    background: #0f3460;
  }

  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 1000;
    animation: slideInRight 0.3s;
    max-width: 300px;
    border-left: 4px solid;
  }

  .notification.success {
    border-color: var(--success);
  }
  .notification.warning {
    border-color: var(--warning);
  }
  .notification.error {
    border-color: var(--danger);
  }

  @keyframes slideInRight {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .goal-progress {
    margin: 20px 0;
  }

  .progress-bar {
    width: 100%;
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success) 0%, #059669 100%);
    transition: width 0.5s;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
    white-space: nowrap; /* Impede que o texto quebre */
    padding: 0 10px;
  }

  .progress-fill.over {
    background: linear-gradient(90deg, var(--danger) 0%, #dc2626 100%);
  }

  .comparison-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  .comparison-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
  }

  body.dark-mode .comparison-card {
    background: #0f3460;
  }

  .comparison-card .icon {
    font-size: 40px;
    margin-bottom: 10px;
  }

  .comparison-card .value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
  }

  body.dark-mode .comparison-card .value {
    color: #64b5f6;
  }

  .export-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin: 20px 0;
  }

  @media (max-width: 768px) {
    body {
      padding: 12px;
    }

    .form-card {
      padding: 20px;
    }

    .main-tabs {
      gap: 8px;
    }

    .tab-button {
      padding: 12px;
      font-size: 14px;
      min-width: 100px;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .chart-container {
      height: 250px;
    }
  }

  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }

  .loading {
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üíß‚ö° Registro de Consumo</h1>
    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
  </div>

  <div class="main-tabs">
    <button class="tab-button active" onclick="showMainTab('registro')">
      <span>üìù Registro</span>
    </button>
    <button class="tab-button" onclick="showMainTab('dashboard')">
      <span>üìä Dashboard</span>
    </button>
    <button class="tab-button" onclick="showMainTab('historico')">
      <span>üìã Hist√≥rico</span>
    </button>
    <button class="tab-button" onclick="showMainTab('metas')">
      <span>üéØ Metas</span>
    </button>
    <button class="tab-button" onclick="showMainTab('comparacao')">
      <span>üë• Compara√ß√£o</span>
    </button>
  </div>

  <div id="registro" class="main-content active">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Total √Ågua</div>
        <div class="value" id="displayTotalAgua">0.00 m¬≥</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Energia</div>
        <div class="value" id="displayTotalEnergia">0.00 kWh</div>
      </div>
    </div>

    <div class="form-card">
      <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
        <button class="tab-button active" style="flex: 1; min-width: 150px;" onclick="showFormTab('agua', this)">
          üíß √Ågua
        </button>
        <button class="tab-button" style="flex: 1; min-width: 150px;" onclick="showFormTab('energia', this)">
          ‚ö° Energia
        </button>
      </div>

      <div id="formAgua" class="form-content">
        <form id="aguaForm">
          <div class="form-group">
            <label>Nome</label>
            <input type="text" name="nome" required placeholder="Digite seu nome">
          </div>

          <div class="form-group">
            <label>Matr√≠cula</label>
            <input type="text" name="matricula" required placeholder="Digite sua matr√≠cula">
          </div>

          <div class="form-group">
            <label>Data e Hora</label>
            <input type="datetime-local" name="dataHora" required>
          </div>

          <div class="form-group">
            <label>Consumo de √Ågua (m¬≥)</label>
            <input type="number" name="consumoAgua" id="consumoAgua" step="0.01" required placeholder="0.00">
          </div>

          <div class="form-group">
            <label>Novo Total (m¬≥)</label>
            <input type="number" name="totalAgua" id="totalAgua" step="0.01" readonly>
          </div>

          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="definirInicio('agua')">
              üîÑ Redefinir Total Inicial
            </button>
          </div>

          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px dashed #e0e0e0;">
            <h3 style="margin-bottom: 16px;">üìù Campos Adicionais (Opcional)</h3>
            <div class="form-group">
              <label>Campo Extra 1</label>
              <input type="text" name="extra1" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label>Campo Extra 2</label>
              <input type="text" name="extra2" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label>Campo Extra 3</label>
              <input type="text" name="extra3" placeholder="Opcional">
            </div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-primary">‚úÖ Enviar Registro de √Ågua</button>
          </div>
          <p class="mensagem" id="msgAgua"></p>
        </form>
      </div>

      <div id="formEnergia" class="form-content" style="display: none;">
        <form id="energiaForm">
          <div class="form-group">
            <label>Nome</label>
            <input type="text" name="nome" required placeholder="Digite seu nome">
          </div>

          <div class="form-group">
            <label>Matr√≠cula</label>
            <input type="text" name="matricula" required placeholder="Digite sua matr√≠cula">
          </div>

          <div class="form-group">
            <label>Data e Hora</label>
            <input type="datetime-local" name="dataHora" required>
          </div>

          <div class="form-group">
            <label>Consumo de Energia (kWh)</label>
            <input type="number" name="consumoEnergia" id="consumoEnergia" step="0.01" required placeholder="0.00">
          </div>

          <div class="form-group">
            <label>Novo Total (kWh)</label>
            <input type="number" name="totalEnergia" id="totalEnergia" step="0.01" readonly>
          </div>

          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="definirInicio('energia')">
              üîÑ Redefinir Total Inicial
            </button>
          </div>

          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px dashed #e0e0e0;">
            <h3 style="margin-bottom: 16px;">üìù Campos Adicionais (Opcional)</h3>
            <div class="form-group">
              <label>Campo Extra 1</label>
              <input type="text" name="extra1" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label>Campo Extra 2</label>
              <input type="text" name="extra2" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label>Campo Extra 3</label>
              <input type="text" name="extra3" placeholder="Opcional">
            </div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-primary">‚úÖ Enviar Registro de Energia</button>
          </div>
          <p class="mensagem" id="msgEnergia"></p>
        </form>
      </div>
    </div>
  </div>

  <div id="dashboard" class="main-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Consumo √Ågua (M√™s)</div>
        <div class="value" id="aguaMes">0.00 m¬≥</div>
      </div>
      <div class="stat-card">
        <div class="label">Consumo Energia (M√™s)</div>
        <div class="value" id="energiaMes">0.00 kWh</div>
      </div>
      <div class="stat-card success">
        <div class="label">Economia √Ågua</div>
        <div class="value" id="economiaAgua">0%</div>
      </div>
      <div class="stat-card warning">
        <div class="label">Custo Estimado</div>
        <div class="value" id="custoTotal">R$ 0,00</div>
      </div>
    </div>

    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üìà Gr√°fico de Consumo (√öltimos 6 Registros)</h2>
      <div class="chart-container">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>

    <div class="form-card" style="margin-top: 20px;">
      <h2 style="margin-bottom: 20px;">üìä Distribui√ß√£o por Tipo (Total)</h2>
      <div class="chart-container" style="height: 250px;">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>

  <div id="historico" class="main-content">
    <div class="form-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2>üìã Hist√≥rico de Registros</h2>
        <div class="export-buttons" style="max-width: 400px;">
          <button class="btn btn-success" onclick="exportarCSV()">üì• CSV</button>
          <button class="btn btn-danger" onclick="exportarPDF()">üìÑ PDF</button>
        </div>
      </div>
      
      <div class="form-group">
        <label>Filtrar por Tipo</label>
        <select id="filtroTipo" onchange="filtrarHistorico()">
          <option value="todos">Todos</option>
          <option value="agua">√Ågua</option>
          <option value="energia">Energia</option>
        </select>
      </div>

      <div style="overflow-x: auto;">
        <table class="history-table">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Tipo</th>
              <th>Nome</th>
              <th>Consumo</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="historicoBody">
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px;">Nenhum registro encontrado</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="metas" class="main-content">
    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üéØ Definir Metas de Consumo</h2>
      
      <div class="form-group">
        <label>Meta de √Ågua Mensal (m¬≥)</label>
        <input type="number" id="metaAgua" step="0.01" placeholder="Ex: 10.00" onchange="salvarMetas()">
      </div>

      <div class="form-group">
        <label>Meta de Energia Mensal (kWh)</label>
        <input type="number" id="metaEnergia" step="0.01" placeholder="Ex: 150.00" onchange="salvarMetas()">
      </div>

      <div class="goal-progress">
        <h3 style="margin-bottom: 10px;">Progresso - √Ågua (Consumo Recente)</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressAgua" style="width: 0%;">0% (0.00 / 0.00 m¬≥)</div>
        </div>
      </div>

      <div class="goal-progress">
        <h3 style="margin-bottom: 10px;">Progresso - Energia (Consumo Recente)</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressEnergia" style="width: 0%;">0% (0.00 / 0.00 kWh)</div>
        </div>
      </div>
    </div>
  </div>

  <div id="comparacao" class="main-content">
    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üë• Compara√ß√£o com M√©dia (Simulada)</h2>
      
      <div class="comparison-section">
        <div class="comparison-card">
          <div class="icon">üíß</div>
          <div class="label">Seu Consumo (Recente)</div>
          <div class="value" id="compSeuAgua">0.00 m¬≥</div>
        </div>
        <div class="comparison-card">
          <div class="icon">üìä</div>
          <div class="label">M√©dia Geral (Simulada)</div>
          <div class="value" id="compMediaAgua">0.00 m¬≥</div>
        </div>
        <div class="comparison-card">
          <div class="icon">‚ö°</div>
          <div class="label">Sua Energia (Recente)</div>
          <div class="value" id="compSeuEnergia">0.00 kWh</div>
        </div>
        <div class="comparison-card">
          <div class="icon">üìä</div>
          <div class="label">M√©dia Geral (Simulada)</div>
          <div class="value" id="compMediaEnergia">0.00 kWh</div>
        </div>
      </div>

      <div class="form-card" style="margin-top: 20px; background: #f8f9fa;">
        <h3 style="margin-bottom: 15px;">üí° An√°lise</h3>
        <p id="analiseTexto">Configure suas metas e registre consumos para ver a an√°lise comparativa.</p>
      </div>
    </div>
  </div>
</div>

<script>
// CONFIGURA√á√ïES GLOBAIS
const scriptURL = "https://script.google.com/macros/s/AKfycbyfpjvwFpYmruXMHYlOBu6_XY_I1U0qRRGapmXU8SgmyvVdNVK2iCJwp-fxn58ipx1U/exec";

const DATA_KEYS = {
    TOTAL_AGUA: 'totalAnteriorAgua',
    TOTAL_ENERGIA: 'totalAnteriorEnergia',
    HISTORICO: 'historico',
    METAS_AGUA: 'metaAgua',
    METAS_ENERGIA: 'metaEnergia',
    THEME: 'theme'
};

let totalAnteriorAgua = 0;
let totalAnteriorEnergia = 0;
let historico = [];
let metas = { agua: 10, energia: 150 };
let chartInstance = null;
let pieChartInstance = null;

// --- FUN√á√ïES DE UTILITY (LOCAL STORAGE & UX) ---

function getLocalData(key, defaultValue = null) {
    const data = localStorage.getItem(key);
    try {
        const parsed = data ? JSON.parse(data) : defaultValue;
        // Se for um n√∫mero (como os totais e metas), garantir que seja float
        if (typeof parsed === 'string' && !isNaN(parsed)) {
            return parseFloat(parsed);
        }
        return parsed;
    } catch (e) {
        // Retorna o valor direto se a tentativa de parse JSON falhar
        return data || defaultValue;
    }
}

function setLocalData(key, value) {
    localStorage.setItem(key, JSON.stringify(value));
}

function mostrarMensagem(elemento, texto, tipo) {
  elemento.textContent = texto;
  elemento.className = `mensagem ${tipo}`;
  setTimeout(() => {
    elemento.textContent = '';
    elemento.className = 'mensagem';
  }, 5000);
}

function mostrarNotificacao(mensagem, tipo = 'warning') {
  const notif = document.createElement('div');
  notif.className = `notification ${tipo}`;
  const icon = tipo === 'success' ? '‚úÖ Sucesso' : tipo === 'error' ? '‚ùå Erro' : '‚ö†Ô∏è Alerta';
  notif.innerHTML = `<strong>${icon}</strong><p>${mensagem}</p>`;
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideInRight 0.3s reverse';
    setTimeout(() => notif.remove(), 300);
  }, 5000);
}

// --- FUN√á√ïES DE TEMA ---

function loadTheme() {
    const theme = getLocalData(DATA_KEYS.THEME);
    if (theme === 'dark') {
      document.body.classList.add('dark-mode');
      document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
    } else {
      document.querySelector('.theme-toggle').textContent = 'üåô';
    }
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  const icon = document.querySelector('.theme-toggle');
  icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  setLocalData(DATA_KEYS.THEME, isDark ? 'dark' : 'light');
}

// --- FUN√á√ïES DE NAVEGA√á√ÉO E TOTAIS ---

function showMainTab(tabId) {
  document.querySelectorAll('.main-content').forEach(div => div.classList.remove('active'));
  document.querySelectorAll('.main-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  
  // Encontrar o bot√£o clicado (target)
  const clickedButton = Array.from(document.querySelectorAll('.main-tabs .tab-button'))
                            .find(btn => btn.getAttribute('onclick').includes(`'${tabId}'`));
  if(clickedButton) clickedButton.classList.add('active');

  // A√ß√µes espec√≠ficas de tab
  if (tabId === 'dashboard') {
    setTimeout(criarGraficos, 100);
  } else if (tabId === 'historico') {
    carregarHistorico();
  } else if (tabId === 'metas') {
    carregarMetas(); // Garantir que os inputs estejam preenchidos
    atualizarProgressoMetas();
  } else if (tabId === 'comparacao') {
    atualizarComparacao();
  }
}

function showFormTab(tipo, button) {
  document.querySelectorAll('.form-content').forEach(div => div.style.display = 'none');
  document.getElementById(`form${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).style.display = 'block';
  
  const buttons = document.querySelectorAll('.form-card > div:first-child .tab-button');
  buttons.forEach(btn => btn.classList.remove('active'));
  button.classList.add('active');
}

async function carregarTotais() {
    // 1. Carregar valores locais de backup
    totalAnteriorAgua = getLocalData(DATA_KEYS.TOTAL_AGUA, 0);
    totalAnteriorEnergia = getLocalData(DATA_KEYS.TOTAL_ENERGIA, 0);

    // 2. Tentar carregar do Google Sheets
    try {
        const res = await fetch(`${scriptURL}?action=getLast`);
        const data = await res.json();
        
        // Se o Sheets retornar valores v√°lidos, sobrescreva e salve no local
        if (data.agua !== undefined && !isNaN(parseFloat(data.agua))) {
            totalAnteriorAgua = parseFloat(data.agua);
            setLocalData(DATA_KEYS.TOTAL_AGUA, totalAnteriorAgua);
        }
        if (data.energia !== undefined && !isNaN(parseFloat(data.energia))) {
            totalAnteriorEnergia = parseFloat(data.energia);
            setLocalData(DATA_KEYS.TOTAL_ENERGIA, totalAnteriorEnergia);
        }
    } catch (err) {
        console.warn("Erro ao carregar totais do servidor. Usando dados locais.", err);
    }
    
    // 3. Atualizar a UI
    const totalAguaEl = document.getElementById("totalAgua");
    const totalEnergiaEl = document.getElementById("totalEnergia");
    
    totalAguaEl.value = totalAnteriorAgua.toFixed(2);
    totalEnergiaEl.value = totalAnteriorEnergia.toFixed(2);
    document.getElementById("displayTotalAgua").textContent = totalAnteriorAgua.toFixed(2) + " m¬≥";
    document.getElementById("displayTotalEnergia").textContent = totalAnteriorEnergia.toFixed(2) + " kWh";
    
    // 4. Recalcular o novo total caso o campo de consumo j√° tenha sido preenchido
    atualizarTotal('agua');
    atualizarTotal('energia');

    verificarAlertas();
}

function atualizarTotal(tipo) {
  const inputConsumo = document.getElementById(`consumo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
  const inputTotal = document.getElementById(`total${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
  
  const consumo = parseFloat(inputConsumo.value) || 0;
  const totalAnterior = tipo === 'agua' ? totalAnteriorAgua : totalAnteriorEnergia;
  
  const novoTotal = (consumo + totalAnterior);
  inputTotal.value = novoTotal.toFixed(2);
}

function definirInicio(tipo) {
  const label = tipo === 'agua' ? '√Ågua (m¬≥)' : 'Energia (kWh)';
  const novoValorStr = prompt(`Digite o novo valor do total inicial acumulado de ${label}:`);
  
  if (novoValorStr !== null) {
    const novoValor = parseFloat(novoValorStr);
    
    if (!isNaN(novoValor) && novoValor >= 0) {
      const valorFormatado = novoValor.toFixed(2);
      
      if (tipo === 'agua') {
        totalAnteriorAgua = novoValor;
        document.getElementById("totalAgua").value = valorFormatado;
        document.getElementById("displayTotalAgua").textContent = valorFormatado + " m¬≥";
        setLocalData(DATA_KEYS.TOTAL_AGUA, totalAnteriorAgua);
      } else {
        totalAnteriorEnergia = novoValor;
        document.getElementById("totalEnergia").value = valorFormatado;
        document.getElementById("displayTotalEnergia").textContent = valorFormatado + " kWh";
        setLocalData(DATA_KEYS.TOTAL_ENERGIA, totalAnteriorEnergia);
      }
      
      atualizarTotal(tipo);
      mostrarNotificacao(`Total Inicial de ${tipo.charAt(0).toUpperCase() + tipo.slice(1)} redefinido para ${valorFormatado}.`, 'success');

    } else {
      mostrarNotificacao('Valor inv√°lido. Por favor, digite um n√∫mero n√£o negativo.', 'error');
    }
  }
}

// --- FUN√á√ïES DE FORMUL√ÅRIO ---

async function handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const tipo = form.id === 'aguaForm' ? 'agua' : 'energia';
    const msg = document.getElementById(`msg${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    const btn = form.querySelector('button[type="submit"]');
    
    btn.classList.add('loading');
    btn.disabled = true;
    
    const formData = new FormData(form);
    
    try {
        await fetch(scriptURL, { method: 'POST', body: formData });
        mostrarMensagem(msg, `‚úÖ Dados de ${tipo.charAt(0).toUpperCase() + tipo.slice(1)} enviados com sucesso!`, "success");
        
        // Atualizar hist√≥rico local
        historico.push({
            data: formData.get('dataHora'),
            tipo: tipo === 'agua' ? '√°gua' : 'energia',
            nome: formData.get('nome'),
            consumo: parseFloat(formData.get(`consumo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`)),
            total: parseFloat(formData.get(`total${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`))
        });
        setLocalData(DATA_KEYS.HISTORICO, historico);
        
        form.reset();
        await carregarTotais(); // Atualiza o totalAnterior e a UI com o novo total
        
    } catch (err) {
        console.error("Erro ao enviar dados:", err);
        mostrarMensagem(msg, "‚ùå Erro ao enviar dados. Tente novamente.", "error");
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
}

// --- FUN√á√ïES DE DASHBOARD/GR√ÅFICOS ---

function criarGraficos() {
    // Pegar os √∫ltimos 6 registros de consumo (√°gua e energia separadamente)
    const aguaRecords = historico.filter(h => h.tipo === '√°gua').slice(-6);
    const energiaRecords = historico.filter(h => h.tipo === 'energia').slice(-6);

    const labels = aguaRecords.map(h => new Date(h.data).toLocaleDateString()).slice(-6);
    const aguaData = aguaRecords.map(h => h.consumo);
    const energiaData = energiaRecords.map(h => h.consumo);
    
    // Garante que o label de data corresponda a um registro, mesmo que tenha poucos
    // Apenas usa o √≠ndice para registros com menos de 6
    const chartLabels = labels.length > 0 ? labels : [1, 2, 3, 4, 5, 6].slice(0, Math.max(aguaData.length, energiaData.length));
    
    // Gr√°fico de Linha (Consumo Recente)
    const ctx = document.getElementById('consumptionChart');
    if (chartInstance) chartInstance.destroy();
    
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartLabels,
        datasets: [
          {
            label: '√Ågua (m¬≥)',
            data: aguaData,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4
          },
          {
            label: 'Energia (kWh)',
            data: energiaData,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
        }
      }
    });
    
    // Gr√°fico de Pizza (Total Geral)
    const ctxPie = document.getElementById('pieChart');
    if (pieChartInstance) pieChartInstance.destroy();
    
    const totalAgua = historico.filter(h => h.tipo === '√°gua').reduce((a, b) => a + b.consumo, 0);
    const totalEnergia = historico.filter(h => h.tipo === 'energia').reduce((a, b) => a + b.consumo, 0);

    // Estat√≠sticas do M√™s (usando os √∫ltimos 6 registros como "m√™s")
    const aguaMes = aguaData.reduce((a, b) => a + b, 0);
    const energiaMes = energiaData.reduce((a, b) => a + b, 0);
    
    pieChartInstance = new Chart(ctxPie, {
      type: 'doughnut',
      data: {
        labels: ['√Ågua', 'Energia'],
        datasets: [{
          data: [totalAgua, totalEnergia],
          backgroundColor: ['#667eea', '#f59e0b']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
    
    // Atualizar estat√≠sticas
    document.getElementById('aguaMes').textContent = aguaMes.toFixed(2) + ' m¬≥';
    document.getElementById('energiaMes').textContent = energiaMes.toFixed(2) + ' kWh';
    
    const metaAgua = metas.agua || 10;
    const economiaCalc = Math.max(0, 100 - (aguaMes / metaAgua) * 100);
    document.getElementById('economiaAgua').textContent = economiaCalc.toFixed(0) + '%';
    
    const custoAgua = aguaMes * 5.5; // R$ por m¬≥ (simulado)
    const custoEnergia = energiaMes * 0.85; // R$ por kWh (simulado)
    document.getElementById('custoTotal').textContent = 'R$ ' + (custoAgua + custoEnergia).toFixed(2);
}

// --- FUN√á√ïES DE HIST√ìRICO ---

function carregarHistorico() {
  historico = getLocalData(DATA_KEYS.HISTORICO, []);
  // Inverte o hist√≥rico para mostrar o mais recente primeiro
  historico.sort((a, b) => new Date(b.data) - new Date(a.data)); 
  filtrarHistorico();
}

function filtrarHistorico() {
  const filtro = document.getElementById('filtroTipo').value;
  const tbody = document.getElementById('historicoBody');
  
  let dadosFiltrados = historico;
  if (filtro !== 'todos') {
    dadosFiltrados = historico.filter(h => h.tipo === filtro);
  }
  
  if (dadosFiltrados.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Nenhum registro encontrado</td></tr>';
    return;
  }
  
  tbody.innerHTML = dadosFiltrados.map(item => `
    <tr>
      <td>${new Date(item.data).toLocaleString('pt-BR')}</td>
      <td>${item.tipo === '√°gua' ? 'üíß √Ågua' : '‚ö° Energia'}</td>
      <td>${item.nome}</td>
      <td>${parseFloat(item.consumo).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}</td>
      <td>${parseFloat(item.total).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}</td>
    </tr>
  `).join('');
}

function exportarCSV() {
    const csv = ['"Data/Hora","Tipo","Nome","Consumo","Total"'];
    historico.forEach(item => {
        csv.push(`"${new Date(item.data).toLocaleString('pt-BR')}","${item.tipo}","${item.nome}","${parseFloat(item.consumo).toFixed(2)}","${parseFloat(item.total).toFixed(2)}"`);
    });
    
    const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `historico_consumo_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    mostrarNotificacao('Arquivo CSV exportado com sucesso!', 'success');
}

function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.text("Registro de Consumo - √Ågua e Energia", 14, 20);
    doc.setFontSize(10);
    doc.text(`Total de Registros: ${historico.length}`, 14, 28);
    doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 34);

    const tableData = historico.map(item => [
        new Date(item.data).toLocaleString('pt-BR'),
        item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1),
        item.nome,
        `${parseFloat(item.consumo).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}`,
        `${parseFloat(item.total).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}`,
    ]);

    doc.autoTable({
        head: [['Data/Hora', 'Tipo', 'Nome', 'Consumo', 'Total']],
        body: tableData,
        startY: 40,
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [102, 126, 234] }
    });
    
    doc.save(`historico_consumo_${new Date().toISOString().split('T')[0]}.pdf`);
    mostrarNotificacao('Arquivo PDF exportado com sucesso!', 'success');
}


// --- FUN√á√ïES DE METAS ---

function carregarMetas() {
    metas.agua = getLocalData(DATA_KEYS.METAS_AGUA, 10);
    metas.energia = getLocalData(DATA_KEYS.METAS_ENERGIA, 150);
    document.getElementById('metaAgua').value = metas.agua;
    document.getElementById('metaEnergia').value = metas.energia;
}

function salvarMetas() {
    metas.agua = parseFloat(document.getElementById('metaAgua').value) || 0;
    metas.energia = parseFloat(document.getElementById('metaEnergia').value) || 0;
    setLocalData(DATA_KEYS.METAS_AGUA, metas.agua);
    setLocalData(DATA_KEYS.METAS_ENERGIA, metas.energia);
    atualizarProgressoMetas();
}

function atualizarProgressoMetas() {
    carregarMetas(); 

    // Usar consumo recente (√∫ltimos 6 registros como simula√ß√£o de "m√™s")
    const aguaConsumoRecente = historico.filter(h => h.tipo === '√°gua').slice(-6).map(h => h.consumo).reduce((a, b) => a + b, 0);
    const energiaConsumoRecente = historico.filter(h => h.tipo === 'energia').slice(-6).map(h => h.consumo).reduce((a, b) => a + b, 0);

    // √Ågua
    const progressAgua = document.getElementById('progressAgua');
    let percentAgua = (metas.agua > 0) ? (aguaConsumoRecente / metas.agua) * 100 : 0;

    progressAgua.style.width = `${Math.min(100, percentAgua).toFixed(0)}%`;
    progressAgua.textContent = `${percentAgua.toFixed(1)}% (${aguaConsumoRecente.toFixed(2)} / ${metas.agua.toFixed(2)} m¬≥)`;
    progressAgua.classList.toggle('over', percentAgua > 100);

    // Energia
    const progressEnergia = document.getElementById('progressEnergia');
    let percentEnergia = (metas.energia > 0) ? (energiaConsumoRecente / metas.energia) * 100 : 0;

    progressEnergia.style.width = `${Math.min(100, percentEnergia).toFixed(0)}%`;
    progressEnergia.textContent = `${percentEnergia.toFixed(1)}% (${energiaConsumoRecente.toFixed(2)} / ${metas.energia.toFixed(2)} kWh)`;
    progressEnergia.classList.toggle('over', percentEnergia > 100);
}

function verificarAlertas() {
    const metaAgua = metas.agua || 10;
    const metaEnergia = metas.energia || 150;
    
    if (totalAnteriorAgua > metaAgua * 0.9 && totalAnteriorAgua < metaAgua * 1.1) {
      mostrarNotificacao(`Voc√™ atingiu ${((totalAnteriorAgua/metaAgua)*100).toFixed(0)}% da sua meta de √°gua!`, 'warning');
    }
    if (totalAnteriorAgua >= metaAgua * 1.1) {
      mostrarNotificacao(`üö® Aten√ß√£o! Voc√™ excedeu sua meta de √°gua em ${(totalAnteriorAgua - metaAgua).toFixed(2)} m¬≥!`, 'error');
    }
    
    if (totalAnteriorEnergia > metaEnergia * 0.9 && totalAnteriorEnergia < metaEnergia * 1.1) {
      mostrarNotificacao(`Voc√™ atingiu ${((totalAnteriorEnergia/metaEnergia)*100).toFixed(0)}% da sua meta de energia!`, 'warning');
    }
    if (totalAnteriorEnergia >= metaEnergia * 1.1) {
      mostrarNotificacao(`üö® Aten√ß√£o! Voc√™ excedeu sua meta de energia em ${(totalAnteriorEnergia - metaEnergia).toFixed(2)} kWh!`, 'error');
    }
}


// --- FUN√á√ïES DE COMPARA√á√ÉO ---

function atualizarComparacao() {
    carregarMetas(); 

    // Consumo Recente (√∫ltimos 6)
    const aguaConsumoRecente = historico.filter(h => h.tipo === '√°gua').slice(-6).map(h => h.consumo).reduce((a, b) => a + b, 0);
    const energiaConsumoRecente = historico.filter(h => h.tipo === 'energia').slice(-6).map(h => h.consumo).reduce((a, b) => a + b, 0);
    
    // M√©dia geral simulada (baseada na meta e com um pequeno desvio)
    const mediaGeralAgua = metas.agua * 1.05; // 5% acima da meta como m√©dia "social"
    const mediaGeralEnergia = metas.energia * 0.90; // 10% abaixo da meta como m√©dia "social"
    
    // Atualizar cards
    document.getElementById('compSeuAgua').textContent = aguaConsumoRecente.toFixed(2) + ' m¬≥';
    document.getElementById('compMediaAgua').textContent = mediaGeralAgua.toFixed(2) + ' m¬≥';
    document.getElementById('compSeuEnergia').textContent = energiaConsumoRecente.toFixed(2) + ' kWh';
    document.getElementById('compMediaEnergia').textContent = mediaGeralEnergia.toFixed(2) + ' kWh';
    
    // An√°lise
    let analise = '';
    
    if (aguaConsumoRecente < mediaGeralAgua * 0.95) {
      analise += 'üíß Seu consumo de √°gua est√° excelente, bem abaixo da m√©dia. Continue assim! ';
    } else if (aguaConsumoRecente > mediaGeralAgua * 1.05) {
      analise += 'üíß Aten√ß√£o! Seu consumo de √°gua est√° significativamente acima da m√©dia. Considere medidas de economia. ';
    } else {
      analise += 'üíß Seu consumo de √°gua est√° pr√≥ximo da m√©dia geral. ';
    }
    
    if (energiaConsumoRecente < mediaGeralEnergia * 0.95) {
      analise += '‚ö° Seu consumo de energia √© um modelo! Muito abaixo da m√©dia. ';
    } else if (energiaConsumoRecente > mediaGeralEnergia * 1.05) {
      analise += '‚ö° Seu consumo de energia est√° alto em rela√ß√£o √† m√©dia. Verifique aparelhos e h√°bitos. ';
    } else {
      analise += '‚ö° Seu consumo de energia est√° alinhado com a m√©dia geral. ';
    }
    
    document.getElementById('analiseTexto').textContent = analise.trim() || "Nenhum registro encontrado para compara√ß√£o.";
}

// --- INICIALIZA√á√ÉO E EVENT LISTENERS ---

function setupEventListeners() {
    document.getElementById('aguaForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('energiaForm').addEventListener('submit', handleFormSubmit);
    // Adiciona o listener de input para recalcular o total ao digitar
    document.getElementById('consumoAgua').addEventListener('input', () => atualizarTotal('agua'));
    document.getElementById('consumoEnergia').addEventListener('input', () => atualizarTotal('energia'));
}

async function loadInitialData() {
    loadTheme();
    carregarMetas();
    carregarHistorico();
    await carregarTotais(); // Garante que totais e alerts sejam carregados
}

window.onload = function() {
    loadInitialData();
    setupEventListeners();
    // Configurar aba inicial de registro de √Ågua como ativa
    showFormTab('agua', document.querySelector('.form-card > div:first-child .tab-button.active'));
};
</script>
</body>
</html>
