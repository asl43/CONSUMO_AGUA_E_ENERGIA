<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Consumo - √Ågua e Energia</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  :root {
    --primary: #667eea;
    --secondary: #764ba2;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg-light: #ffffff;
    --bg-dark: #1a1a2e;
    --text-light: #333333;
    --text-dark: #ffffff;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary)100%);
    min-height: 100vh;
    padding: 20px;
    position: relative;
    overflow-x: hidden;
    transition: all 0.3s;
  }

  body.dark-mode {
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
  }

  body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
    pointer-events: none;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
  }

  h1 {
    color: white;
    font-size: clamp(24px, 5vw, 36px);
    font-weight: 700;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    animation: slideDown 0.6s ease-out;
  }

  .header-controls {
    display: flex;
    gap: 10px;
  }

  .theme-toggle, .backup-btn {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s;
  }

  .theme-toggle:hover, .backup-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
  }

  .status-indicator {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.9);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .status-indicator.online { color: var(--success); }
  .status-indicator.offline { color: var(--danger); }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse 2s infinite;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .main-tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 30px;
    animation: fadeIn 0.8s ease-out 0.2s both;
    flex-wrap: wrap;
  }

  .tab-button {
    flex: 1;
    min-width: 120px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.2);
    padding: 16px 20px;
    border-radius: 16px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .tab-button:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }

  .tab-button.active {
    background: white;
    color: var(--primary);
    border-color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .main-content {
    display: none;
  }

  .main-content.active {
    display: grid;
    gap: 20px;
    animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .form-card {
    background: white;
    padding: 30px;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }

  body.dark-mode .form-card {
    background: #16213e;
    color: var(--text-dark);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 20px;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
  }

  .stat-card .label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 8px;
  }

  .stat-card .value {
    font-size: 28px;
    font-weight: 700;
  }

  .stat-card.warning {
    background: linear-gradient(135deg, var(--warning) 0%, #f97316 100%);
  }

  .stat-card.success {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
  }

  .chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
    background: white;
    padding: 20px;
    border-radius: 16px;
  }

  body.dark-mode .chart-container {
    background: #0f3460;
  }

  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
  }

  body.dark-mode label {
    color: var(--text-dark);
  }

  input, select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s;
    background: #f8f9fa;
  }

  body.dark-mode input,
  body.dark-mode select {
    background: #0f3460;
    border-color: #1a1a2e;
    color: white;
  }

  input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    background: white;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  }

  body.dark-mode input:focus,
  body.dark-mode select:focus {
    background: #16213e;
  }

  input:read-only {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    cursor: not-allowed;
    font-weight: 600;
    color: var(--primary);
  }

  .button-group {
    display: grid;
    gap: 12px;
    margin-top: 24px;
  }

  button, .btn {
    padding: 16px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
    position: relative;
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
  }

  .btn-secondary {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
  }

  body.dark-mode .btn-secondary {
    background: #0f3460;
    color: white;
  }

  .btn-secondary:hover:not(:disabled) {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  .btn-danger {
    background: var(--danger);
    color: white;
  }

  .spinner {
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top: 3px solid white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-left: 10px;
    vertical-align: middle;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .mensagem {
    text-align: center;
    font-weight: 600;
    margin-top: 16px;
    padding: 12px;
    border-radius: 8px;
    animation: fadeIn 0.3s;
  }

  .mensagem.success {
    background: #d4edda;
    color: #155724;
  }

  .mensagem.error {
    background: #f8d7da;
    color: #721c24;
  }

  .history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .history-table th,
  .history-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
  }

  body.dark-mode .history-table th,
  body.dark-mode .history-table td {
    border-color: #1a1a2e;
  }

  .history-table th {
    background: #f8f9fa;
    font-weight: 600;
  }

  body.dark-mode .history-table th {
    background: #0f3460;
  }

  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 1000;
    animation: slideInRight 0.3s;
    max-width: 300px;
  }

  .notification.warning {
    border-left: 4px solid var(--warning);
  }

  .notification.success {
    border-left: 4px solid var(--success);
  }

  .notification.error {
    border-left: 4px solid var(--danger);
  }

  @keyframes slideInRight {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .goal-progress {
    margin: 20px 0;
  }

  .progress-bar {
    width: 100%;
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success) 0%, #059669 100%);
    transition: width 0.5s;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
  }

  .progress-fill.over {
    background: linear-gradient(90deg, var(--danger) 0%, #dc2626 100%);
  }

  .comparison-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  .comparison-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
  }

  body.dark-mode .comparison-card {
    background: #0f3460;
  }

  .comparison-card .icon {
    font-size: 40px;
    margin-bottom: 10px;
  }

  .comparison-card .value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
  }

  body.dark-mode .comparison-card .value {
    color: #64b5f6;
  }

  .export-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin: 20px 0;
  }

  .filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }

  .backup-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-top: 20px;
  }

  body.dark-mode .backup-section {
    background: #0f3460;
  }

  .file-input-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
    width: 100%;
  }

  .file-input-wrapper input[type=file] {
    position: absolute;
    left: -9999px;
  }

  .file-input-label {
    display: block;
    padding: 14px 16px;
    background: white;
    border: 2px dashed var(--primary);
    border-radius: 12px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s;
  }

  .file-input-label:hover {
    background: #f8f9fa;
    border-color: var(--secondary);
  }

  @media (max-width: 768px) {
    body {
      padding: 12px;
    }

    .form-card {
      padding: 20px;
    }

    .main-tabs {
      gap: 8px;
    }

    .tab-button {
      padding: 12px;
      font-size: 14px;
      min-width: 100px;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .chart-container {
      height: 250px;
    }

    .status-indicator {
      font-size: 10px;
      padding: 6px 12px;
    }

    .export-buttons {
      grid-template-columns: 1fr;
    }
  }

  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .loading {
    animation: pulse 1.5s infinite;
  }
</style>
</head>
<body>

<div class="status-indicator online" id="statusIndicator">
  <span class="status-dot"></span>
  <span>Online</span>
</div>

<div class="container">
  <div class="header">
    <h1>üíß‚ö° Registro de Consumo</h1>
    <div class="header-controls">
      <button class="backup-btn" onclick="toggleBackupModal()" title="Backup e Restaura√ß√£o">üíæ</button>
      <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">üåô</button>
    </div>
  </div>

  <div class="main-tabs">
    <button class="tab-button active" onclick="showMainTab('registro')">
      <span>üìù Registro</span>
    </button>
    <button class="tab-button" onclick="showMainTab('dashboard')">
      <span>üìä Dashboard</span>
    </button>
    <button class="tab-button" onclick="showMainTab('historico')">
      <span>üìã Hist√≥rico</span>
    </button>
    <button class="tab-button" onclick="showMainTab('metas')">
      <span>üéØ Metas</span>
    </button>
    <button class="tab-button" onclick="showMainTab('comparacao')">
      <span>üë• Compara√ß√£o</span>
    </button>
  </div>

  <!-- ABA REGISTRO -->
  <div id="registro" class="main-content active">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Total √Ågua</div>
        <div class="value" id="displayTotalAgua">0.00 m¬≥</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Energia</div>
        <div class="value" id="displayTotalEnergia">0.00 kWh</div>
      </div>
    </div>

    <div class="form-card">
      <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
        <button class="tab-button" style="flex: 1; min-width: 150px;" onclick="showFormTab('agua')">
          üíß √Ågua
        </button>
        <button class="tab-button" style="flex: 1; min-width: 150px;" onclick="showFormTab('energia')">
          ‚ö° Energia
        </button>
      </div>

      <div id="formAgua" class="form-content">
        <form id="aguaForm">
          <div class="form-group">
            <label for="nomeAgua">Nome *</label>
            <input type="text" id="nomeAgua" name="nome" required placeholder="Digite seu nome" aria-required="true">
          </div>

          <div class="form-group">
            <label for="matriculaAgua">Matr√≠cula *</label>
            <input type="text" id="matriculaAgua" name="matricula" required placeholder="Digite sua matr√≠cula" aria-required="true">
          </div>

          <div class="form-group">
            <label for="dataHoraAgua">Data e Hora *</label>
            <input type="datetime-local" id="dataHoraAgua" name="dataHora" required aria-required="true">
          </div>

          <div class="form-group">
            <label for="consumoAgua">Consumo de √Ågua (m¬≥) *</label>
            <input type="number" name="consumoAgua" id="consumoAgua" step="0.01" min="0" required placeholder="0.00" aria-label="Digite o consumo de √°gua em metros c√∫bicos" aria-required="true">
          </div>

          <div class="form-group">
            <label for="totalAgua">Novo Total (m¬≥)</label>
            <input type="number" name="totalAgua" id="totalAgua" step="0.01" readonly aria-readonly="true">
          </div>

          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="confirmarResetTotal('agua')">
              üîÑ Redefinir Total Inicial
            </button>
          </div>

          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px dashed #e0e0e0;">
            <h3 style="margin-bottom: 16px;">üìù Campos Adicionais (Opcional)</h3>
            <div class="form-group">
              <label for="extra1Agua">Campo Extra 1</label>
              <input type="text" id="extra1Agua" name="extra1" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label for="extra2Agua">Campo Extra 2</label>
              <input type="text" id="extra2Agua" name="extra2" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label for="extra3Agua">Campo Extra 3</label>
              <input type="text" id="extra3Agua" name="extra3" placeholder="Opcional">
            </div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-primary" id="btnSubmitAgua">‚úÖ Enviar Registro de √Ågua</button>
          </div>
          <p class="mensagem" id="msgAgua" role="alert"></p>
        </form>
      </div>

      <div id="formEnergia" class="form-content" style="display: none;">
        <form id="energiaForm">
          <div class="form-group">
            <label for="nomeEnergia">Nome *</label>
            <input type="text" id="nomeEnergia" name="nome" required placeholder="Digite seu nome" aria-required="true">
          </div>

          <div class="form-group">
            <label for="matriculaEnergia">Matr√≠cula *</label>
            <input type="text" id="matriculaEnergia" name="matricula" required placeholder="Digite sua matr√≠cula" aria-required="true">
          </div>

          <div class="form-group">
            <label for="dataHoraEnergia">Data e Hora *</label>
            <input type="datetime-local" id="dataHoraEnergia" name="dataHora" required aria-required="true">
          </div>

          <div class="form-group">
            <label for="consumoEnergia">Consumo de Energia (kWh) *</label>
            <input type="number" name="consumoEnergia" id="consumoEnergia" step="0.01" min="0" required placeholder="0.00" aria-label="Digite o consumo de energia em kilowatt-hora" aria-required="true">
          </div>

          <div class="form-group">
            <label for="totalEnergia">Novo Total (kWh)</label>
            <input type="number" name="totalEnergia" id="totalEnergia" step="0.01" readonly aria-readonly="true">
          </div>

          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="confirmarResetTotal('energia')">
              üîÑ Redefinir Total Inicial
            </button>
          </div>

          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px dashed #e0e0e0;">
            <h3 style="margin-bottom: 16px;">üìù Campos Adicionais (Opcional)</h3>
            <div class="form-group">
              <label for="extra1Energia">Campo Extra 1</label>
              <input type="text" id="extra1Energia" name="extra1" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label for="extra2Energia">Campo Extra 2</label>
              <input type="text" id="extra2Energia" name="extra2" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label for="extra3Energia">Campo Extra 3</label>
              <input type="text" id="extra3Energia" name="extra3" placeholder="Opcional">
            </div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-primary" id="btnSubmitEnergia">‚úÖ Enviar Registro de Energia</button>
          </div>
          <p class="mensagem" id="msgEnergia" role="alert"></p>
        </form>
      </div>
    </div>
  </div>

  <!-- ABA DASHBOARD -->
  <div id="dashboard" class="main-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Consumo √Ågua (M√™s)</div>
        <div class="value" id="aguaMes">0.00 m¬≥</div>
      </div>
      <div class="stat-card">
        <div class="label">Consumo Energia (M√™s)</div>
        <div class="value" id="energiaMes">0.00 kWh</div>
      </div>
      <div class="stat-card success">
        <div class="label">Economia √Ågua</div>
        <div class="value" id="economiaAgua">0%</div>
      </div>
      <div class="stat-card warning">
        <div class="label">Custo Estimado</div>
        <div class="value" id="custoTotal">R$ 0,00</div>
      </div>
    </div>

    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üìà Gr√°fico de Consumo</h2>
      <div class="chart-container">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>

    <div class="form-card" style="margin-top: 20px;">
      <h2 style="margin-bottom: 20px;">üìä Distribui√ß√£o por Tipo</h2>
      <div class="chart-container" style="height: 250px;">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ABA HIST√ìRICO -->
  <div id="historico" class="main-content">
    <div class="form-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2>üìã Hist√≥rico de Registros</h2>
        <div class="export-buttons" style="max-width: 400px;">
          <button class="btn btn-success" onclick="exportarCSV()">üì• CSV</button>
          <button class="btn btn-danger" onclick="exportarPDF()">üìÑ PDF</button>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="form-group">
          <label for="filtroTipo">Filtrar por Tipo</label>
          <select id="filtroTipo" onchange="filtrarHistorico()">
            <option value="todos">Todos</option>
            <option value="√°gua">üíß √Ågua</option>
            <option value="energia">‚ö° Energia</option>
          </select>
        </div>

        <div class="form-group">
          <label for="filtroPeriodo">Per√≠odo</label>
          <select id="filtroPeriodo" onchange="filtrarHistorico()">
            <option value="todos">Todos</option>
            <option value="hoje">Hoje</option>
            <option value="semana">Esta Semana</option>
            <option value="mes">Este M√™s</option>
          </select>
        </div>
      </div>

      <div style="overflow-x: auto;">
        <table class="history-table">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Tipo</th>
              <th>Nome</th>
              <th>Consumo</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="historicoBody">
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px;">Nenhum registro encontrado</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ABA METAS -->
  <div id="metas" class="main-content">
    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üéØ Definir Metas de Consumo</h2>
      
      <div class="form-group">
        <label for="metaAgua">Meta de √Ågua Mensal (m¬≥)</label>
        <input type="number" id="metaAgua" step="0.01" min="0" placeholder="Ex: 10.00" onchange="salvarMetas()">
      </div>

      <div class="form-group">
        <label for="metaEnergia">Meta de Energia Mensal (kWh)</label>
        <input type="number" id="metaEnergia" step="0.01" min="0" placeholder="Ex: 150.00" onchange="salvarMetas()">
      </div>

      <div class="goal-progress">
        <h3 style="margin-bottom: 10px;">Progresso - √Ågua</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressAgua" style="width: 0%;">0%</div>
        </div>
      </div>

      <div class="goal-progress">
        <h3 style="margin-bottom: 10px;">Progresso - Energia</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressEnergia" style="width: 0%;">0%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ABA COMPARA√á√ÉO -->
  <div id="comparacao" class="main-content">
    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üë• Compara√ß√£o com M√©dia</h2>
      
      <div class="comparison-section">
        <div class="comparison-card">
          <div class="icon">üíß</div>
          <div class="label">Seu Consumo de √Ågua</div>
          <div class="value" id="compSeuAgua">0.00 m¬≥</div>
        </div>
        <div class="comparison-card">
          <div class="icon">üìä</div>
          <div class="label">M√©dia Geral</div>
          <div class="value" id="compMediaAgua">0.00 m¬≥</div>
        </div>
        <div class="comparison-card">
          <div class="icon">‚ö°</div>
          <div class="label">Sua Energia</div>
          <div class="value" id="compSeuEnergia">0.00 kWh</div>
        </div>
        <div class="comparison-card">
          <div class="icon">üìä</div>
          <div class="label">M√©dia Geral</div>
          <div class="value" id="compMediaEnergia">0.00 kWh</div>
        </div>
      </div>

      <div class="form-card" style="margin-top: 20px; background: #f8f9fa;">
        <h3 style="margin-bottom: 15px;">üí° An√°lise</h3>
        <p id="analiseTexto">Configure suas metas e registre consumos para ver a an√°lise comparativa.</p>
      </div>
    </div>
  </div>

  <!-- MODAL BACKUP -->
  <div id="backupModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div class="form-card" style="max-width: 500px; margin: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üíæ Backup e Restaura√ß√£o</h2>
        <button onclick="toggleBackupModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">‚úï</button>
      </div>

      <div class="backup-section">
        <h3 style="margin-bottom: 15px;">üì§ Exportar Backup</h3>
        <p style="margin-bottom: 15px; font-size: 14px;">Salve todos os seus dados em um arquivo JSON.</p>
        <button class="btn btn-primary" onclick="exportarBackup()">üíæ Baixar Backup</button>
      </div>

      <div class="backup-section">
        <h3 style="margin-bottom: 15px;">üì• Importar Backup</h3>
        <p style="margin-bottom: 15px; font-size: 14px;">Restaure seus dados a partir de um arquivo de backup.</p>
        <div class="file-input-wrapper">
          <input type="file" id="backupFile" accept=".json" onchange="importarBackup(this.files[0])">
          <label for="backupFile" class="file-input-label">
            üìÅ Selecionar arquivo de backup
          </label>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbyfpjvwFpYmruXMHYlOBu6_XY_I1U0qRRGapmXU8SgmyvVdNVK2iCJwp-fxn58ipx1U/exec";

let totalAnteriorAgua = 0;
let totalAnteriorEnergia = 0;
let historico = [];
let metas = { agua: 10, energia: 150 };
let chartInstance = null;
let pieChartInstance = null;
let isOnline = navigator.onLine;

// ========== UTILIT√ÅRIOS ==========

// Debounce function
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Sanitizar inputs
function sanitizarInput(valor) {
  return String(valor).replace(/[<>]/g, '');
}

// Validar consumo
function validarConsumo(valor, tipo) {
  const num = parseFloat(valor);
  if (isNaN(num) || num < 0) {
    alert('‚ö†Ô∏è Por favor, insira um valor v√°lido e positivo.');
    return false;
  }
  if (tipo === 'agua' && num > 100) {
    return confirm('‚ö†Ô∏è Consumo muito alto para √°gua (>100 m¬≥). Deseja confirmar?');
  }
  if (tipo === 'energia' && num > 1000) {
    return confirm('‚ö†Ô∏è Consumo muito alto para energia (>1000 kWh). Deseja confirmar?');
  }
  return true;
}

// ========== TEMA ESCURO ==========
function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const icon = document.querySelector('.theme-toggle');
  icon.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
}

// ========== STATUS ONLINE/OFFLINE ==========
function atualizarStatusConexao() {
  const indicator = document.getElementById('statusIndicator');
  isOnline = navigator.onLine;
  
  if (isOnline) {
    indicator.className = 'status-indicator online';
    indicator.innerHTML = '<span class="status-dot"></span><span>Online</span>';
  } else {
    indicator.className = 'status-indicator offline';
    indicator.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
    mostrarNotificacao('‚ö†Ô∏è Voc√™ est√° offline. Os dados ser√£o sincronizados quando a conex√£o for restabelecida.', 'warning');
  }
}

window.addEventListener('online', atualizarStatusConexao);
window.addEventListener('offline', atualizarStatusConexao);

// ========== NAVEGA√á√ÉO ==========
function showMainTab(tabId) {
  document.querySelectorAll('.main-content').forEach(div => div.classList.remove('active'));
  document.querySelectorAll('.main-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  event.target.closest('.tab-button').classList.add('active');
  
  if (tabId === 'dashboard') {
    setTimeout(criarGraficos, 100);
  } else if (tabId === 'historico') {
    carregarHistorico();
  } else if (tabId === 'metas') {
    atualizarProgressoMetas();
  } else if (tabId === 'comparacao') {
    atualizarComparacao();
  }
}

function showFormTab(tipo) {
  document.querySelectorAll('.form-content').forEach(div => div.style.display = 'none');
  document.getElementById(`form${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).style.display = 'block';
  
  const buttons = document.querySelectorAll('.form-card > div:first-child .tab-button');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
}

// ========== CARREGAR TOTAIS ==========
async function carregarTotais() {
  try {
    const res = await fetch(`${scriptURL}?action=getLast`);
    if (!res.ok) throw new Error('Erro na requisi√ß√£o');
    
    const data = await res.json();
    totalAnteriorAgua = parseFloat(data.agua) || parseFloat(localStorage.getItem('totalAnteriorAgua')) || 0;
    totalAnteriorEnergia = parseFloat(data.energia) || parseFloat(localStorage.getItem('totalAnteriorEnergia')) || 0;
    
    // Salvar no localStorage como backup
    localStorage.setItem('totalAnteriorAgua', totalAnteriorAgua);
    localStorage.setItem('totalAnteriorEnergia', totalAnteriorEnergia);
    
    atualizarDisplayTotais();
    verificarAlertas();
  } catch (err) {
    console.error("Erro ao carregar totais:", err);
    mostrarNotificacao('‚ö†Ô∏è Erro ao carregar dados do servidor. Usando cache local.', 'warning');
    
    // Usar dados do localStorage como fallback
    totalAnteriorAgua = parseFloat(localStorage.getItem('totalAnteriorAgua')) || 0;
    totalAnteriorEnergia = parseFloat(localStorage.getItem('totalAnteriorEnergia')) || 0;
    atualizarDisplayTotais();
  }
}

function atualizarDisplayTotais() {
  document.getElementById("totalAgua").value = totalAnteriorAgua.toFixed(2);
  document.getElementById("totalEnergia").value = totalAnteriorEnergia.toFixed(2);
  document.getElementById("displayTotalAgua").textContent = totalAnteriorAgua.toFixed(2) + " m¬≥";
  document.getElementById("displayTotalEnergia").textContent = totalAnteriorEnergia.toFixed(2) + " kWh";
}

// ========== ATUALIZAR TOTAL (com debounce) ==========
const atualizarTotalDebounced = debounce((tipo) => {
  const consumo = parseFloat(document.getElementById(`consumo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value) || 0;
  const totalAnterior = tipo === 'agua' ? totalAnteriorAgua : totalAnteriorEnergia;
  const novoTotal = (consumo + totalAnterior).toFixed(2);
  document.getElementById(`total${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value = novoTotal;
}, 300);

// ========== REDEFINIR TOTAL COM CONFIRMA√á√ÉO ==========
function confirmarResetTotal(tipo) {
  const tipoNome = tipo === 'agua' ? '√Ågua' : 'Energia';
  if (confirm(`‚ö†Ô∏è Tem certeza que deseja redefinir o total de ${tipoNome}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
    definirInicio(tipo);
  }
}

function definirInicio(tipo) {
  const novoValor = prompt(`Digite o novo total inicial de ${tipo === 'agua' ? '√Ågua (m¬≥)' : 'Energia (kWh)'}:`);
  if (novoValor !== null && !isNaN(novoValor) && parseFloat(novoValor) >= 0) {
    const valorNum = parseFloat(novoValor);
    if (tipo === 'agua') {
      totalAnteriorAgua = valorNum;
      localStorage.setItem('totalAnteriorAgua', totalAnteriorAgua);
      document.getElementById("totalAgua").value = novoValor;
      document.getElementById("displayTotalAgua").textContent = valorNum.toFixed(2) + " m¬≥";
    } else {
      totalAnteriorEnergia = valorNum;
      localStorage.setItem('totalAnteriorEnergia', totalAnteriorEnergia);
      document.getElementById("totalEnergia").value = novoValor;
      document.getElementById("displayTotalEnergia").textContent = valorNum.toFixed(2) + " kWh";
    }
    mostrarNotificacao(`‚úÖ Total de ${tipo === 'agua' ? '√Ågua' : 'Energia'} redefinido com sucesso!`, 'success');
  }
}

// ========== MENSAGENS E NOTIFICA√á√ïES ==========
function mostrarMensagem(elemento, texto, tipo) {
  elemento.textContent = texto;
  elemento.className = `mensagem ${tipo}`;
  setTimeout(() => {
    elemento.textContent = '';
    elemento.className = 'mensagem';
  }, 5000);
}

function mostrarNotificacao(mensagem, tipo = 'warning') {
  const notif = document.createElement('div');
  notif.className = `notification ${tipo}`;
  notif.innerHTML = `<strong>${tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : '‚ö†Ô∏è'} ${tipo === 'success' ? 'Sucesso' : tipo === 'error' ? 'Erro' : 'Alerta'}</strong><p>${mensagem}</p>`;
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideInRight 0.3s reverse';
    setTimeout(() => notif.remove(), 300);
  }, 5000);
}

// ========== VERIFICAR ALERTAS ==========
function verificarAlertas() {
  const metaAgua = parseFloat(localStorage.getItem('metaAgua')) || 10;
  const metaEnergia = parseFloat(localStorage.getItem('metaEnergia')) || 150;
  
  if (totalAnteriorAgua > metaAgua * 0.9 && totalAnteriorAgua <= metaAgua) {
    mostrarNotificacao(`üíß Voc√™ j√° consumiu ${((totalAnteriorAgua/metaAgua)*100).toFixed(0)}% da sua meta de √°gua!`, 'warning');
  } else if (totalAnteriorAgua > metaAgua) {
    mostrarNotificacao(`üö® Voc√™ ultrapassou sua meta de √°gua em ${((totalAnteriorAgua/metaAgua)*100 - 100).toFixed(0)}%!`, 'error');
  }
  
  if (totalAnteriorEnergia > metaEnergia * 0.9 && totalAnteriorEnergia <= metaEnergia) {
    mostrarNotificacao(`‚ö° Voc√™ j√° consumiu ${((totalAnteriorEnergia/metaEnergia)*100).toFixed(0)}% da sua meta de energia!`, 'warning');
  } else if (totalAnteriorEnergia > metaEnergia) {
    mostrarNotificacao(`üö® Voc√™ ultrapassou sua meta de energia em ${((totalAnteriorEnergia/metaEnergia)*100 - 100).toFixed(0)}%!`, 'error');
  }
  
  verificarAlertasAvancados();
}

function verificarAlertasAvancados() {
  const hist = historico.slice(-7);
  
  // Detectar tend√™ncia de aumento em √°gua
  const aguaRecente = hist.filter(h => h.tipo === '√°gua').map(h => parseFloat(h.consumo));
  if (aguaRecente.length >= 3) {
    const tendencia = aguaRecente.slice(-3).every((val, i, arr) => i === 0 || val > arr[i-1]);
    if (tendencia) {
      mostrarNotificacao('üìà Aten√ß√£o: Seu consumo de √°gua est√° aumentando nos √∫ltimos registros.', 'warning');
    }
  }
  
  // Detectar tend√™ncia de aumento em energia
  const energiaRecente = hist.filter(h => h.tipo === 'energia').map(h => parseFloat(h.consumo));
  if (energiaRecente.length >= 3) {
    const tendencia = energiaRecente.slice(-3).every((val, i, arr) => i === 0 || val > arr[i-1]);
    if (tendencia) {
      mostrarNotificacao('üìà Aten√ß√£o: Seu consumo de energia est√° aumentando nos √∫ltimos registros.', 'warning');
    }
  }
}

// ========== ENVIO FORMUL√ÅRIOS ==========
document.getElementById('aguaForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const msg = document.getElementById('msgAgua');
  const btn = document.getElementById('btnSubmitAgua');
  
  const consumoInput = form.querySelector('[name="consumoAgua"]');
  const consumo = parseFloat(consumoInput.value);
  
  // Validar consumo
  if (!validarConsumo(consumo, 'agua')) {
    return;
  }
  
  btn.innerHTML = '‚è≥ Enviando...<span class="spinner"></span>';
  btn.disabled = true;
  
  const formData = new FormData(form);
  
  // Sanitizar inputs de texto
  formData.set('nome', sanitizarInput(formData.get('nome')));
  formData.set('matricula', sanitizarInput(formData.get('matricula')));
  
  try {
    const response = await fetch(scriptURL, { method: 'POST', body: formData });
    
    if (!response.ok) throw new Error('Erro no envio');
    
    mostrarMensagem(msg, "‚úÖ Dados de √Ågua enviados com sucesso!", "success");
    mostrarNotificacao('‚úÖ Registro de √°gua salvo com sucesso!', 'success');
    
    // Adicionar ao hist√≥rico local
    historico.push({
      data: formData.get('dataHora'),
      tipo: '√°gua',
      nome: formData.get('nome'),
      consumo: formData.get('consumoAgua'),
      total: formData.get('totalAgua')
    });
    localStorage.setItem('historico', JSON.stringify(historico));
    
    form.reset();
    await carregarTotais();
  } catch (err) {
    console.error('Erro:', err);
    mostrarMensagem(msg, "‚ùå Erro ao enviar dados. Tente novamente.", "error");
    mostrarNotificacao('‚ùå Falha ao enviar. Verifique sua conex√£o.', 'error');
  } finally {
    btn.innerHTML = '‚úÖ Enviar Registro de √Ågua';
    btn.disabled = false;
  }
});

document.getElementById('energiaForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const msg = document.getElementById('msgEnergia');
  const btn = document.getElementById('btnSubmitEnergia');
  
  const consumoInput = form.querySelector('[name="consumoEnergia"]');
  const consumo = parseFloat(consumoInput.value);
  
  // Validar consumo
  if (!validarConsumo(consumo, 'energia')) {
    return;
  }
  
  btn.innerHTML = '‚è≥ Enviando...<span class="spinner"></span>';
  btn.disabled = true;
  
  const formData = new FormData(form);
  
  // Sanitizar inputs de texto
  formData.set('nome', sanitizarInput(formData.get('nome')));
  formData.set('matricula', sanitizarInput(formData.get('matricula')));
  
  try {
    const response = await fetch(scriptURL, { method: 'POST', body: formData });
    
    if (!response.ok) throw new Error('Erro no envio');
    
    mostrarMensagem(msg, "‚úÖ Dados de Energia enviados com sucesso!", "success");
    mostrarNotificacao('‚úÖ Registro de energia salvo com sucesso!', 'success');
    
    // Adicionar ao hist√≥rico local
    historico.push({
      data: formData.get('dataHora'),
      tipo: 'energia',
      nome: formData.get('nome'),
      consumo: formData.get('consumoEnergia'),
      total: formData.get('totalEnergia')
    });
    localStorage.setItem('historico', JSON.stringify(historico));
    
    form.reset();
    await carregarTotais();
  } catch (err) {
    console.error('Erro:', err);
    mostrarMensagem(msg, "‚ùå Erro ao enviar dados. Tente novamente.", "error");
    mostrarNotificacao('‚ùå Falha ao enviar. Verifique sua conex√£o.', 'error');
  } finally {
    btn.innerHTML = '‚úÖ Enviar Registro de Energia';
    btn.disabled = false;
  }
});

// ========== GR√ÅFICOS ==========
function criarGraficos() {
  const labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'];
  const aguaData = historico.filter(h => h.tipo === '√°gua').slice(-6).map(h => parseFloat(h.consumo));
  const energiaData = historico.filter(h => h.tipo === 'energia').slice(-6).map(h => parseFloat(h.consumo));
  
  // Preencher com dados simulados se n√£o houver hist√≥rico suficiente
  while (aguaData.length < 6) aguaData.unshift(Math.random() * 5 + 2);
  while (energiaData.length < 6) energiaData.unshift(Math.random() * 50 + 100);
  
  // Gr√°fico de Linha
  const ctx = document.getElementById('consumptionChart');
  if (chartInstance) chartInstance.destroy();
  
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: '√Ågua (m¬≥)',
          data: aguaData,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          tension: 0.4,
          fill: true
        },
        {
          label: 'Energia (kWh)',
          data: energiaData,
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          tension: 0.4,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          mode: 'index',
          intersect: false,
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
  
  // Gr√°fico de Pizza
  const ctxPie = document.getElementById('pieChart');
  if (pieChartInstance) pieChartInstance.destroy();
  
  const totalAgua = aguaData.reduce((a, b) => a + b, 0);
  const totalEnergia = energiaData.reduce((a, b) => a + b, 0);
  
  pieChartInstance = new Chart(ctxPie, {
    type: 'doughnut',
    data: {
      labels: ['√Ågua (m¬≥)', 'Energia (kWh)'],
      datasets: [{
        data: [totalAgua, totalEnergia],
        backgroundColor: ['#667eea', '#f59e0b'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
        }
      }
    }
  });
  
  // Atualizar estat√≠sticas
  document.getElementById('aguaMes').textContent = totalAgua.toFixed(2) + ' m¬≥';
  document.getElementById('energiaMes').textContent = totalEnergia.toFixed(2) + ' kWh';
  
  const economiaCalc = Math.max(0, 100 - (totalAgua / (metas.agua || 10)) * 100);
  document.getElementById('economiaAgua').textContent = economiaCalc.toFixed(0) + '%';
  
  const custoAgua = totalAgua * 5.5;
  const custoEnergia = totalEnergia * 0.85;
  document.getElementById('custoTotal').textContent = 'R$ ' + (custoAgua + custoEnergia).toFixed(2);
}

// ========== HIST√ìRICO ==========
function carregarHistorico() {
  const hist = JSON.parse(localStorage.getItem('historico') || '[]');
  historico = hist;
  filtrarHistorico();
}

function filtrarHistorico() {
  const filtroTipo = document.getElementById('filtroTipo').value;
  const filtroPeriodo = document.getElementById('filtroPeriodo').value;
  const tbody = document.getElementById('historicoBody');
  
  let dadosFiltrados = historico;
  
  // Filtrar por tipo
  if (filtroTipo !== 'todos') {
    dadosFiltrados = dadosFiltrados.filter(h => h.tipo === filtroTipo);
  }
  
  // Filtrar por per√≠odo
  const agora = new Date();
  if (filtroPeriodo !== 'todos') {
    dadosFiltrados = dadosFiltrados.filter(h => {
      const dataItem = new Date(h.data);
      
      if (filtroPeriodo === 'hoje') {
        return dataItem.toDateString() === agora.toDateString();
      } else if (filtroPeriodo === 'semana') {
        const umaSemanaAtras = new Date(agora.getTime() - 7 * 24 * 60 * 60 * 1000);
        return dataItem >= umaSemanaAtras;
      } else if (filtroPeriodo === 'mes') {
        return dataItem.getMonth() === agora.getMonth() && dataItem.getFullYear() === agora.getFullYear();
      }
      return true;
    });
  }
  
  if (dadosFiltrados.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Nenhum registro encontrado</td></tr>';
    return;
  }
  
  tbody.innerHTML = dadosFiltrados.reverse().map(item => `
    <tr>
      <td>${new Date(item.data).toLocaleString('pt-BR')}</td>
      <td>${item.tipo === '√°gua' ? 'üíß √Ågua' : '‚ö° Energia'}</td>
      <td>${item.nome}</td>
      <td>${parseFloat(item.consumo).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}</td>
      <td>${parseFloat(item.total).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}</td>
    </tr>
  `).join('');
}

// ========== EXPORTAR CSV ==========
function exportarCSV() {
  const csv = ['Data/Hora,Tipo,Nome,Consumo,Total'];
  historico.forEach(item => {
    csv.push(`${new Date(item.data).toLocaleString('pt-BR')},${item.tipo},${item.nome},${parseFloat(item.consumo).toFixed(2)},${parseFloat(item.total).toFixed(2)}`);
  });
  
  const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `historico_consumo_${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  mostrarNotificacao('‚úÖ Arquivo CSV exportado com sucesso!', 'success');
}

// ========== EXPORTAR PDF ==========
function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // T√≠tulo
  doc.setFontSize(18);
  doc.text("Hist√≥rico de Consumo - √Ågua e Energia", 14, 20);
  
  // Informa√ß√µes gerais
  doc.setFontSize(10);
  doc.text(`Total de Registros: ${historico.length}`, 14, 28);
  doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 34);
  doc.text(`Total √Ågua: ${totalAnteriorAgua.toFixed(2)} m¬≥`, 14, 40);
  doc.text(`Total Energia: ${totalAnteriorEnergia.toFixed(2)} kWh`, 14, 46);

  // Tabela
  const tableData = historico.map(item => [
    new Date(item.data).toLocaleString('pt-BR'),
    item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1),
    item.nome,
    `${parseFloat(item.consumo).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}`,
    `${parseFloat(item.total).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}`,
  ]);

  doc.autoTable({
    head: [['Data/Hora', 'Tipo', 'Nome', 'Consumo', 'Total']],
    body: tableData,
    startY: 52,
    styles: { fontSize: 8, cellPadding: 2 },
    headStyles: { fillColor: [102, 126, 234] },
    alternateRowStyles: { fillColor: [245, 247, 250] }
  });
  
  doc.save(`historico_consumo_${new Date().toISOString().split('T')[0]}.pdf`);
  mostrarNotificacao('‚úÖ Arquivo PDF exportado com sucesso!', 'success');
}

// ========== METAS ==========
function carregarMetas() {
  metas.agua = parseFloat(localStorage.getItem('metaAgua')) || 10;
  metas.energia = parseFloat(localStorage.getItem('metaEnergia')) || 150;
  document.getElementById('metaAgua').value = metas.agua;
  document.getElementById('metaEnergia').value = metas.energia;
}

function salvarMetas() {
  const metaAguaInput = document.getElementById('metaAgua').value;
  const metaEnergiaInput = document.getElementById('metaEnergia').value;
  
  if (metaAguaInput && parseFloat(metaAguaInput) >= 0) {
    metas.agua = parseFloat(metaAguaInput);
    localStorage.setItem('metaAgua', metas.agua);
    mostrarNotificacao('‚úÖ Meta de √°gua atualizada!', 'success');
  }
  
  if (metaEnergiaInput && parseFloat(metaEnergiaInput) >= 0) {
    metas.energia = parseFloat(metaEnergiaInput);
    localStorage.setItem('metaEnergia', metas.energia);
    mostrarNotificacao('‚úÖ Meta de energia atualizada!', 'success');
  }
  
  atualizarProgressoMetas();
}

function atualizarProgressoMetas() {
  carregarMetas();

  // Calcular consumo do m√™s (√∫ltimos 30 registros ou soma dos √∫ltimos 6)
  const aguaConsumoMes = historico
    .filter(h => h.tipo === '√°gua')
    .slice(-6)
    .reduce((acc, h) => acc + parseFloat(h.consumo), 0);
    
  const energiaConsumoMes = historico
    .filter(h => h.tipo === 'energia')
    .slice(-6)
    .reduce((acc, h) => acc + parseFloat(h.consumo), 0);

  // Progresso √Ågua
  const progressAgua = document.getElementById('progressAgua');
  let percentAgua = metas.agua > 0 ? (aguaConsumoMes / metas.agua) * 100 : 0;
  
  const widthAgua = Math.min(100, percentAgua);
  progressAgua.style.width = `${widthAgua}%`;
  progressAgua.textContent = `${percentAgua.toFixed(1)}% (${aguaConsumoMes.toFixed(2)} / ${metas.agua.toFixed(2)} m¬≥)`;
  progressAgua.classList.toggle('over', percentAgua > 100);

  // Progresso Energia
  const progressEnergia = document.getElementById('progressEnergia');
  let percentEnergia = metas.energia > 0 ? (energiaConsumoMes / metas.energia) * 100 : 0;
  
  const widthEnergia = Math.min(100, percentEnergia);
  progressEnergia.style.width = `${widthEnergia}%`;
  progressEnergia.textContent = `${percentEnergia.toFixed(1)}% (${energiaConsumoMes.toFixed(2)} / ${metas.energia.toFixed(2)} kWh)`;
  progressEnergia.classList.toggle('over', percentEnergia > 100);
}

// ========== COMPARA√á√ÉO ==========
function atualizarComparacao() {
  carregarMetas();
  
  // Simular m√©dia geral baseada nas metas
  const mediaAguaSimulada = metas.agua * 1.1;
  const mediaEnergiaSimulada = metas.energia * 0.95;

  // Calcular consumo do m√™s atual
  const aguaConsumoMes = historico
    .filter(h => h.tipo === '√°gua')
    .slice(-6)
    .reduce((acc, h) => acc + parseFloat(h.consumo), 0);
    
  const energiaConsumoMes = historico
    .filter(h => h.tipo === 'energia')
    .slice(-6)
    .reduce((acc, h) => acc + parseFloat(h.consumo), 0);

  // Atualizar cards
  document.getElementById('compSeuAgua').textContent = aguaConsumoMes.toFixed(2) + ' m¬≥';
  document.getElementById('compMediaAgua').textContent = mediaAguaSimulada.toFixed(2) + ' m¬≥';
  document.getElementById('compSeuEnergia').textContent = energiaConsumoMes.toFixed(2) + ' kWh';
  document.getElementById('compMediaEnergia').textContent = mediaEnergiaSimulada.toFixed(2) + ' kWh';

  // An√°lise detalhada
  let analise = '';
  
  // An√°lise √Ågua
  const difAgua = ((aguaConsumoMes - mediaAguaSimulada) / mediaAguaSimulada) * 100;
  if (aguaConsumoMes < mediaAguaSimulada * 0.9) {
    analise += `üíß <strong>Excelente!</strong> Seu consumo de √°gua est√° ${Math.abs(difAgua).toFixed(0)}% abaixo da m√©dia. Continue assim! `;
  } else if (aguaConsumoMes > mediaAguaSimulada * 1.1) {
    analise += `üíß <strong>Aten√ß√£o!</strong> Seu consumo de √°gua est√° ${difAgua.toFixed(0)}% acima da m√©dia. Considere economizar. `;
  } else {
    analise += `üíß Seu consumo de √°gua est√° pr√≥ximo da m√©dia geral. `;
  }
  
  // An√°lise Energia
  const difEnergia = ((energiaConsumoMes - mediaEnergiaSimulada) / mediaEnergiaSimulada) * 100;
  if (energiaConsumoMes < mediaEnergiaSimulada * 0.9) {
    analise += `<br><br>‚ö° <strong>Parab√©ns!</strong> Seu consumo de energia est√° ${Math.abs(difEnergia).toFixed(0)}% abaixo da m√©dia. √ìtimo trabalho! `;
  } else if (energiaConsumoMes > mediaEnergiaSimulada * 1.1) {
    analise += `<br><br>‚ö° <strong>Alerta!</strong> Seu consumo de energia est√° ${difEnergia.toFixed(0)}% acima da m√©dia. Verifique aparelhos. `;
  } else {
    analise += `<br><br>‚ö° Seu consumo de energia est√° alinhado com a m√©dia geral. `;
  }
  
  // Dicas personalizadas
  if (aguaConsumoMes > mediaAguaSimulada || energiaConsumoMes > mediaEnergiaSimulada) {
    analise += `<br><br><strong>üí° Dicas:</strong><br>`;
    if (aguaConsumoMes > mediaAguaSimulada) {
      analise += `‚Ä¢ Verifique vazamentos em torneiras e vasos sanit√°rios<br>`;
      analise += `‚Ä¢ Reduza o tempo de banho<br>`;
    }
    if (energiaConsumoMes > mediaEnergiaSimulada) {
      analise += `‚Ä¢ Desligue aparelhos da tomada quando n√£o usar<br>`;
      analise += `‚Ä¢ Troque l√¢mpadas por LED<br>`;
    }
  }
  
  document.getElementById('analiseTexto').innerHTML = analise || "Configure suas metas e registre consumos para ver a an√°lise comparativa.";
}

// ========== BACKUP E RESTAURA√á√ÉO ==========
function toggleBackupModal() {
  const modal = document.getElementById('backupModal');
  if (modal.style.display === 'none' || !modal.style.display) {
    modal.style.display = 'flex';
  } else {
    modal.style.display = 'none';
  }
}

function exportarBackup() {
  const backup = {
    versao: '1.0',
    dataBackup: new Date().toISOString(),
    historico: historico,
    metas: metas,
    totais: {
      agua: totalAnteriorAgua,
      energia: totalAnteriorEnergia
    },
    configuracoes: {
      tema: localStorage.getItem('theme') || 'light'
    }
  };
  
  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `backup_consumo_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  mostrarNotificacao('‚úÖ Backup criado com sucesso!', 'success');
}

function importarBackup(file) {
  if (!file) return;
  
  if (!file.name.endsWith('.json')) {
    mostrarNotificacao('‚ùå Por favor, selecione um arquivo JSON v√°lido.', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const backup = JSON.parse(e.target.result);
      
      // Validar estrutura do backup
      if (!backup.historico || !backup.metas || !backup.totais) {
        throw new Error('Arquivo de backup inv√°lido');
      }
      
      // Confirmar importa√ß√£o
      if (!confirm(`‚ö†Ô∏è Tem certeza que deseja restaurar o backup de ${new Date(backup.dataBackup).toLocaleString('pt-BR')}?\n\nIsso substituir√° todos os seus dados atuais.`)) {
        return;
      }
      
      // Restaurar dados
      historico = backup.historico || [];
      metas = backup.metas || { agua: 10, energia: 150 };
      totalAnteriorAgua = backup.totais?.agua || 0;
      totalAnteriorEnergia = backup.totais?.energia || 0;
      
      // Salvar no localStorage
      localStorage.setItem('historico', JSON.stringify(historico));
      localStorage.setItem('metaAgua', metas.agua);
      localStorage.setItem('metaEnergia', metas.energia);
      localStorage.setItem('totalAnteriorAgua', totalAnteriorAgua);
      localStorage.setItem('totalAnteriorEnergia', totalAnteriorEnergia);
      
      if (backup.configuracoes?.tema) {
        localStorage.setItem('theme', backup.configuracoes.tema);
      }
      
      mostrarNotificacao('‚úÖ Backup restaurado com sucesso! A p√°gina ser√° recarregada.', 'success');
      
      setTimeout(() => {
        location.reload();
      }, 2000);
      
    } catch (err) {
      console.error('Erro ao importar backup:', err);
      mostrarNotificacao('‚ùå Erro ao importar backup. Verifique se o arquivo √© v√°lido.', 'error');
    }
  };
  reader.readAsText(file);
  
  // Limpar input
  document.getElementById('backupFile').value = '';
}

// ========== INICIALIZA√á√ÉO ==========
function init() {
  // Carregar tema
  const theme = localStorage.getItem('theme');
  if (theme === 'dark') {
    document.body.classList.add('dark-mode');
    document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
  }
  
  // Carregar dados
  carregarHistorico();
  carregarTotais();
  carregarMetas();
  
  // Verificar status de conex√£o
  atualizarStatusConexao();
  
  // Configurar aba inicial
  showFormTab('agua');
  
  // Adicionar listeners para atualiza√ß√£o de total (com debounce)
  document.getElementById('consumoAgua').addEventListener('input', () => atualizarTotalDebounced('agua'));
  document.getElementById('consumoEnergia').addEventListener('input', () => atualizarTotalDebounced('energia'));
  
  // Fechar modal ao clicar fora
  document.getElementById('backupModal').addEventListener('click', (e) => {
    if (e.target.id === 'backupModal') {
      toggleBackupModal();
    }
  });
  
  console.log('‚úÖ Sistema iniciado com sucesso!');
  console.log(`üìä ${historico.length} registros carregados`);
  console.log(`üéØ Metas: √Ågua ${metas.agua} m¬≥ | Energia ${metas.energia} kWh`);
}

// Inicializar quando o DOM estiver pronto
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// Service Worker b√°sico para PWA (opcional)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').then(
      (registration) => console.log('‚úÖ Service Worker registrado'),
      (err) => console.log('‚ùå Service Worker falhou:', err)
    ).catch(() => {
      // Ignora se n√£o houver service worker
    });
  });
}
</script>
</body>
</html>
