<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Registro de Consumo - √Ågua e Energia</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  :root {
    --primary: #667eea;
    --secondary: #764ba2;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg-light: #ffffff;
    --bg-dark: #1a1a2e;
    --text-light: #333333;
    --text-dark: #ffffff;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary)100%);
    min-height: 100vh;
    padding: 20px;
    position: relative;
    overflow-x: hidden;
    transition: all 0.3s;
  }

  body.dark-mode {
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
  }

  body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse"><path d="M 100 0 L 0 0 0 100" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
    pointer-events: none;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
  }

  h1 {
    color: white;
    font-size: clamp(24px, 5vw, 36px);
    font-weight: 700;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    animation: slideDown 0.6s ease-out;
  }

  .theme-toggle {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s;
  }

  .theme-toggle:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .main-tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 30px;
    animation: fadeIn 0.8s ease-out 0.2s both;
    flex-wrap: wrap;
  }

  .tab-button {
    flex: 1;
    min-width: 120px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.2);
    padding: 16px 20px;
    border-radius: 16px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .tab-button:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }

  .tab-button.active {
    background: white;
    color: var(--primary);
    border-color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .main-content {
    display: none;
  }

  .main-content.active {
    display: grid;
    gap: 20px;
    animation: scaleIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .form-card {
    background: white;
    padding: 30px;
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }

  body.dark-mode .form-card {
    background: #16213e;
    color: var(--text-dark);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 20px;
    border-radius: 16px;
    text-align: center;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
  }

  .stat-card .label {
    font-size: 14px;
    opacity: 0.9;
    margin-bottom: 8px;
  }

  .stat-card .value {
    font-size: 28px;
    font-weight: 700;
  }

  .stat-card.warning {
    background: linear-gradient(135deg, var(--warning) 0%, #f97316 100%);
  }

  .stat-card.success {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
  }

  .chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
    background: white;
    padding: 20px;
    border-radius: 16px;
  }

  body.dark-mode .chart-container {
    background: #0f3460;
  }

  .form-group {
    margin-bottom: 20px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    font-size: 14px;
  }

  body.dark-mode label {
    color: var(--text-dark);
  }

  input, select {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    font-size: 16px;
    transition: all 0.3s;
    background: #f8f9fa;
  }

  body.dark-mode input,
  body.dark-mode select {
    background: #0f3460;
    border-color: #1a1a2e;
    color: white;
  }

  input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    background: white;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  }

  body.dark-mode input:focus,
  body.dark-mode select:focus {
    background: #16213e;
  }

  input:read-only {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    cursor: not-allowed;
    font-weight: 600;
    color: var(--primary);
  }

  .button-group {
    display: grid;
    gap: 12px;
    margin-top: 24px;
  }

  button, .btn {
    padding: 16px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
  }

  .btn-secondary {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
  }

  body.dark-mode .btn-secondary {
    background: #0f3460;
    color: white;
  }

  .btn-secondary:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  .btn-danger {
    background: var(--danger);
    color: white;
  }

  .mensagem {
    text-align: center;
    font-weight: 600;
    margin-top: 16px;
    padding: 12px;
    border-radius: 8px;
    animation: fadeIn 0.3s;
  }

  .mensagem.success {
    background: #d4edda;
    color: #155724;
  }

  .mensagem.error {
    background: #f8d7da;
    color: #721c24;
  }

  .history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }

  .history-table th,
  .history-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
  }

  body.dark-mode .history-table th,
  body.dark-mode .history-table td {
    border-color: #1a1a2e;
  }

  .history-table th {
    background: #f8f9fa;
    font-weight: 600;
  }

  body.dark-mode .history-table th {
    background: #0f3460;
  }

  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    z-index: 1000;
    animation: slideInRight 0.3s;
    max-width: 300px;
  }

  .notification.warning {
    border-left: 4px solid var(--warning);
  }

  @keyframes slideInRight {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .goal-progress {
    margin: 20px 0;
  }

  .progress-bar {
    width: 100%;
    height: 30px;
    background: #e0e0e0;
    border-radius: 15px;
    overflow: hidden;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success) 0%, #059669 100%);
    transition: width 0.5s;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 14px;
  }

  .progress-fill.over {
    background: linear-gradient(90deg, var(--danger) 0%, #dc2626 100%);
  }

  .comparison-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  .comparison-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
  }

  body.dark-mode .comparison-card {
    background: #0f3460;
  }

  .comparison-card .icon {
    font-size: 40px;
    margin-bottom: 10px;
  }

  .comparison-card .value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
  }

  body.dark-mode .comparison-card .value {
    color: #64b5f6;
  }

  .export-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin: 20px 0;
  }

  @media (max-width: 768px) {
    body {
      padding: 12px;
    }

    .form-card {
      padding: 20px;
    }

    .main-tabs {
      gap: 8px;
    }

    .tab-button {
      padding: 12px;
      font-size: 14px;
      min-width: 100px;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .chart-container {
      height: 250px;
    }
  }

  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }

  .loading {
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üíß‚ö° Registro de Consumo</h1>
    <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
  </div>

  <div class="main-tabs">
    <button class="tab-button active" onclick="showMainTab('registro')">
      <span>üìù Registro</span>
    </button>
    <button class="tab-button" onclick="showMainTab('dashboard')">
      <span>üìä Dashboard</span>
    </button>
    <button class="tab-button" onclick="showMainTab('historico')">
      <span>üìã Hist√≥rico</span>
    </button>
    <button class="tab-button" onclick="showMainTab('metas')">
      <span>üéØ Metas</span>
    </button>
    <button class="tab-button" onclick="showMainTab('comparacao')">
      <span>üë• Compara√ß√£o</span>
    </button>
  </div>

  <!-- ABA REGISTRO -->
  <div id="registro" class="main-content active">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Total √Ågua</div>
        <div class="value" id="displayTotalAgua">0.00 m¬≥</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Energia</div>
        <div class="value" id="displayTotalEnergia">0.00 kWh</div>
      </div>
    </div>

    <div class="form-card">
      <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
        <button class="tab-button" style="flex: 1; min-width: 150px;" onclick="showFormTab('agua')">
          üíß √Ågua
        </button>
        <button class="tab-button" style="flex: 1; min-width: 150px;" onclick="showFormTab('energia')">
          ‚ö° Energia
        </button>
      </div>

      <div id="formAgua" class="form-content">
        <form id="aguaForm">
          <div class="form-group">
            <label>Nome</label>
            <input type="text" name="nome" required placeholder="Digite seu nome">
          </div>

          <div class="form-group">
            <label>Matr√≠cula</label>
            <input type="text" name="matricula" required placeholder="Digite sua matr√≠cula">
          </div>

          <div class="form-group">
            <label>Data e Hora</label>
            <input type="datetime-local" name="dataHora" required>
          </div>

          <div class="form-group">
            <label>Consumo de √Ågua (m¬≥)</label>
            <input type="number" name="consumoAgua" id="consumoAgua" step="0.01" required placeholder="0.00" oninput="atualizarTotal('agua')">
          </div>

          <div class="form-group">
            <label>Novo Total (m¬≥)</label>
            <input type="number" name="totalAgua" id="totalAgua" step="0.01" readonly>
          </div>

          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="definirInicio('agua')">
              üîÑ Redefinir Total Inicial
            </button>
          </div>

          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px dashed #e0e0e0;">
            <h3 style="margin-bottom: 16px;">üìù Campos Adicionais (Opcional)</h3>
            <div class="form-group">
              <label>Campo Extra 1</label>
              <input type="text" name="extra1" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label>Campo Extra 2</label>
              <input type="text" name="extra2" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label>Campo Extra 3</label>
              <input type="text" name="extra3" placeholder="Opcional">
            </div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-primary">‚úÖ Enviar Registro de √Ågua</button>
          </div>
          <p class="mensagem" id="msgAgua"></p>
        </form>
      </div>

      <div id="formEnergia" class="form-content" style="display: none;">
        <form id="energiaForm">
          <div class="form-group">
            <label>Nome</label>
            <input type="text" name="nome" required placeholder="Digite seu nome">
          </div>

          <div class="form-group">
            <label>Matr√≠cula</label>
            <input type="text" name="matricula" required placeholder="Digite sua matr√≠cula">
          </div>

          <div class="form-group">
            <label>Data e Hora</label>
            <input type="datetime-local" name="dataHora" required>
          </div>

          <div class="form-group">
            <label>Consumo de Energia (kWh)</label>
            <input type="number" name="consumoEnergia" id="consumoEnergia" step="0.01" required placeholder="0.00" oninput="atualizarTotal('energia')">
          </div>

          <div class="form-group">
            <label>Novo Total (kWh)</label>
            <input type="number" name="totalEnergia" id="totalEnergia" step="0.01" readonly>
          </div>

          <div class="button-group">
            <button type="button" class="btn btn-secondary" onclick="definirInicio('energia')">
              üîÑ Redefinir Total Inicial
            </button>
          </div>

          <div style="margin-top: 24px; padding-top: 24px; border-top: 2px dashed #e0e0e0;">
            <h3 style="margin-bottom: 16px;">üìù Campos Adicionais (Opcional)</h3>
            <div class="form-group">
              <label>Campo Extra 1</label>
              <input type="text" name="extra1" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label>Campo Extra 2</label>
              <input type="text" name="extra2" placeholder="Opcional">
            </div>

            <div class="form-group">
              <label>Campo Extra 3</label>
              <input type="text" name="extra3" placeholder="Opcional">
            </div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn btn-primary">‚úÖ Enviar Registro de Energia</button>
          </div>
          <p class="mensagem" id="msgEnergia"></p>
        </form>
      </div>
    </div>
  </div>

  <!-- ABA DASHBOARD -->
  <div id="dashboard" class="main-content">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="label">Consumo √Ågua (M√™s)</div>
        <div class="value" id="aguaMes">0.00 m¬≥</div>
      </div>
      <div class="stat-card">
        <div class="label">Consumo Energia (M√™s)</div>
        <div class="value" id="energiaMes">0.00 kWh</div>
      </div>
      <div class="stat-card success">
        <div class="label">Economia √Ågua</div>
        <div class="value" id="economiaAgua">0%</div>
      </div>
      <div class="stat-card warning">
        <div class="label">Custo Estimado</div>
        <div class="value" id="custoTotal">R$ 0,00</div>
      </div>
    </div>

    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üìà Gr√°fico de Consumo</h2>
      <div class="chart-container">
        <canvas id="consumptionChart"></canvas>
      </div>
    </div>

    <div class="form-card" style="margin-top: 20px;">
      <h2 style="margin-bottom: 20px;">üìä Distribui√ß√£o por Tipo</h2>
      <div class="chart-container" style="height: 250px;">
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ABA HIST√ìRICO -->
  <div id="historico" class="main-content">
    <div class="form-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2>üìã Hist√≥rico de Registros</h2>
        <div class="export-buttons" style="max-width: 400px;">
          <button class="btn btn-success" onclick="exportarCSV()">üì• CSV</button>
          <button class="btn btn-danger" onclick="exportarPDF()">üìÑ PDF</button>
        </div>
      </div>
      
      <div class="form-group">
        <label>Filtrar por Tipo</label>
        <select id="filtroTipo" onchange="filtrarHistorico()">
          <option value="todos">Todos</option>
          <option value="agua">√Ågua</option>
          <option value="energia">Energia</option>
        </select>
      </div>

      <div style="overflow-x: auto;">
        <table class="history-table">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Tipo</th>
              <th>Nome</th>
              <th>Consumo</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="historicoBody">
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px;">Nenhum registro encontrado</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ABA METAS -->
  <div id="metas" class="main-content">
    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üéØ Definir Metas de Consumo</h2>
      
      <div class="form-group">
        <label>Meta de √Ågua Mensal (m¬≥)</label>
        <input type="number" id="metaAgua" step="0.01" placeholder="Ex: 10.00" onchange="salvarMetas()">
      </div>

      <div class="form-group">
        <label>Meta de Energia Mensal (kWh)</label>
        <input type="number" id="metaEnergia" step="0.01" placeholder="Ex: 150.00" onchange="salvarMetas()">
      </div>

      <div class="goal-progress">
        <h3 style="margin-bottom: 10px;">Progresso - √Ågua</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressAgua" style="width: 0%;">0%</div>
        </div>
      </div>

      <div class="goal-progress">
        <h3 style="margin-bottom: 10px;">Progresso - Energia</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressEnergia" style="width: 0%;">0%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ABA COMPARA√á√ÉO -->
  <div id="comparacao" class="main-content">
    <div class="form-card">
      <h2 style="margin-bottom: 20px;">üë• Compara√ß√£o com M√©dia</h2>
      
      <div class="comparison-section">
        <div class="comparison-card">
          <div class="icon">üíß</div>
          <div class="label">Seu Consumo de √Ågua</div>
          <div class="value" id="compSeuAgua">0.00 m¬≥</div>
        </div>
        <div class="comparison-card">
          <div class="icon">üìä</div>
          <div class="label">M√©dia Geral</div>
          <div class="value" id="compMediaAgua">0.00 m¬≥</div>
        </div>
        <div class="comparison-card">
          <div class="icon">‚ö°</div>
          <div class="label">Sua Energia</div>
          <div class="value" id="compSeuEnergia">0.00 kWh</div>
        </div>
        <div class="comparison-card">
          <div class="icon">üìä</div>
          <div class="label">M√©dia Geral</div>
          <div class="value" id="compMediaEnergia">0.00 kWh</div>
        </div>
      </div>

      <div class="form-card" style="margin-top: 20px; background: #f8f9fa;">
        <h3 style="margin-bottom: 15px;">üí° An√°lise</h3>
        <p id="analiseTexto">Configure suas metas e registre consumos para ver a an√°lise comparativa.</p>
      </div>
    </div>
  </div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbyfpjvwFpYmruXMHYlOBu6_XY_I1U0qRRGapmXU8SgmyvVdNVK2iCJwp-fxn58ipx1U/exec";

let totalAnteriorAgua = 0;
let totalAnteriorEnergia = 0;
let historico = [];
let metas = { agua: 10, energia: 150 };
let chartInstance = null;
let pieChartInstance = null;

// TEMA ESCURO
function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const icon = document.querySelector('.theme-toggle');
  icon.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
}

// NAVEGA√á√ÉO ENTRE ABAS PRINCIPAIS
function showMainTab(tabId) {
  document.querySelectorAll('.main-content').forEach(div => div.classList.remove('active'));
  document.querySelectorAll('.main-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  event.target.closest('.tab-button').classList.add('active');
  
  if (tabId === 'dashboard') {
    setTimeout(criarGraficos, 100);
  } else if (tabId === 'historico') {
    carregarHistorico();
  } else if (tabId === 'metas') {
    atualizarProgressoMetas();
  } else if (tabId === 'comparacao') {
    atualizarComparacao();
  }
}

// NAVEGA√á√ÉO ENTRE FORMUL√ÅRIOS
function showFormTab(tipo) {
  document.querySelectorAll('.form-content').forEach(div => div.style.display = 'none');
  document.getElementById(`form${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).style.display = 'block';
  
  const buttons = document.querySelectorAll('.form-card > div:first-child .tab-button');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
}

// CARREGAR TOTAIS
async function carregarTotais() {
  try {
    const res = await fetch(`${scriptURL}?action=getLast`);
    const data = await res.json();
    totalAnteriorAgua = parseFloat(data.agua) || 0;
    totalAnteriorEnergia = parseFloat(data.energia) || 0;
    
    document.getElementById("totalAgua").value = totalAnteriorAgua.toFixed(2);
    document.getElementById("totalEnergia").value = totalAnteriorEnergia.toFixed(2);
    document.getElementById("displayTotalAgua").textContent = totalAnteriorAgua.toFixed(2) + " m¬≥";
    document.getElementById("displayTotalEnergia").textContent = totalAnteriorEnergia.toFixed(2) + " kWh";
    
    verificarAlertas();
  } catch (err) {
    console.log("Erro ao carregar totais:", err);
  }
}

// ATUALIZAR TOTAL
function atualizarTotal(tipo) {
  const consumo = parseFloat(document.getElementById(`consumo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value) || 0;
  const totalAnterior = tipo === 'agua' ? totalAnteriorAgua : totalAnteriorEnergia;
  const novoTotal = (consumo + totalAnterior).toFixed(2);
  document.getElementById(`total${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).value = novoTotal;
}

// DEFINIR IN√çCIO
function definirInicio(tipo) {
  const novoValor = prompt(`Digite o novo total inicial de ${tipo === 'agua' ? '√Ågua (m¬≥)' : 'Energia (kWh)'}:`);
  if (novoValor !== null && !isNaN(novoValor)) {
    if (tipo === 'agua') {
      totalAnteriorAgua = parseFloat(novoValor);
      document.getElementById("totalAgua").value = novoValor;
      document.getElementById("displayTotalAgua").textContent = parseFloat(novoValor).toFixed(2) + " m¬≥";
    } else {
      totalAnteriorEnergia = parseFloat(novoValor);
      document.getElementById("totalEnergia").value = novoValor;
      document.getElementById("displayTotalEnergia").textContent = parseFloat(novoValor).toFixed(2) + " kWh";
    }
  }
}

// MENSAGENS
function mostrarMensagem(elemento, texto, tipo) {
  elemento.textContent = texto;
  elemento.className = `mensagem ${tipo}`;
  setTimeout(() => {
    elemento.textContent = '';
    elemento.className = 'mensagem';
  }, 5000);
}

// NOTIFICA√á√ïES
function mostrarNotificacao(mensagem, tipo = 'warning') {
  const notif = document.createElement('div');
  notif.className = `notification ${tipo}`;
  notif.innerHTML = `<strong>‚ö†Ô∏è Alerta</strong><p>${mensagem}</p>`;
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideInRight 0.3s reverse';
    setTimeout(() => notif.remove(), 300);
  }, 5000);
}

// VERIFICAR ALERTAS
function verificarAlertas() {
  const metaAgua = parseFloat(localStorage.getItem('metaAgua')) || 10;
  const metaEnergia = parseFloat(localStorage.getItem('metaEnergia')) || 150;
  
  if (totalAnteriorAgua > metaAgua * 0.9) {
    mostrarNotificacao(`Voc√™ j√° consumiu ${((totalAnteriorAgua/metaAgua)*100).toFixed(0)}% da sua meta de √°gua!`);
  }
  
  if (totalAnteriorEnergia > metaEnergia * 0.9) {
    mostrarNotificacao(`Voc√™ j√° consumiu ${((totalAnteriorEnergia/metaEnergia)*100).toFixed(0)}% da sua meta de energia!`);
  }
}

// ENVIO FORMUL√ÅRIOS
document.getElementById('aguaForm').addEventListener('submit', e => {
  e.preventDefault();
  const form = e.target;
  const msg = document.getElementById('msgAgua');
  const btn = form.querySelector('button[type="submit"]');
  btn.classList.add('loading');
  btn.disabled = true;
  
  const formData = new FormData(form);
  
  fetch(scriptURL, { method: 'POST', body: formData })
    .then(() => {
      mostrarMensagem(msg, "‚úÖ Dados de √Ågua enviados com sucesso!", "success");
      
      // Adicionar ao hist√≥rico local
      historico.push({
        data: formData.get('dataHora'),
        tipo: '√°gua',
        nome: formData.get('nome'),
        consumo: formData.get('consumoAgua'),
        total: formData.get('totalAgua')
      });
      localStorage.setItem('historico', JSON.stringify(historico));
      
      form.reset();
      carregarTotais();
    })
    .catch(() => {
      mostrarMensagem(msg, "‚ùå Erro ao enviar dados. Tente novamente.", "error");
    })
    .finally(() => {
      btn.classList.remove('loading');
      btn.disabled = false;
    });
});

document.getElementById('energiaForm').addEventListener('submit', e => {
  e.preventDefault();
  const form = e.target;
  const msg = document.getElementById('msgEnergia');
  const btn = form.querySelector('button[type="submit"]');
  btn.classList.add('loading');
  btn.disabled = true;
  
  const formData = new FormData(form);
  
  fetch(scriptURL, { method: 'POST', body: formData })
    .then(() => {
      mostrarMensagem(msg, "‚úÖ Dados de Energia enviados com sucesso!", "success");
      
      // Adicionar ao hist√≥rico local
      historico.push({
        data: formData.get('dataHora'),
        tipo: 'energia',
        nome: formData.get('nome'),
        consumo: formData.get('consumoEnergia'),
        total: formData.get('totalEnergia')
      });
      localStorage.setItem('historico', JSON.stringify(historico));
      
      form.reset();
      carregarTotais();
    })
    .catch(() => {
      mostrarMensagem(msg, "‚ùå Erro ao enviar dados. Tente novamente.", "error");
    })
    .finally(() => {
      btn.classList.remove('loading');
      btn.disabled = false;
    });
});

// GR√ÅFICOS
function criarGraficos() {
  // Dados simulados para demonstra√ß√£o
  const labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'];
  const aguaData = historico.filter(h => h.tipo === '√°gua').slice(-6).map(h => parseFloat(h.consumo));
  const energiaData = historico.filter(h => h.tipo === 'energia').slice(-6).map(h => parseFloat(h.consumo));
  
  // Preencher com dados simulados se n√£o houver hist√≥rico
  while (aguaData.length < 6) aguaData.push(Math.random() * 5 + 2);
  while (energiaData.length < 6) energiaData.push(Math.random() * 50 + 100);
  
  // Gr√°fico de Linha
  const ctx = document.getElementById('consumptionChart');
  if (chartInstance) chartInstance.destroy();
  
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: '√Ågua (m¬≥)',
          data: aguaData,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          tension: 0.4
        },
        {
          label: 'Energia (kWh)',
          data: energiaData,
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245, 158, 11, 0.1)',
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
        }
      }
    }
  });
  
  // Gr√°fico de Pizza
  const ctxPie = document.getElementById('pieChart');
  if (pieChartInstance) pieChartInstance.destroy();
  
  const totalAgua = aguaData.reduce((a, b) => a + b, 0);
  const totalEnergia = energiaData.reduce((a, b) => a + b, 0);
  
  pieChartInstance = new Chart(ctxPie, {
    type: 'doughnut',
    data: {
      labels: ['√Ågua', 'Energia'],
      datasets: [{
        data: [totalAgua, totalEnergia],
        backgroundColor: ['#667eea', '#f59e0b']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
  
  // Atualizar estat√≠sticas
  document.getElementById('aguaMes').textContent = totalAgua.toFixed(2) + ' m¬≥';
  document.getElementById('energiaMes').textContent = totalEnergia.toFixed(2) + ' kWh';
  
  const economiaCalc = Math.max(0, 100 - (totalAgua / (metas.agua || 10)) * 100);
  document.getElementById('economiaAgua').textContent = economiaCalc.toFixed(0) + '%';
  
  const custoAgua = totalAgua * 5.5; // R$ por m¬≥
  const custoEnergia = totalEnergia * 0.85; // R$ por kWh
  document.getElementById('custoTotal').textContent = 'R$ ' + (custoAgua + custoEnergia).toFixed(2);
}

// HIST√ìRICO
function carregarHistorico() {
  const hist = JSON.parse(localStorage.getItem('historico') || '[]');
  historico = hist;
  filtrarHistorico();
}

function filtrarHistorico() {
  const filtro = document.getElementById('filtroTipo').value;
  const tbody = document.getElementById('historicoBody');
  
  let dadosFiltrados = historico;
  if (filtro !== 'todos') {
    dadosFiltrados = historico.filter(h => h.tipo === filtro);
  }
  
  if (dadosFiltrados.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Nenhum registro encontrado</td></tr>';
    return;
  }
  
  tbody.innerHTML = dadosFiltrados.map(item => `
    <tr>
      <td>${new Date(item.data).toLocaleString('pt-BR')}</td>
      <td>${item.tipo === '√°gua' ? 'üíß √Ågua' : '‚ö° Energia'}</td>
      <td>${item.nome}</td>
      <td>${parseFloat(item.consumo).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}</td>
      <td>${parseFloat(item.total).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}</td>
    </tr>
  `).join('');
}

// EXPORTAR CSV
function exportarCSV() {
  const csv = ['Data/Hora,Tipo,Nome,Consumo,Total'];
  historico.forEach(item => {
    csv.push(`${item.data},${item.tipo},${item.nome},${item.consumo},${item.total}`);
  });
  
  const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `historico_consumo_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}

// EXPORTAR PDF
function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  doc.setFontSize(18);
  doc.text('Hist√≥rico de Consumo', 14, 20);
  
  doc.setFontSize(10);
  let y = 35;
  
  historico.forEach((item, i) => {
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
    doc.text(`${i+1}. ${item.data} | ${item.tipo} | ${item.nome} | ${item.consumo}`, 14, y);
    y += 7;
  });
  
  doc.save(`historico_consumo_${new Date().toISOString().split('T')[0]}.pdf`);
}

// METAS
function salvarMetas() {
  const metaAgua = document.getElementById('metaAgua').value;
  const metaEnergia = document.getElementById('metaEnergia').value;
  
  if (metaAgua) {
    localStorage.setItem('metaAgua', metaAgua);
    metas.agua = parseFloat(metaAgua);
  }
  if (metaEnergia) {
    localStorage.setItem('metaEnergia', metaEnergia);
    metas.energia = parseFloat(metaEnergia);
  }
  
  atualizarProgressoMetas();
}

function atualizarProgressoMetas() {
  const metaAgua = parseFloat(localStorage.getItem('metaAgua')) || 10;
  const metaEnergia = parseFloat(localStorage.getItem('metaEnergia')) || 150;
  
  document.getElementById('metaAgua').value = metaAgua;
  document.getElementById('metaEnergia').value = metaEnergia;
  
  const progressAguaPct = Math.min(100, (totalAnteriorAgua / metaAgua) * 100);
  const progressEnergiaPct = Math.min(100, (totalAnteriorEnergia / metaEnergia) * 100);
  
  const progressAguaEl = document.getElementById('progressAgua');
  const progressEnergiaEl = document.getElementById('progressEnergia');
  
  progressAguaEl.style.width = progressAguaPct + '%';
  progressAguaEl.textContent = progressAguaPct.toFixed(0) + '%';
  progressAguaEl.className = progressAguaPct > 100 ? 'progress-fill over' : 'progress-fill';
  
  progressEnergiaEl.style.width = progressEnergiaPct + '%';
  progressEnergiaEl.textContent = progressEnergiaPct.toFixed(0) + '%';
  progressEnergiaEl.className = progressEnergiaPct > 100 ? 'progress-fill over' : 'progress-fill';
}

// COMPARA√á√ÉO
function atualizarComparacao() {
  // Calcular m√©dias (simulado - em produ√ß√£o viria do servidor)
  const mediaAgua = historico
    .filter(h => h.tipo === '√°gua')
    .reduce((acc, h) => acc + parseFloat(h.consumo), 0) / Math.max(1, historico.filter(h => h.tipo === '√°gua').length);
  
  const mediaEnergia = historico
    .filter(h => h.tipo === 'energia')
    .reduce((acc, h) => acc + parseFloat(h.consumo), 0) / Math.max(1, historico.filter(h => h.tipo === 'energia').length);
  
  // M√©dia geral simulada (em produ√ß√£o seria de todos os usu√°rios)
  const mediaGeralAgua = mediaAgua * 1.2 || 8.5;
  const mediaGeralEnergia = mediaEnergia * 1.15 || 120;
  
  document.getElementById('compSeuAgua').textContent = totalAnteriorAgua.toFixed(2) + ' m¬≥';
  document.getElementById('compMediaAgua').textContent = mediaGeralAgua.toFixed(2) + ' m¬≥';
  document.getElementById('compSeuEnergia').textContent = totalAnteriorEnergia.toFixed(2) + ' kWh';
  document.getElementById('compMediaEnergia').textContent = mediaGeralEnergia.toFixed(2) + ' kWh';
  
  // An√°lise
  let analise = '';
  if (totalAnteriorAgua < mediaGeralAgua) {
    analise += '‚úÖ Parab√©ns! Seu consumo de √°gua est√° abaixo da m√©dia. ';
  } else {
    analise += '‚ö†Ô∏è Seu consumo de √°gua est√° acima da m√©dia. Tente economizar! ';
  }
  
  if (totalAnteriorEnergia < mediaGeralEnergia) {
    analise += '‚úÖ Seu consumo de energia tamb√©m est√° √≥timo!';
  } else {
    analise += '‚ö†Ô∏è Seu consumo de energia pode melhorar.';
  }
  
  document.getElementById('analiseTexto').textContent = analise;
}

// INICIALIZA√á√ÉO
window.onload = function() {
  // Carregar tema
  const theme = localStorage.getItem('theme');
  if (theme === 'dark') {
    document.body.classList.add('dark-mode');
    document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
  }
  
  // Carregar dados
  carregarTotais();
  carregarHistorico();
  
  // Carregar metas
  const metaAgua = localStorage.getItem('metaAgua');
  const metaEnergia = localStorage.getItem('metaEnergia');
  if (metaAgua) {
    document.getElementById('metaAgua').value = metaAgua;
    metas.agua = parseFloat(metaAgua);
  }
  if (metaEnergia) {
    document.getElementById('metaEnergia').value = metaEnergia;
    metas.energia = parseFloat(metaEnergia);
  }
};// ... (c√≥digo anterior)

// EXPORTAR CSV
function exportarCSV() {
¬† const csv = ['Data/Hora,Tipo,Nome,Consumo,Total'];
¬† historico.forEach(item => {
¬† ¬† csv.push(`${new Date(item.data).toLocaleString('pt-BR')},${item.tipo},${item.nome},${parseFloat(item.consumo).toFixed(2)},${parseFloat(item.total).toFixed(2)}`);
¬† });
¬†¬†
¬† const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
¬† const link = document.createElement("a");
¬† link.href = URL.createObjectURL(blob);
¬† link.download = "historico_consumo.csv";
¬† document.body.appendChild(link);
¬† link.click();
¬† document.body.removeChild(link);
¬† mostrarNotificacao('Arquivo CSV exportado com sucesso!', 'success');
}

// EXPORTAR PDF
function exportarPDF() {
¬† const { jsPDF } = window.jspdf;
¬† const doc = new jsPDF();
¬†¬†
¬† doc.text("Registro de Consumo - √Ågua e Energia", 14, 20);
¬† doc.setFontSize(10);
¬† doc.text(`Total de Registros: ${historico.length}`, 14, 28);
¬† doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 34);

¬† const tableData = historico.map(item => [
¬† ¬† new Date(item.data).toLocaleString('pt-BR'),
¬† ¬† item.tipo.charAt(0).toUpperCase() + item.tipo.slice(1),
¬† ¬† item.nome,
¬† ¬† `${parseFloat(item.consumo).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}`,
¬† ¬† `${parseFloat(item.total).toFixed(2)} ${item.tipo === '√°gua' ? 'm¬≥' : 'kWh'}`,
¬† ]);

¬† doc.autoTable({
¬† ¬† head: [['Data/Hora', 'Tipo', 'Nome', 'Consumo', 'Total']],
¬† ¬† body: tableData,
¬† ¬† startY: 40,
¬† ¬† styles: { fontSize: 8, cellPadding: 2 },
¬† ¬† headStyles: { fillColor: [102, 126, 234] }
¬† });
¬†¬†
¬† doc.save("historico_consumo.pdf");
¬† mostrarNotificacao('Arquivo PDF exportado com sucesso!', 'success');
}

// GERENCIAMENTO DE METAS
function carregarMetas() {
¬† metas.agua = parseFloat(localStorage.getItem('metaAgua')) || 10;
¬† metas.energia = parseFloat(localStorage.getItem('metaEnergia')) || 150;
¬† document.getElementById('metaAgua').value = metas.agua;
¬† document.getElementById('metaEnergia').value = metas.energia;
}

function salvarMetas() {
¬† metas.agua = parseFloat(document.getElementById('metaAgua').value) || 0;
¬† metas.energia = parseFloat(document.getElementById('metaEnergia').value) || 0;
¬† localStorage.setItem('metaAgua', metas.agua);
¬† localStorage.setItem('metaEnergia', metas.energia);
¬† atualizarProgressoMetas();
}

function atualizarProgressoMetas() {
¬† carregarMetas(); // Garantir que as metas estejam atualizadas

¬† // Calcular consumo do m√™s (usando o hist√≥rico simulado/√∫ltimos 6)
¬† const aguaConsumoMes = historico.filter(h => h.tipo === '√°gua').slice(-6).map(h => parseFloat(h.consumo)).reduce((a, b) => a + b, 0);
¬† const energiaConsumoMes = historico.filter(h => h.tipo === 'energia').slice(-6).map(h => parseFloat(h.consumo)).reduce((a, b) => a + b, 0);

¬† // √Ågua
¬† const progressAgua = document.getElementById('progressAgua');
¬† let percentAgua = (aguaConsumoMes / metas.agua) * 100;
¬† if (metas.agua === 0) percentAgua = 0; // Evitar divis√£o por zero

¬† progressAgua.style.width = `${Math.min(100, percentAgua).toFixed(0)}%`;
¬† progressAgua.textContent = `${percentAgua.toFixed(1)}% (${aguaConsumoMes.toFixed(2)} / ${metas.agua.toFixed(2)} m¬≥)`;
¬† progressAgua.classList.toggle('over', percentAgua > 100);

¬† // Energia
¬† const progressEnergia = document.getElementById('progressEnergia');
¬† let percentEnergia = (energiaConsumoMes / metas.energia) * 100;
¬† if (metas.energia === 0) percentEnergia = 0; // Evitar divis√£o por zero

¬† progressEnergia.style.width = `${Math.min(100, percentEnergia).toFixed(0)}%`;
¬† progressEnergia.textContent = `${percentEnergia.toFixed(1)}% (${energiaConsumoMes.toFixed(2)} / ${metas.energia.toFixed(2)} kWh)`;
¬† progressEnergia.classList.toggle('over', percentEnergia > 100);
}

// COMPARA√á√ÉO
function atualizarComparacao() {
¬† carregarMetas(); // A m√©dia simulada ser√° baseada na meta
¬†¬†
¬† // Simular m√©dia geral como um valor pr√≥ximo √† meta
¬† const mediaAguaSimulada = metas.agua * 1.1; // 10% acima da meta
¬† const mediaEnergiaSimulada = metas.energia * 0.95; // 5% abaixo da meta

¬† // Calcular consumo do m√™s atual
¬† const aguaConsumoMes = historico.filter(h => h.tipo === '√°gua').slice(-6).map(h => parseFloat(h.consumo)).reduce((a, b) => a + b, 0);
¬† const energiaConsumoMes = historico.filter(h => h.tipo === 'energia').slice(-6).map(h => parseFloat(h.consumo)).reduce((a, b) => a + b, 0);

¬† // Atualizar cards
¬† document.getElementById('compSeuAgua').textContent = aguaConsumoMes.toFixed(2) + ' m¬≥';
¬† document.getElementById('compMediaAgua').textContent = mediaAguaSimulada.toFixed(2) + ' m¬≥';
¬† document.getElementById('compSeuEnergia').textContent = energiaConsumoMes.toFixed(2) + ' kWh';
¬† document.getElementById('compMediaEnergia').textContent = mediaEnergiaSimulada.toFixed(2) + ' kWh';

¬† // An√°lise
¬† let analise = '';
¬†¬†
¬† if (aguaConsumoMes < mediaAguaSimulada * 0.9) {
¬† ¬† analise += 'üíß Seu consumo de √°gua est√° excelente, bem abaixo da m√©dia. Continue assim! ';
¬† } else if (aguaConsumoMes > mediaAguaSimulada * 1.1) {
¬† ¬† analise += 'üíß Aten√ß√£o! Seu consumo de √°gua est√° significativamente acima da m√©dia. Considere medidas de economia. ';
¬† } else {
¬† ¬† analise += 'üíß Seu consumo de √°gua est√° pr√≥ximo da m√©dia geral. ';
¬† }
¬†¬†
¬† if (energiaConsumoMes < mediaEnergiaSimulada * 0.9) {
¬† ¬† analise += '‚ö° Seu consumo de energia √© um modelo! Muito abaixo da m√©dia. ';
¬† } else if (energiaConsumoMes > mediaEnergiaSimulada * 1.1) {
¬† ¬† analise += '‚ö° Seu consumo de energia est√° alto em rela√ß√£o √† m√©dia. Verifique aparelhos e h√°bitos. ';
¬† } else {
¬† ¬† analise += '‚ö° Seu consumo de energia est√° alinhado com a m√©dia geral. ';
¬† }
¬†¬†
¬† document.getElementById('analiseTexto').textContent = analise.trim() || "Nenhum registro encontrado para compara√ß√£o.";
}

// INICIALIZA√á√ÉO
function init() {
¬† // Carregar tema
¬† if (localStorage.getItem('theme') === 'dark') {
¬† ¬† document.body.classList.add('dark-mode');
¬† ¬† document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
¬† }
¬†¬†
¬† // Carregar hist√≥rico (e inicializar a vari√°vel global)
¬† carregarHistorico();
¬†¬†
¬† // Carregar totais (e preencher os inputs)
¬† carregarTotais();

¬† // Carregar metas e atualizar UI
¬† carregarMetas();
¬†¬†
¬† // Configurar aba inicial
¬† showFormTab('agua');

¬† // Adicionar listeners de input para atualizar o total ao digitar
¬† document.getElementById('consumoAgua').addEventListener('input', () => atualizarTotal('agua'));
¬† document.getElementById('consumoEnergia').addEventListener('input', () => atualizarTotal('energia'));
}

// Iniciar a aplica√ß√£o
window.onload = init;
</script>
</body>
</html>
